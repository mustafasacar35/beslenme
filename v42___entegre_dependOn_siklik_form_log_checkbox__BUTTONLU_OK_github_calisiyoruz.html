<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Beslenme Planlayıcı</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        :root{--primary-color:#007BFF;--primary-hover:#0056b3;--success-color:#28A745;--success-hover:#218838;--danger-color:#DC3545;--danger-hover:#C82333;--secondary-color:#6C757D;--secondary-hover:#5A6268;--background-color:#F8F9FA;--white:#FFFFFF;--gray-light:#E9ECEF;--gray-border:#DEE2E6;--text-dark:#212529;--text-light:#FFFFFF;--shadow:0 2px 4px rgba(0,0,0,0.1);--shadow-lg:0 4px 8px rgba(0,0,0,0.2);}
body{font-family:'Segoe UI',Arial,sans-serif;background-color:var(--background-color);margin:0;padding:0;overflow:hidden;}
.navbar{background-color:var(--primary-color)!important;padding:0.5rem 1rem;}
.navbar-brand,.nav-link{color:var(--text-light)!important;font-size:0.9rem;}
.nav-link:hover{color:#E7F1FF!important;}
.main-container{display:flex;height:calc(100vh - 56px);overflow:hidden;}
.sidebar{width:250px;height:100%;overflow-y:auto;background-color:var(--white);border-right:1px solid var(--gray-border);transition:width 0.3s;display:flex;flex-direction:column;}
.sidebar-header{padding:10px;border-bottom:1px solid var(--gray-border);}
.sidebar-content{flex:1;overflow-y:auto;padding:10px;}
.resizer{width:5px;background-color:var(--gray-border);cursor:ew-resize;}
.main-content{flex:1;height:100%;overflow-y:auto;background-color:var(--background-color);padding:10px;}
.accordion-button{background-color:var(--primary-color);color:var(--text-light);box-shadow:none;font-size:0.9rem;padding:0.5rem;}
.accordion-button.green{background-color:var(--success-color);}
.accordion-button.green:not(.collapsed){background-color:var(--success-hover);}
.accordion-button:not(.collapsed){background-color:var(--primary-hover);}
.accordion-button:hover{background-color:var(--primary-hover);}
.category-item{padding:5px;margin-bottom:3px;border-radius:4px;background-color:var(--white);border:1px solid var(--gray-border);font-size:0.85rem;display:flex;align-items:center;justify-content:space-between;}
.category-item:hover{background-color:var(--gray-light);}
.meal-card{margin-bottom:10px;box-shadow:var(--shadow);background-color:var(--white);cursor:pointer;}
.meal-card .card-header{background-color:var(--primary-color);color:var(--text-light);padding:0.5rem;font-size:0.9rem;display:flex;justify-content:space-between;align-items:center;}
.meal-table th:nth-child(2),.meal-table td:nth-child(2){min-width:120px;text-align:left;}
.macro-display{display:flex;align-items:stretch;margin-top:15px;background-color:var(--white);padding:10px;}
#macroTotals{flex:1;margin-right:20px;}
.macro-charts{display:flex;align-items:center;}
.chart-container{text-align:center;margin-right:20px;}
.chart-container:last-child{margin-right:0;}
.chart-container h4{margin-bottom:10px;font-size:14px;}
.chart-container canvas{display:block;}
.macro-table th{background-color:var(--gray-light);font-size:0.85rem;padding:0.3rem;}
.macro-exceed{background-color:#ffcccc;}
.macro-low{background-color:#cce5ff;}
.btn{font-size:0.85rem;padding:0.3rem 0.6rem;}
.btn-primary{background-color:var(--primary-color);border-color:var(--primary-color);}
.btn-primary:hover{background-color:var(--primary-hover);}
.btn-success{background-color:var(--success-color);border-color:var(--success-color);}
.btn-success:hover{background-color:var(--success-hover);}
.btn-danger{background-color:var(--danger-color);border-color:var(--danger-color);}
.btn-danger:hover{background-color:var(--danger-hover);}
.btn-secondary{background-color:var(--secondary-color);border-color:var(--secondary-color);}
.btn-secondary:hover{background-color:var(--secondary-hover);}
.btn-group{display:flex;gap:5px;}
.fixed-btn{position:sticky;top:10px;z-index:10;}
.fixed-btn-group{position:fixed;top:8px;left:20px;z-index:1000;background-color:var(--background-color);padding:3px;border-radius:5px;display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;box-shadow:var(--shadow);}
.fixed-buttons{position:fixed;bottom:10px;right:10px;z-index:1000;display:flex;gap:3px;background-color:var(--background-color);padding:5px;border-radius:5px;}
.form-control,.form-select{font-size:0.85rem;padding:0.3rem;}
.settings-panel{background-color:var(--background-color);padding:10px;border:1px solid var(--gray-border);margin-bottom:15px;}
.edit-food-panel{position:fixed;top:20%;left:50%;transform:translateX(-50%);width:300px;background-color:var(--white);border:1px solid var(--gray-border);padding:10px;z-index:1000;box-shadow:var(--shadow-lg);display:none;}
.nav-tabs .nav-link{color:var(--text-dark);background-color:var(--gray-light);font-size:0.85rem;padding:0.3rem 0.6rem;}
.nav-tabs .nav-link.active{color:var(--text-light);background-color:var(--primary-color);}
#notification{position:fixed;top:10px;right:10px;z-index:1000;}
.alert-success{background-color:var(--success-color);color:var(--text-light);padding:10px;border-radius:5px;}
.alert-warning{background-color:#FFC107;color:var(--text-dark);padding:10px;border-radius:5px;}
.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0;}
.meal-checkboxes,.food-checkboxes,.role-checkboxes{display:flex;flex-wrap:wrap;gap:5px;}
.role-checkboxes{font-size:0.8rem;}
.inline-accordion{display:inline-block;width:49%;margin-right:1%;}
.macro-modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);justify-content:center;align-items:center;}
.macro-modal-content{background-color:var(--white);padding:20px;border-radius:10px;position:relative;text-align:center;max-width:700px;width:90%;}
.macro-modal-close{position:absolute;top:10px;right:15px;font-size:24px;cursor:pointer;color:#333;}
.macro-modal-content h3{margin-bottom:20px;font-size:18px;}
.macro-modal-body{display:flex;align-items:flex-start;gap:20px;}
.macro-modal-chart{flex:0 0 300px;text-align:center;} /* Sabit genişlik: 300px */
#macroModalChart{width:300px;height:300px;display:block;}
.macro-modal-analysis{flex:1;background-color:#f9f9f9;padding:15px;border-radius:5px;font-size:14px;line-height:1.5;min-height:300px;overflow-y:auto;color:#333;}
.macro-modal-analysis h4{margin:0 0 10px 0;font-size:16px;color:#222;}
.macro-modal-analysis p{margin:5px 0;color:#333;}
.macro-modal-analysis .disclaimer{margin-top:15px;font-size:12px;font-style:italic;color:#666;}
.macro-tooltip{position:absolute;background-color:rgba(0,0,0,0.8);color:var(--text-light);padding:5px 10px;border-radius:5px;font-size:12px;pointer-events:none;z-index:1000;display:none;}
@media (max-width:768px){
    .sidebar{width:0;position:fixed;z-index:1000;height:100%;}
    .sidebar.active{width:200px;}
    .resizer{display:none;}
    .inline-accordion{display:block;width:100%;margin-right:0;}
    .fixed-btn-group{top:60px;right:5px;width:100%;justify-content:center;padding:5px;flex-direction:row;overflow-x:auto;white-space:nowrap;}
    .btn-group{flex-direction:row;}
    .macro-modal-content{max-width:90%;}
    .macro-modal-body{flex-direction:column;gap:10px;}
    .macro-modal-chart,.macro-modal-analysis{flex:none;width:100%;}
    .macro-modal-analysis{max-height:200px;}
}
        </style>
        
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Beslenme Planlayıcı</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Menüyü Aç/Kapa">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="toggleSidebar()" title="Menüyü Aç/Kapa"><i class="bi bi-list"></i> Menü</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchMode('user')" title="Kullanıcı Moduna Geç"><i class="bi bi-person"></i> Kullanıcı</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchMode('admin')" title="Yönetici Moduna Geç"><i class="bi bi-gear"></i> Yönetici</a>
                    </li>
                    <li class="nav-item" id="dietModeSelector">
                        <label for="dietModeSelect" class="visually-hidden">Diyet Modu Seç</label>
                        <select id="dietModeSelect" class="form-select" onchange="updateDietMode(this.value)">
                            <option value="keto">Keto</option>
                            <option value="lowcarb">Low-Carb</option>
                        </select>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h5>Kategoriler</h5>
                <div class="mb-2">
                    <div class="input-group">
                        <label for="searchFilterType" class="visually-hidden">Arama Filtresi</label>
                        <select id="searchFilterType" class="form-select" style="width: 30%;">
                            <option value="name">Yemek Adı</option>
                            <option value="tags">Etiket</option>
                            <option value="role">Rol</option>
                        </select>
                        <label for="searchFoodInput" class="visually-hidden">Yemek Ara</label>
                        <input type="text" class="form-control" id="searchFoodInput" placeholder="Yemek Ara..." onkeyup="searchFood(this.value)">
                    </div>
                </div>
                <button class="btn btn-success w-100 fixed-btn" onclick="addSelectedFoods()" title="Seçilen Yemekleri Öğüne Ekle"><i class="bi bi-plus-circle"></i> Öğüne Ekle</button>
            </div>
            <div class="sidebar-content" id="sidebar-content">
                <div id="patientPreferences" class="mb-2">
                    <div id="likedFoods" class="text-success"></div>
                    <div id="dislikedFoods" class="text-danger"></div>
                </div>
                <div id="categories" class="accordion mb-2"></div>
                
<button class="btn btn-primary w-100 mt-2" onclick="toggleAddFoodForm()" title="Yeni Yemek Ekle"><i class="bi bi-plus-circle"></i> Yeni Yemek Ekle</button>                
<div id="addFoodForm" class="mb-2" style="display: none;">
    <form id="addFoodFormInner" onsubmit="addNewFood(event)">
                        <div class="mb-1">
                            <label for="foodCategory" class="form-label">Kategori</label>
                            <select id="foodCategory" class="form-select" required>
                                <option value="">Kategori Seçin</option>
                            </select>
                        </div>
                        <div class="mb-1">
                            <label for="foodName" class="form-label">Yemek Adı</label>
                            <input type="text" id="foodName" class="form-control" placeholder="Yemek Adı" required autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodCalories" class="form-label">Kalori</label>
                            <input type="number" id="foodCalories" class="form-control" placeholder="Kalori" required min="0" step="0.1" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodProtein" class="form-label">Protein (g)</label>
                            <input type="number" id="foodProtein" class="form-control" placeholder="Protein (g)" required min="0" step="0.1" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodCarbs" class="form-label">Karb. (g)</label>
                            <input type="number" id="foodCarbs" class="form-control" placeholder="Karbonhidrat (g)" required min="0" step="0.1" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodFat" class="form-label">Yağ (g)</label>
                            <input type="number" id="foodFat" class="form-control" placeholder="Yağ (g)" required min="0" step="0.1" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodMaxQuantity" class="form-label">Maks. Katsayı</label>
                            <input type="number" id="foodMaxQuantity" class="form-control" placeholder="Maks. Katsayı" value="1" step="0.5" min="1" max="2" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodMinQuantity" class="form-label">Min. Katsayı</label>
                            <input type="number" id="foodMinQuantity" class="form-control" placeholder="Min. Katsayı" value="0.5" step="0.5" min="0" max="2" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodStep" class="form-label">Adım Değeri</label>
                            <input type="number" id="foodStep" class="form-control" placeholder="Adım (örn: 0.5)" value="0.5" step="0.1" min="0.1" max="1" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label for="foodTags" class="form-label">Etiketler</label>
                            <input type="text" id="foodTags" class="form-control" placeholder="Etiketler (virgülle ayırın)" autocomplete="off">
                        </div>
                        <div class="mb-1">
                            <label class="form-label">Diyet Türü</label>
                            <div>
                                <input type="checkbox" id="foodKeto" name="foodKeto"> <label for="foodKeto">Keto</label>
                                <input type="checkbox" id="foodLowCarb" name="foodLowCarb"> <label for="foodLowCarb">Low-Carb</label>
                            </div>
                        <div class="mb-1">
                            <label class="form-label">Dolgu Türü</label>
                            <div>
                                <input type="checkbox" id="foodFillerLunch" name="foodFillerLunch"> <label for="foodFillerLunch">Dolgu Öğlen</label>
                                <input type="checkbox" id="foodFillerDinner" name="foodFillerDinner"> <label for="foodFillerDinner">Dolgu Akşam</label>
                            </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-100" title="Yemeği Ekle">Ekle</button>
                        <button type="button" class="btn btn-secondary w-100 mt-1" onclick="toggleAddFoodForm()" title="İptal Et">İptal</button>
                    </form>
                </div>
                <div class="accordion mb-2 mt-2">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="rulesHeading">
                            <button class="accordion-button collapsed fixed-btn" type="button" data-bs-toggle="collapse" data-bs-target="#rulesCollapse" aria-expanded="false" aria-controls="rulesCollapse">
                                Kurallar
                            </button>
                        </h2>
                        <div id="rulesCollapse" class="accordion-collapse collapse" aria-labelledby="rulesHeading">
                            <div class="accordion-body">
                                <div id="rulesList" class="mb-2"></div>
                                <div id="editRuleForm" style="display: none;">
                                    <form onsubmit="saveEditedRule(event)">
                                        <input type="hidden" id="editRuleIndex">
                                        <div class="mb-2">
                                            <label for="editRuleType" class="form-label">Kural Türü</label>
                                            <select id="editRuleType" class="form-select" onchange="updateRuleForm(true)">
                                                <option value="frequency">Sıklık</option>
                                                <option value="exclude">Hariç Tut</option>
                                                <option value="include">Ekle</option>
                                                <option value="minCount">Min. Sayı</option>
                                                <option value="maxCount">Maks. Sayı</option>
                                                <option value="pairWith">Birlikte Ekle</option>
                                                <option value="avoidPair">Birlikte Ekleme</option>
                                                <option value="singleItem">Tek Başına</option>
                                            </select>
                                        </div>
                                        
  
                                        <div id="editRuleFormDetails">
                                            <div class="mb-2">
                                                <label>Kriterler:</label>
                                                <div>
                                                    <input type="checkbox" id="editRuleNameCheck"> <label for="editRuleNameCheck">İsim</label>
                                                    <input type="text" id="editRuleName" class="form-control" placeholder="örn: Balık">
                                                    <input type="checkbox" id="editRuleTagsCheck"> <label for="editRuleTagsCheck">Tag</label>
                                                    <input type="text" id="editRuleTags" class="form-control" placeholder="örn: balık, keto">
                                                    <input type="checkbox" id="editRuleCategoryCheck"> <label for="editRuleCategoryCheck">Kategori</label>
                                                    <select id="editRuleCategory" class="form-select">
                                                        <option value="KAHVALTI">KAHVALTI</option>
                                                        <option value="ÖĞLEN">ÖĞLEN</option>
                                                        <option value="AKŞAM">AKŞAM</option>
                                                        <option value="SALATALAR">SALATALAR</option>
                                                        <option value="ÇORBALAR">ÇORBALAR</option>
                                                        <option value="EKMEKLER">EKMEKLER</option>
                                                        <option value="TATLILAR">TATLILAR</option>
                                                        <option value="MEYVELER">MEYVELER</option>
                                                        <option value="KURUYEMİŞLER">KURUYEMİŞLER</option>
                                                    </select>
                                                    <input type="checkbox" id="editRuleMealTypeCheck"> <label for="editRuleMealTypeCheck">Öğün</label>
                                                    <select id="editRuleMealType" class="form-select">
                                                        <option value="breakfast">Kahvaltı</option>
                                                        <option value="lunch">Öğle</option>
                                                        <option value="dinner">Akşam</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="mb-2" id="editFrequencyInput" style="display: none;">
                                                <label for="editRuleFrequency" class="form-label">Haftada Kaç Kez</label>
                                                <input type="number" id="editRuleFrequency" class="form-control" min="0" max="21" value="1">
                                            </div>
                                            <div class="mb-2" id="editCountInput" style="display: none;">
                                                <label for="editRuleCount" class="form-label">Sayı</label>
                                                <input type="number" id="editRuleCount" class="form-control" min="1" value="1">
                                            </div>
                                            <div class="mb-2" id="editPairInput" style="display: none;">
                                                <label for="editRulePair" class="form-label">Eşleşecek Yemek</label>
                                                <input type="text" id="editRulePair" class="form-control" placeholder="örn: Salata">
                                            </div>
                                            <div class="mb-2">
                                                <label for="editRuleScope" class="form-label">Kapsam</label>
                                                <select id="editRuleScope" class="form-select">
                                                    <option value="daily">Günlük</option>
                                                    <option value="weekly">Haftalık</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label for="editRuleWeekRange" class="form-label">Hafta Aralığı (örn: 1-2)</label>
                                                <input type="text" id="editRuleWeekRange" class="form-control" placeholder="örn: 1-2 veya 3">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100" title="Kaydet">Kaydet</button>
                                        <button type="button" class="btn btn-secondary w-100 mt-1" onclick="cancelEditRule()" title="İptal">İptal</button>
                                    </form>
                                </div>
                                <div class="mb-2">
                                    <label for="ruleType" class="form-label">Kural Türü</label>
                                    <select id="ruleType" class="form-select" onchange="updateRuleForm()">
                                        <option value="frequency">Sıklık Kuralı</option>
                                        <option value="exclude">Hariç Tut</option>
                                        <option value="pairWith">Birlikte Olsun</option>
                                        <option value="avoidPair">Birlikte Olmasın</option>
                                        <option value="singleItem">Tek Başına</option>
                                        <option value="noDuplicates">Tekrarlama</option>
                                        <option value="dependOn">Bağımlı Olsun</option> <!-- Yeni eklenen -->
                                        <option value="categoryLock">Kategori Kilidi</option>
                                    </select>
                                </div>                             
                                <div id="ruleForm" class="mb-2">
                                    <!-- Genel Kriterler (Mevcut) -->
                                    <div id="defaultRuleForm">
                                        <div class="mb-2">
                                            <label>Kriterler:</label>
                                            <div>
                                                <input type="checkbox" id="ruleNameCheck"> <label for="ruleNameCheck">İsim</label>
                                                <input type="text" id="ruleName" class="form-control" placeholder="örn: Balık" disabled>
                                                <input type="checkbox" id="ruleTagsCheck"> <label for="ruleTagsCheck">Tag</label>
                                                <input type="text" id="ruleTags" class="form-control" placeholder="örn: balık, keto" disabled>
                                                <input type="checkbox" id="ruleCategoryCheck"> <label for="ruleCategoryCheck">Kategori</label>
                                                <select id="ruleCategory" class="form-select" disabled>
                                                    <option value="KAHVALTI">KAHVALTI</option>
                                                    <option value="ÖĞLEN">ÖĞLEN</option>
                                                    <option value="AKŞAM">AKŞAM</option>
                                                    <option value="SALATALAR">SALATALAR</option>
                                                    <option value="ÇORBALAR">ÇORBALAR</option>
                                                    <option value="EKMEKLER">EKMEKLER</option>
                                                    <option value="TATLILAR">TATLILAR</option>
                                                    <option value="MEYVELER">MEYVELER</option>
                                                    <option value="KURUYEMİŞLER">KURUYEMİŞLER</option>
                                                </select>
                                                <input type="checkbox" id="ruleMealTypeCheck"> <label for="ruleMealTypeCheck">Öğün</label>
                                                <select id="ruleMealType" class="form-select" disabled>
                                                    <option value="breakfast">Kahvaltı</option>
                                                    <option value="lunch">Öğle</option>
                                                    <option value="dinner">Akşam</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-2" id="frequencyInput" style="display: none;">
                                            <label for="ruleFrequency" class="form-label">Haftada Kaç Kez</label>
                                            <input type="number" id="ruleFrequency" class="form-control" min="0" max="21" value="1">
                                        </div>
                                        <div class="mb-2" id="countInput" style="display: none;">
                                            <label for="ruleCount" class="form-label">Sayı</label>
                                            <input type="number" id="ruleCount" class="form-control" min="1" value="1">
                                        </div>
                                        <div class="mb-2" id="pairInput" style="display: none;">
                                            <label for="rulePair" class="form-label">Eşleşecek Yemek</label>
                                            <input type="text" id="rulePair" class="form-control" placeholder="örn: Salata">
                                        </div>
                                        <div class="mb-2">
                                            <label for="ruleScope" class="form-label">Kapsam</label>
                                            <select id="ruleScope" class="form-select">
                                                <option value="daily">Günlük</option>
                                                <option value="weekly">Haftalık</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label for="ruleWeekRange" class="form-label">Hafta Aralığı (örn: 1-2, boş bırakılırsa her hafta)</label>
                                            <input type="text" id="ruleWeekRange" class="form-control" placeholder="örn: 1-2 veya 3">
                                        </div>
                                    </div>
                                
                                    <div id="frequencyRuleForm" style="display: none;">
                                        <h5>Sıklık Kuralı</h5>
                                        <div class="form-group mb-2">
                                            <label>Kriterler:</label><br>
                                            <input type="checkbox" id="freqNameCheck"> İsim: <input type="text" id="freqName" class="form-control" placeholder="örn: Balık" disabled><br>
                                            <input type="checkbox" id="freqTagCheck"> Tag: <input type="text" id="freqTag" class="form-control" placeholder="örn: balık, keto" disabled><br>
                                            <input type="checkbox" id="freqRoleCheck"> Rol: 
                                            <select id="freqRole" class="form-select" disabled>
                                                <option value="">Seç</option>
                                                <option value="mainDish">Ana Yemek</option>
                                                <option value="sideDish">Yan Yemek</option>
                                                <option value="soup">Çorba</option>
                                                <option value="dessert">Tatlı</option>
                                                <option value="drink">İçecek</option>
                                                <option value="fruit">Meyve</option>
                                                <option value="bread">Ekmek</option>
                                                <option value="snack">Atıştırmalık</option>
                                                <option value="supplement">Ek</option>
                                            </select><br>
                                            <input type="checkbox" id="freqCatCheck"> Kategori: 
                                            <select id="freqCat" class="form-select" disabled>
                                                <option value="">Seç</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Sıklık Türü:</label>
                                            <select id="freqType" class="form-select">
                                                <option value="exact">Net Sayı</option>
                                                <option value="min">En Az</option>
                                                <option value="max">En Fazla</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Sayı:</label>
                                            <input type="number" id="freqCount" class="form-control" min="1" value="1">
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Kapsam:</label>
                                            <select id="freqScope" class="form-select">
                                                <option value="meal">Öğün</option>
                                                <option value="day">Gün</option>
                                                <option value="week">Hafta</option>
                                            </select>
                                            <select id="freqMeal" class="form-select" style="display: none;">
                                                <option value="breakfast">Sabah</option>
                                                <option value="lunch">Öğle</option>
                                                <option value="dinner">Akşam</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Hafta Aralığı (örn: 1-2, boş bırakılırsa her hafta):</label>
                                            <input type="text" id="freqWeekRange" class="form-control" placeholder="örn: 1-2 veya 3">
                                        </div>
                                        <button type="button" onclick="handleRuleSave()" class="btn btn-success">Kuralı Kaydet</button>
                                    </div>
                            
                                    <div id="dependOnRuleForm" style="display: none;">
                                        <h5>Bağımlı Olsun Kuralı</h5>
                                        <div class="form-group mb-2">
                                            <label>Bağımlı Yemek:</label><br>
                                            <input type="text" id="dependOnFood" class="form-control" placeholder="örn: Mayonez">
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Bağımlı Olduğu Yemek:</label><br>
                                            <input type="text" id="dependOnRequiredFood" class="form-control" placeholder="örn: Köfte">
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Kapsam:</label>
                                            <select id="dependOnScope" class="form-select">
                                                <option value="meal">Öğün</option>
                                                <option value="day">Gün</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-success w-100" onclick="handleRuleSave()" title="Kuralı Kaydet">Kuralı Kaydet</button>
                                    </div>
                                    
                                    
                                    <div id="categoryLockRuleForm" style="display: none;">
                                        <h5>Kategori Kilidi Kuralı</h5>
                                        <div class="form-group mb-2">
                                            <label>Kilitlenecek Kategori:</label>
                                            <select id="categoryLockCategory" class="form-select">
                                                <option value="EKMEKLER">EKMEKLER</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Kapsam:</label>
                                            <select id="categoryLockScope" class="form-select">
                                                <option value="week">Hafta</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Yeni Birliktelik Kuralı Formu -->
                                    <div id="pairRuleForm" style="display: none;">
                                        <h5>Birliktelik Kuralı</h5>
                                        <div class="form-group mb-2">
                                            <label>Birinci Kelime:</label><br>
                                            <input type="checkbox" id="pair1NameCheck"> İsim: <input type="text" id="pair1Name" class="form-control" placeholder="örn: Balık" disabled><br>
                                            <input type="checkbox" id="pair1TagCheck"> Tag: <input type="text" id="pair1Tag" class="form-control" placeholder="örn: balık, keto" disabled><br>
                                            <input type="checkbox" id="pair1RoleCheck"> Rol: 
                                            <select id="pair1Role" class="form-select" disabled>
                                                <option value="">Seç</option>
                                                <option value="mainDish">Ana Yemek</option>
                                                <option value="sideDish">Yan Yemek</option>
                                                <option value="soup">Çorba</option>
                                                <option value="dessert">Tatlı</option>
                                            </select><br>
                                            <input type="checkbox" id="pair1CatCheck"> Kategori: 
                                            <select id="pair1Cat" class="form-select" disabled>
                                                <option value="">Seç</option>
                                                <option value="KAHVALTI">Kahvaltı</option>
                                                <option value="ÖĞLEN">Öğlen</option>
                                                <option value="AKŞAM">Akşam</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>İkinci Kelime:</label><br>
                                            <input type="checkbox" id="pair2NameCheck"> İsim: <input type="text" id="pair2Name" class="form-control" placeholder="örn: Salata" disabled><br>
                                            <input type="checkbox" id="pair2TagCheck"> Tag: <input type="text" id="pair2Tag" class="form-control" placeholder="örn: salata, keto" disabled><br>
                                            <input type="checkbox" id="pair2RoleCheck"> Rol: 
                                            <select id="pair2Role" class="form-select" disabled>
                                                <option value="">Seç</option>
                                                <option value="mainDish">Ana Yemek</option>
                                                <option value="sideDish">Yan Yemek</option>
                                                <option value="soup">Çorba</option>
                                                <option value="dessert">Tatlı</option>
                                            </select><br>
                                            <input type="checkbox" id="pair2CatCheck"> Kategori: 
                                            <select id="pair2Cat" class="form-select" disabled>
                                                <option value="">Seç</option>
                                                <option value="KAHVALTI">Kahvaltı</option>
                                                <option value="ÖĞLEN">Öğlen</option>
                                                <option value="AKŞAM">Akşam</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Birliktelik Türü:</label>
                                            <select id="pairType" class="form-select">
                                                <option value="together">Birlikte Olsun</option>
                                                <option value="apart">Birlikte Olmasın</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Bağlaç:</label>
                                            <select id="pairConjunction" class="form-select">
                                                <option value="or">Veya</option>
                                                <option value="and">Ve</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Yön:</label>
                                            <select id="pairDirection" class="form-select">
                                                <option value="bidirectional">Çift Yönlü</option>
                                                <option value="unidirectional">Tek Yönlü</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Kapsam:</label>
                                            <select id="pairScope" class="form-select">
                                                <option value="meal">Öğün</option>
                                                <option value="day">Gün</option>
                                                <option value="week">Hafta</option>
                                            </select>
                                            <select id="pairMeal" class="form-select" style="display: none;">
                                                <option value="breakfast">Sabah</option>
                                                <option value="lunch">Öğle</option>
                                                <option value="dinner">Akşam</option>
                                            </select>
                                        </div>
                                        <div class="form-group mb-2">
                                            <label>Hafta Aralığı (örn: 1-2, boş bırakılırsa her hafta):</label>
                                            <input type="text" id="pairWeekRange" class="form-control" placeholder="örn: 1-2 veya 3">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <label for="templateName" class="form-label">Şablon Adı</label>
                                    <input type="text" id="templateName" class="form-control" placeholder="Şablon Adı">
                                </div>
                                <button class="btn btn-success w-100 mb-1" onclick="saveRuleTemplate()" title="Şablon Kaydet">Şablon Kaydet</button>
                                <label for="templateSelect" class="form-label">Şablon Seç</label>
                                <select id="templateSelect" class="form-select mb-1">
                                    <option value="">Şablon Yükle</option>
                                </select>
                                <button class="btn btn-primary w-100 mb-1" onclick="loadRuleTemplate()" title="Şablon Yükle">Şablon Yükle</button>
                                <button class="btn btn-danger w-100" onclick="deleteRuleTemplate()" title="Şablon Sil">Şablon Sil</button>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="compatibilityHeading">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#compatibilityCollapse" aria-expanded="false" aria-controls="compatibilityCollapse">
                                Uyumluluk Kuralları
                            </button>
                        </h2>
                        <div id="compatibilityCollapse" class="accordion-collapse collapse" aria-labelledby="compatibilityHeading">
                            <div class="accordion-body" style="max-height: 300px; overflow-y: auto;">
                                <div id="compatibilityList" class="mb-2"></div>
                                <div class="mb-2">
                                    <label for="compatKeyword1" class="form-label">Kelime 1</label>
                                    <input type="text" id="compatKeyword1" class="form-control" placeholder="örn: balık">
                                </div>
                                <div class="mb-2">
                                    <label for="compatKeyword2" class="form-label">Kelime 2 (Virgülle ayırın)</label>
                                    <input type="text" id="compatKeyword2" class="form-control" placeholder="örn: süt,yoğurt">
                                </div>
                                <div class="mb-2">
                                    <label for="compatDegree" class="form-label">Derece (-5: Çok Uyumsuz, +5: Çok Uyumlu)</label>
                                    <input type="number" id="compatDegree" class="form-control" min="-5" max="5" value="0">
                                </div>
                                <div class="mb-2">
                                    <label for="compatConjunction" class="form-label">Bağlaç</label>
                                    <select id="compatConjunction" class="form-select">
                                        <option value="or">Veya</option>
                                        <option value="and">Ve</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary w-100" onclick="addCompatibilityRule()" title="Uyumluluk Ekle">Uyumluluk Ekle</button>
                                <button class="btn btn-primary w-100 mt-2" onclick="importFoodList()" title="Liste Al"><i class="bi bi-upload"></i> Liste Al</button>
                                <button class="btn btn-success w-100 mt-2" onclick="exportFoodList()" title="Son Listeyi Ver"><i class="bi bi-download"></i> Son Listeyi Ver</button> 
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="main-content" id="mainContent">
            <div id="notification" class="alert alert-success" style="display: none;"></div>
            <div class="main-content" id="mainContent">
                <div id="notification" class="alert alert-success" style="display: none;"></div>
                
                <!-- Tek bir adminPanel div'i -->
                <div id="adminPanel" class="p-3" style="display: block;">
                    <!-- Hasta Seçimi Bölümü -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <label for="patientSelect" class="visually-hidden">Hasta Seç</label>
                            <select id="patientSelect" class="form-select w-auto" onchange="handlePatientChange()">
                                <option value="">Hasta Seç</option>
                            </select>
                            <label for="likedFoodsDisplay" class="visually-hidden">Sevdiği Yemekler</label>
                            <input type="text" id="likedFoodsDisplay" class="form-control w-auto" placeholder="Sevdiği" onblur="updatePatientPreferences()">
                            <label for="dislikedFoodsDisplay" class="visually-hidden">Sevmediği Yemekler</label>
                            <input type="text" id="dislikedFoodsDisplay" class="form-control w-auto" placeholder="Sevmediği" onblur="updatePatientPreferences()">
                            <button class="btn btn-primary" onclick="addPatient()" title="Hasta Ekle"><i class="bi bi-person-plus"></i></button>
                            <button class="btn btn-warning" onclick="editPatient()" title="Hasta Düzenle"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger" onclick="deletePatient()" title="Hasta Sil"><i class="bi bi-trash"></i></button>
                        </div>
                    </div>
                    <div class="d-flex gap-2 mb-2">
                        <div class="accordion inline-accordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="settingsHeading">
                                    <button class="accordion-button green collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#settingsCollapse" aria-expanded="false" aria-controls="settingsCollapse">
                                        Ayarlar
                                    </button>
                                </h2>
                                <div id="settingsCollapse" class="accordion-collapse collapse" aria-labelledby="settingsHeading">
                                    <div class="accordion-body">
                                        <div class="settings-panel">
                                            <div class="row mb-2">
                                                <div class="col-6">
                                                    <label for="minItemsPerMeal" class="form-label">Min. Yemek/Öğün</label>
                                                    <input type="number" id="minItemsPerMeal" class="form-control" value="2" min="1" max="10">
                                                </div>
                                                <div class="col-6">
                                                    <label for="maxItemsPerMeal" class="form-label">Maks. Yemek/Öğün</label>
                                                    <input type="number" id="maxItemsPerMeal" class="form-control" value="4" min="1" max="10">
                                                </div>
                                            </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <label for="lunchCalorieRatio" class="form-label">Öğle Kalori (%)</label>
                                                <input type="number" id="lunchCalorieRatio" class="form-control" value="40" min="0" max="100">
                                            </div>
                                            <div class="col-6">
                                                <label for="dinnerCalorieRatio" class="form-label">Akşam Kalori (%)</label>
                                                <input type="number" id="dinnerCalorieRatio" class="form-control" value="50" min="0" max="100">
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-6">
                                                <label for="calorieFlexibility" class="form-label">Kalori Esneklik (±%)</label>
                                                <input type="number" id="calorieFlexibility" class="form-control" value="10" min="0" max="20">
                                            </div>
                                            <div class="col-6">
                                                <label for="varietyScore" class="form-label">Min. Çeşitlilik Skoru</label>
                                                <input type="number" id="varietyScore" class="form-control" value="0.7" min="0" max="1" step="0.1">
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-4">
                                                <label for="carbMultiplier" class="form-label">Karb Çarpanı</label>
                                                <input type="number" id="carbMultiplier" class="form-control" value="0.3" step="0.1" min="0" onchange="calculateMacros()">
                                            </div>
                                            <div class="col-4">
                                                <label for="proteinMultiplier" class="form-label">Prot. Çarpanı</label>
                                                <input type="number" id="proteinMultiplier" class="form-control" value="0.8" step="0.1" min="0" onchange="calculateMacros()">
                                            </div>
                                            <div class="col-4">
                                                <label for="fatMultiplier" class="form-label">Yağ Çarpanı</label>
                                                <input type="number" id="fatMultiplier" class="form-control" value="1.2" step="0.1" min="0" onchange="calculateMacros()">
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Ekleme Kriteri</label>
                                            <div>
                                                <input type="checkbox" id="useName" checked> <label for="useName">İsim</label>
                                                <input type="checkbox" id="useTags" checked> <label for="useTags">Etiket</label>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Öğün Tercihleri</label>
                                            <div class="mb-1">
                                                <strong>Kahvaltı:</strong>
                                                <input type="checkbox" id="prefBreakfastDrink" checked> <label for="prefBreakfastDrink">İçecek</label>
                                            </div>
                                            <div class="mb-1">
                                                <strong>Öğle:</strong>
                                                <input type="checkbox" id="prefLunchEgg" checked> <label for="prefLunchEgg">Yumurta</label>
                                                <input type="checkbox" id="prefLunchSoup" checked> <label for="prefLunchSoup">Çorba</label>
                                            </div>
                                            <div class="mb-1">
                                                <strong>Akşam Ekstraları:</strong>
                                                <div>
                                                    <label for="prefDinnerNuts">Kuruyemiş (%):</label>
                                                    <input type="number" id="prefDinnerNuts" class="form-control w-auto d-inline" value="50" min="0" max="100">
                                                </div>
                                                <div>
                                                    <label for="prefDinnerSoup">Çorba (%):</label>
                                                    <input type="number" id="prefDinnerSoup" class="form-control w-auto d-inline" value="50" min="0" max="100">
                                                </div>
                                                <div>
                                                    <label for="prefDinnerDessert">Tatlı (%):</label>
                                                    <input type="number" id="prefDinnerDessert" class="form-control w-auto d-inline" value="50" min="0" max="100">
                                                </div>
                                                <div>
                                                    <label for="prefDinnerFruit">Meyve (%):</label>
                                                    <input type="number" id="prefDinnerFruit" class="form-control w-auto d-inline" value="50" min="0" max="100">
                                                </div>
                                            </div>
                                        </div>
                                        





<!-- Kural açıklamasını göstermek için -->
<div id="ruleTextElement"></div>

<!-- Kural ekleme/düzenleme butonu -->
<button id="addRuleButton" onclick="handleRuleSave()">Kural Ekle</button>






<div class="settings-panel">
                                            <h6>Öğün Bazlı Limitler</h6>
                                            <div class="row mb-2">
                                                <div class="col-4">
                                                    <label for="breakfastMin" class="form-label">Kahvaltı Min</label>
                                                    <input type="number" id="breakfastMin" class="form-control" value="1" min="1" max="1">
                                                </div>
                                                <div class="col-4">
                                                    <label for="breakfastMax" class="form-label">Kahvaltı Max</label>
                                                    <input type="number" id="breakfastMax" class="form-control" value="1" min="1" max="1">
                                                </div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-4">
                                                    <label for="lunchMin" class="form-label">Öğle Min</label>
                                                    <input type="number" id="lunchMin" class="form-control" value="2" min="0">
                                                </div>




<div class="settings-panel">
    <h6>Öğün Bazlı Sabit Yemekler</h6>
    <div class="mb-2">
        <label for="fixedBreakfastMeal">Kahvaltı Sabit Yemek:</label>
        <select id="fixedBreakfastMeal" class="form-select">
            <option value="">Yok</option>
            <option value="Kurşun Geçirmez Kahve">Kurşun Geçirmez Kahve</option>
        </select>
    </div>
    <div class="mb-2">
        <label for="fixedLunchMeal">Öğle Sabit Yemek:</label>
        <select id="fixedLunchMeal" class="form-select">
            <option value="">Yok</option>
        </select>
    </div>
    <div class="mb-2">
        <label for="fixedDinnerMeal">Akşam Sabit Yemek:</label>
        <select id="fixedDinnerMeal" class="form-select">
            <option value="">Yok</option>
        </select>
    </div>
</div>















                                                <div class="col-4">
                                                    <label for="lunchMax" class="form-label">Öğle Max</label>
                                                    <input type="number" id="lunchMax" class="form-control" value="4" min="0">
                                                </div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-4">
                                                    <label for="dinnerMin" class="form-label">Akşam Min</label>
                                                    <input type="number" id="dinnerMin" class="form-control" value="2" min="0">
                                                </div>
                                                <div class="col-4">
                                                    <label for="dinnerMax" class="form-label">Akşam Max</label>
                                                    <input type="number" id="dinnerMax" class="form-control" value="4" min="0">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <label for="settingsTemplate" class="form-label">Ayar Şablonu Adı</label>
                                            <input type="text" id="settingsTemplate" class="form-control" placeholder="Şablon Adı">
                                        </div>
                                        <button class="btn btn-success w-100 mb-1" onclick="saveSettingsTemplate(true)" title="Ayarları Varsayılan Kaydet">Varsayılan Kaydet</button>
                                        <button class="btn btn-success w-100 mb-1" onclick="saveSettingsTemplate(false)" title="Ayarları Hasta İçin Kaydet">Hasta İçin Kaydet</button>
                                        <label for="settingsTemplateSelect" class="form-label">Ayar Şablonu Seç</label>
                                        <select id="settingsTemplateSelect" class="form-select mb-1">
                                            <option value="">Ayar Yükle</option>
                                        </select>
                                        <button class="btn btn-primary w-100" onclick="loadSettingsTemplate()" title="Ayarları Yükle">Yükle</button>
                                    



                                        <button class="btn btn-primary w-100 mt-2" onclick="applySettings()" title="Ayarları Uygula">Ayarları Uygula</button>
                                        
                                    </div>
                                    
                                </div>
                            </div>
                        </div>

                    </div>


<div id="mealPlanArea" class="meal-plan-container"></div>


                    <div id="autoPlanningCollapse" class="accordion-collapse collapse" aria-labelledby="autoPlanningHeading">
                        <div class="accordion-body">
                            <label>Makro Hedeflere Uyun (%): <input type="range" id="macroPriority" min="0" max="100" value="80"></label><br>
                            <label>Şablon Önceliği (%): <input type="range" id="templatePriority" min="0" max="100" value="60"></label><br>
                            <label>Kural Önceliği (%): <input type="range" id="rulePriority" min="0" max="100" value="90"></label><br>
                            <label>Uyumluluk Önceliği (%): <input type="range" id="compatibilityPriority" min="0" max="100" value="70"></label><br>
                            <label>Yönetim Önceliği (%): <input type="range" id="managementPriority" min="0" max="100" value="50"></label><br>
                            <label>Makro Toleransı (±%): <input type="range" id="macroTolerance" min="0" max="20" value="10"></label><br>
                            <label>Katsayıları Optimize Et: <input type="checkbox" id="optimizeCoefficients" checked></label><br>
                            <label>Kahvaltı Önceliği: 
                                <select id="breakfastPriority" class="form-select w-auto d-inline">
                                    <option value="high">Yüksek</option>
                                    <option value="medium" selected>Orta</option>
                                    <option value="low">Düşük</option>
                                </select>
                            </label><br>
                            <label>Öğle Önceliği: 
                                <select id="lunchPriority" class="form-select w-auto d-inline">
                                    <option value="high">Yüksek</option>
                                    <option value="medium" selected>Orta</option>
                                    <option value="low">Düşük</option>
                                </select>
                            </label><br>
                            <label>Akşam Önceliği: 
                                <select id="dinnerPriority" class="form-select w-auto d-inline">
                                    <option value="high">Yüksek</option>
                                    <option value="medium" selected>Orta</option>
                                    <option value="low">Düşük</option>
                                </select>
                            </label><br>
                            <button class="btn btn-primary w-100 mb-1" onclick="generateFastPlan()" title="Hızlı Planla"><i class="bi bi-lightning"></i> Hızlı Planla</button>
                            <button class="btn btn-success w-100 mb-1" onclick="applyAllRules()" title="Tüm Kuralları Uygula"><i class="bi bi-check2-all"></i> Tüm Kuralları Uygula</button>
                        </div>
                    </div>



                    <div class="accordion inline-accordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="templatesHeading">
                                <button class="accordion-button green collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#templatesCollapse" aria-expanded="false" aria-controls="templatesCollapse">
                                    Öğün Şablonları
                                </button>
                            </h2>
                            <div id="templatesCollapse" class="accordion-collapse collapse" aria-labelledby="templatesHeading">
                                <div class="accordion-body">
                                    <div id="mealTemplatesList" class="mb-2"></div>
                                    <div id="editTemplateForm" class="mb-2" style="display: none;">
                                        <form onsubmit="saveEditedTemplate(event)">
                                            <input type="hidden" id="editTemplateIndex">
                                            <div class="mb-2">
                                                <label for="editTemplateName" class="form-label">Şablon Adı</label>
                                                <input type="text" id="editTemplateName" class="form-control">
                                            </div>
                                            <div class="mb-2">
                                                <label for="editTemplateMealType" class="form-label">Öğün Türü</label>
                                                <select id="editTemplateMealType" class="form-select">
                                                    <option value="breakfast">Kahvaltı</option>
                                                    <option value="lunch">Öğle</option>
                                                    <option value="dinner">Akşam</option>
                                                </select>
                                            </div>
                                            <div class="mb-2">
                                                <label for="editTemplateFrequency" class="form-label">Haftada Kaç Gün</label>
                                                <input type="number" id="editTemplateFrequency" class="form-control" min="1" max="7">
                                            </div>
                                            <div id="editTemplateItems" class="mb-2"></div>
                                            <button type="submit" class="btn btn-success w-100" title="Kaydet">Kaydet</button>
                                            <button type="button" class="btn btn-secondary w-100 mt-1" onclick="cancelEditTemplate()" title="İptal">İptal</button>
                                        </form>
                                    </div>
                                    <div class="mb-2">
                                        <label for="templateMealType" class="form-label">Öğün Türü</label>
                                        <select id="templateMealType" class="form-select">
                                            <option value="breakfast">Kahvaltı</option>
                                            <option value="lunch">Öğle</option>
                                            <option value="dinner">Akşam</option>
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label for="templateFrequency" class="form-label">Haftada Kaç Gün</label>
                                        <input type="number" id="templateFrequency" class="form-control" value="1" min="1" max="7">
                                    </div>
                                    <div id="templateItems" class="mb-2">
                                        <div class="row mb-1">
                                            <div class="col-4">
                                                <label for="templateItem1Keyword" class="form-label">Etiket</label>
                                                <input type="text" id="templateItem1Keyword" class="form-control" placeholder="örn: yumurta, omlet">
                                            </div>
                                            <div class="col-4">
                                                <label for="templateItem1Role" class="form-label">Rol</label>
                                                <select id="templateItem1Role" class="form-select">
                                                    <option value="mainDish">Ana Yemek</option>
                                                    <option value="sideDish">Yan Yemek</option>
                                                    <option value="drink">İçecek</option>
                                                    <option value="soup">Çorba</option>
                                                    <option value="dessert">Tatlı</option>
                                                    <option value="fruit">Meyve</option>
                                                    <option value="bread">Ekmek</option>
                                                    <option value="snack">Atıştırmalık</option>
                                                    <option value="supplement">Ek</option>
                                                </select>
                                            </div>
                                            <div class="col-4">
                                                <label for="templateItem1Quantity" class="form-label">Sayı</label>
                                                <input type="number" id="templateItem1Quantity" class="form-control" value="1" min="1">
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100 mb-1" onclick="addTemplateItem()" title="Öğe Ekle"><i class="bi bi-plus-circle"></i> Öğe Ekle</button>
                                    <button class="btn btn-success w-100 mb-1" onclick="addMealTemplate()" title="Şablon Ekle">Şablon Ekle</button>
                                    <button class="btn btn-warning w-100" onclick="generateRandomTemplate()" title="Rastgele Şablon Oluştur">Rastgele Şablon</button>
<button class="btn btn-primary w-100 mt-1" onclick="exportTemplatesToTXT()" title="Şablonları TXT Olarak Dışa Aktar"><i class="bi bi-download"></i> Şablonları TXT Dışa Aktar</button>
<input type="file" id="importTemplatesFile" style="display:none" accept=".txt" onchange="importTemplatesFromTXT(event)">
<button class="btn btn-primary w-100 mt-1" onclick="document.getElementById('importTemplatesFile').click()" title="Şablonları TXT'dan Yükle"><i class="bi bi-upload"></i> Şablonları TXT'dan Yükle</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <ul class="nav nav-tabs mb-2" id="weekTabs"></ul>
                <ul class="nav nav-tabs mb-2" id="dayTabs"></ul>
                <div class="d-flex justify-content-between mb-2">
                    <div class="btn-group fixed-btn-group">
                        <button class="btn btn-primary me-1" onclick="addWeek()" title="Hafta Ekle"><i class="bi bi-plus-circle"></i> Hafta Ekle</button>
                        <button class="btn btn-danger me-1" onclick="deleteWeek()" title="Hafta Sil"><i class="bi bi-trash"></i> Hafta Sil</button>
                        <button class="btn btn-secondary" onclick="copyWeek()" title="Hafta Kopyala"><i class="bi bi-files"></i> Hafta Kopyala</button>
                        <button class="btn btn-primary me-1" id="fastPlanButton" onclick="generateFastPlan()" title="Hızlı Planla"><i class="bi bi-magic"></i> Hızlı Planla</button>
        
                        <button class="btn btn-primary me-1" onclick="exportAllData()" title="Tüm Verileri Dışa Aktar"><i class="bi bi-download"></i> Tüm Verileri Dışa Aktar</button>
                        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importAllData(event)">
                        <button class="btn btn-primary me-1" onclick="document.getElementById('importFile').click()" title="Tüm Verileri İçe Aktar"><i class="bi bi-upload"></i> Tüm Verileri İçe Aktar</button>
                        <button class="btn btn-primary me-1" onclick="exportToTXT()" title="TXT Olarak Dışa Aktar"><i class="bi bi-download"></i> TXT Dışa Aktar</button>
                        <input type="file" id="importTXTFile" style="display:none" accept=".txt" onchange="importFromTXT(event)">
                        <button class="btn btn-primary me-1" onclick="document.getElementById('importTXTFile').click()" title="TXT'dan Yemek Ekle"><i class="bi bi-upload"></i> TXT'dan Ekle</button>
                        <button class="btn btn-secondary" onclick="clearCache()" title="Cache Temizle"><i class="bi bi-trash"></i> Cache Temizle</button>
                        <button class="btn btn-primary" onclick="applyAllRules()" title="Tüm Kuralları Uygula"><i class="bi bi-check-circle"></i> Tüm Kuralları Uygula</button>
                    </div>
                </div>
                <div id="meals"></div>
                <div class="macro-display">
                   
                    
                     <table id="macroTotals"></table>
    <!-- Grafikler calculateMacros() tarafından buraya eklenecek -->
</div>
                    <div class="row mb-2">
                        <div class="col-3">
                            <label for="bmrDisplay" class="form-label">BMR</label>
                            <input type="number" id="bmrDisplay" class="form-control" readonly>
                        </div>
                        <div class="col-3">
                            <label for="targetCalories" class="form-label">Kalori</label>
                            <input type="number" id="targetCalories" class="form-control" readonly>
                        </div>
                        <div class="col-2">
                            <label for="targetProtein" class="form-label">Protein</label>
                            <input type="number" id="targetProtein" class="form-control" readonly>
                        </div>
                        <div class="col-2">
                            <label for="targetCarbs" class="form-label">Karb.</label>
                            <input type="number" id="targetCarbs" class="form-control" readonly>
                        </div>
                        <div class="col-2">
                            <label for="targetFat" class="form-label">Yağ</label>
                            <input type="number" id="targetFat" class="form-control" readonly>
                        </div>
                    </div>
                
                    <table class="table macro-table">
                        
                        <tbody id="macroTotals"></tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <div class="input-group">
                        <label for="editSearchFilterType" class="visually-hidden">Arama Filtresi</label>
                        <select id="editSearchFilterType" class="form-select" style="width: 30%;">
                            <option value="name">Yemek Adı</option>
                            <option value="tags">Etiket</option>
                            <option value="role">Rol</option>
                        </select>
                        <label for="editSearchFoodInput" class="visually-hidden">Yemek Ara</label>
                        <input type="text" class="form-control" id="editSearchFoodInput" placeholder="Yemek Ara..." onkeyup="searchEditFood(this.value)">
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="addNewCategory()" title="Yeni Kategori Ekle"><i class="bi bi-plus"></i> Yeni</button>
                            <button class="btn btn-warning" onclick="editSelectedCategory()" title="Seçilen Kategoriyi Düzenle"><i class="bi bi-pencil"></i> Düzenle</button>
                            <button class="btn btn-danger" onclick="deleteSelectedCategory()" title="Seçilen Kategoriyi Sil"><i class="bi bi-trash"></i> Sil</button>
                        </div>
                    </div>
                    <div id="editCategories" class="accordion"></div>
                </div>
            </div>

            <div id="userPanel" class="p-3" style="display: none;">
                <h5>Kullanıcı Profili</h5>
                <form id="userForm" onsubmit="handleUserFormSubmit(event)">
                    <div class="mb-2">
                        <label for="userName" class="form-label">İsim</label>
                        <input type="text" id="userName" class="form-control" required autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="userWeight" class="form-label">Kilo (kg)</label>
                        <input type="number" id="userWeight" class="form-control" required min="0" step="0.1" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="userActivity" class="form-label">Aktivite Seviyesi (1-5)</label>
                        <input type="number" id="userActivity" class="form-control" required min="1" max="5" step="1" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="likedFoodsInput" class="form-label">Sevdiği Yemekler (virgülle ayırın)</label>
                        <input type="text" id="likedFoodsInput" class="form-control" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="dislikedFoodsInput" class="form-label">Sevmediği Yemekler (virgülle ayırın)</label>
                        <input type="text" id="dislikedFoodsInput" class="form-control" autocomplete="off">
                    </div>
                    <button type="submit" class="btn btn-primary" title="Profil Kaydet">Kaydet</button>
                </form>
            </div>

            <div id="editFoodPanel" class="edit-food-panel">
                <h5>Yemek Düzenle</h5>
                <form onsubmit="saveEditedFood(event)">
                    <input type="hidden" id="editFoodIndex">
                    <input type="hidden" id="editFoodOriginalName">
                    <div class="mb-2">
                        <label for="editFoodName" class="form-label">Yemek Adı</label>
                        <input type="text" id="editFoodName" class="form-control" required autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="editFoodCalories" class="form-label">Kalori</label>
                        <input type="number" id="editFoodCalories" class="form-control" required min="0" step="0.1" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="editFoodProtein" class="form-label">Protein (g)</label>
                        <input type="number" id="editFoodProtein" class="form-control" required min="0" step="0.1" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="editFoodCarbs" class="form-label">Karb. (g)</label>
                        <input type="number" id="editFoodCarbs" class="form-control" required min="0" step="0.1" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="editFoodFat" class="form-label">Yağ (g)</label>
                        <input type="number" id="editFoodFat" class="form-control" required min="0" step="0.1" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="editFoodMaxQuantity" class="form-label">Maks. Katsayı</label>
                        <input type="number" id="editFoodMaxQuantity" class="form-control" value="1" step="0.5" min="1" max="2" autocomplete="off">
                    </div>
                    <div class="mb-1">
                        <label for="editFoodMinQuantity" class="form-label">Min. Katsayı</label>
                        <input type="number" id="editFoodMinQuantity" class="form-control" placeholder="Min. Katsayı" value="0.5" step="0.1" min="0" max="2" autocomplete="off">
                    </div>
                    <div class="mb-1">
                        <label for="editFoodStep" class="form-label">Adım Değeri</label>
                        <input type="number" id="editFoodStep" class="form-control" placeholder="Adım (örn: 0.5)" value="0.5" step="0.1" min="0" max="2" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="editFoodRole" class="form-label">Rol</label>
                        <select id="editFoodRole" class="form-select">
                            <option value="mainDish">Ana Yemek</option>
                            <option value="sideDish">Yan Yemek</option>
                            <option value="drink">İçecek</option>
                            <option value="soup">Çorba</option>
                            <option value="dessert">Tatlı</option>
                            <option value="fruit">Meyve</option>
                            <option value="bread">Ekmek</option>
                            <option value="snack">Atıştırmalık</option>
                            <option value="supplement">Ek</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="editFoodTags" class="form-label">Etiketler</label>
                        <input type="text" id="editFoodTags" class="form-control" placeholder="Etiketler (virgülle ayırın)" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label for="editFoodMealType" class="form-label">Öğün Türü</label>
                        <input type="text" id="editFoodMealType" class="form-control" placeholder="örn: breakfast,lunch" autocomplete="off">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Dolgu Türü</label>
                        <div>
                            <input type="checkbox" id="editFoodFillerLunch" name="editFoodFillerLunch"> <label for="editFoodFillerLunch">Dolgu Öğlen</label>
                            <input type="checkbox" id="editFoodFillerDinner" name="editFoodFillerDinner"> <label for="editFoodFillerDinner">Dolgu Akşam</label>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Diyet Türü</label>
                        <div>
                            <input type="checkbox" id="editFoodKeto" name="editFoodKeto"> <label for="editFoodKeto">Keto</label>
                            <input type="checkbox" id="editFoodLowCarb" name="editFoodLowCarb"> <label for="editFoodLowCarb">Low-Carb</label>
                        </div>
                    </div>
                    <!-- Tek Kategori Seçimi -->
                    <div class="mb-2">
                        <label for="editFoodMoveToCategory" class="form-label">Kategoriye Taşı</label>
                        <select id="editFoodMoveToCategory" class="form-select">
                            <option value="">Kategori Seç</option>
                        </select>
                        <button type="button" class="btn btn-primary mt-2" onclick="moveFoodCategory()">Taşı</button>
                    </div>
                    <button type="submit" class="btn btn-success w-100" title="Kaydet">Kaydet</button>
                    <button type="button" class="btn btn-secondary w-100 mt-1" onclick="closeEditFoodPanel()" title="İptal">İptal</button>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

const roleOrder = {
    "Soup": 1,
    "MainDish": 2,
    "SideDish": 3,
    "Bread": 4,
    "Dessert": 5,
    "Fruit": 6,
    "Snack": 7,
    "Drink": 8,
    "Supplement": 9,
    "Bilinmiyor": 10
};



document.addEventListener('DOMContentLoaded', () => {
    // Checkbox'lar için başlangıç durumu
    toggleInput('freqNameCheck', 'freqName');
    toggleInput('freqTagCheck', 'freqTag');
    toggleInput('freqRoleCheck', 'freqRole');
    toggleInput('freqCatCheck', 'freqCat');

    // freqScope değiştiğinde freqMeal görünürlüğünü güncelle
    const freqScope = document.getElementById('freqScope');
    const freqMeal = document.getElementById('freqMeal');
    freqScope.addEventListener('change', () => {
        freqMeal.style.display = freqScope.value === 'meal' ? 'inline-block' : 'none';
    });
    freqMeal.style.display = freqScope.value === 'meal' ? 'inline-block' : 'none';
});




        document.addEventListener("DOMContentLoaded", function() {
            if (initialCategories && initialCategories.length > 0) {
        categories = initialCategories;
    }

    document.querySelectorAll("select[id^='editMoveToCategory']").forEach(function(categorySelect) {
        categorySelect.innerHTML = '';
        const defaultOption = document.createElement("option");
defaultOption.value = "";
defaultOption.textContent = "Kategori Seç";
categorySelect.appendChild(defaultOption);
        categories.forEach(function(cat, index) {
            const option = document.createElement("option");
            option.value = cat.name;
            option.textContent = cat.name;
            if (index === 0) option.selected = true;
            categorySelect.appendChild(option);
        });
    });
        
    // BU KODU BURAYA EKLE:
    if (initialCategories && initialCategories.length > 0) {
        categories = initialCategories;
    }
// Tüm kategori dropdownlarını doldur (birden fazla olabilir)
document.querySelectorAll("select[id^='editMoveToCategory']").forEach(categorySelect => {
    categorySelect.innerHTML = '<option value="">Kategori Seç</option>';
    categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat.name;
        option.textContent = cat.name;
        categorySelect.appendChild(option);
    });
});

    const categorySelect = document.getElementById("editMoveToCategory");
    if (categorySelect && categories.length > 0) {
        categorySelect.innerHTML = '<option value="">Kategori Seç</option>';
        categories.forEach(cat => {
            const option = document.createElement("option");
            option.value = cat.name;
            option.textContent = cat.name;
            categorySelect.appendChild(option);
        });
    }




    searchEditFood('');
});

let categories = [];
const initialCategories = [
    {
        name: "KAHVALTI",
        items: [
            { name: "Kurşun Geçirmez Kahve", calories: 200, protein: 0, carbs: 0, fat: 22, maxQuantity: 1, minQuantity: 1, tags: ["keto", "içecek"], role: "drink", mealType: "breakfast", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false }
        ]
    },
    {
        name: "ÖĞLEN",
        items: [
            { name: "Yumurtalı Ispanak Kavurma", calories: 337, protein: 23, carbs: 3, fat: 26, maxQuantity: 1.5, minQuantity: 0.5, tags: ["keto", "yumurta"], role: "mainDish", mealType: "lunch", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false },
            { name: "Keto Tost", calories: 250, protein: 15, carbs: 5, fat: 18, maxQuantity: 1, minQuantity: 0.5, tags: ["keto", "ekmek"], role: "mainDish", mealType: "lunch", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false },
            { name: "Sabah Yeşillikleri", calories: 50, protein: 2, carbs: 5, fat: 3, maxQuantity: 2, minQuantity: 0.5, tags: ["keto", "salata"], role: "sideDish", mealType: "lunch", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false }
        ]
    },
    {
        name: "AKŞAM",
        items: [
            { name: "Köfte", calories: 250, protein: 20, carbs: 0, fat: 18, maxQuantity: 2, minQuantity: 1, tags: ["keto", "et"], role: "mainDish", mealType: "dinner", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false },
            { name: "Tavuk Çorbası", calories: 114, protein: 10, carbs: 5, fat: 6, maxQuantity: 1, minQuantity: 0.5, tags: ["keto", "çorba"], role: "soup", mealType: "dinner", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false }
        ]
    },
    {
        name: "DİĞER",
        items: [
            { name: "Zeytinyağı", calories: 120, protein: 0, carbs: 0, fat: 14, maxQuantity: 2, minQuantity: 0.5, tags: ["keto", "yağ"], role: "supplement", mealType: "lunch,dinner", keto: true, lowcarb: true, fillerLunch: true, fillerDinner: true },
            { name: "Keten Tohumu", calories: 44, protein: 2, carbs: 0, fat: 4, maxQuantity: 1, minQuantity: 0.5, tags: ["keto", "tohum"], role: "supplement", mealType: "lunch,dinner", keto: true, lowcarb: true, fillerLunch: true, fillerDinner: true },
            { name: "Kollajen", calories: 40, protein: 10, carbs: 0, fat: 0, maxQuantity: 1, minQuantity: 0.5, tags: ["keto", "ek"], role: "supplement", mealType: "lunch,dinner", keto: true, lowcarb: true, fillerLunch: true, fillerDinner: true }
        ]
    },
    {
        name: "KURUYEMİŞLER",
        items: [
            { name: "Badem", calories: 160, protein: 6, carbs: 6, fat: 14, maxQuantity: 1, minQuantity: 0.5, tags: ["keto", "kuruyemiş"], role: "snack", mealType: "lunch,dinner", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false }
        ]
    },
    {
        name: "TATLILAR",
        items: [
            { name: "Bitter Çikolata", calories: 150, protein: 2, carbs: 8, fat: 12, maxQuantity: 1, minQuantity: 0.5, tags: ["keto", "tatlı"], role: "dessert", mealType: "lunch,dinner", keto: true, lowcarb: true, fillerLunch: false, fillerDinner: false }
        ]
    }
];
categories = initialCategories;
        let weeks = [];
        let selectedWeek = 1;
        let selectedDay = "monday";
        let currentPatient = null;
        let dietMode = "keto";
        let rules = [];
        rules.push({ type: 'maxRoleCount', mealType: 'lunch', role: 'mainDish', count: 1 });
rules.push({ type: 'maxRoleCount', mealType: 'dinner', role: 'mainDish', count: 1 });
rules.push({ type: 'maxRoleCount', mealType: 'lunch', role: 'soup', count: 1 });
rules.push({ type: 'maxRoleCount', mealType: 'dinner', role: 'soup', count: 1 });
        let mealTemplates = [];
        let compatibilityTable = [];

        const days = ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"];
        const roles = [
            { role: "mainDish", active: true },
            { role: "sideDish", active: true },
            { role: "drink", active: true },
            { role: "soup", active: false },
            { role: "dessert", active: false },
            { role: "fruit", active: false },
            { role: "bread", active: false },
            { role: "snack", active: false },
            { role: "supplement", active: false }
        ];

        function initializeWeeks() {
            if (weeks.length === 0) {
                weeks.push({
                    days: {
                        monday: { meals: { breakfast: [], lunch: [], dinner: [] } },
                        tuesday: { meals: { breakfast: [], lunch: [], dinner: [] } },
                        wednesday: { meals: { breakfast: [], lunch: [], dinner: [] } },
                        thursday: { meals: { breakfast: [], lunch: [], dinner: [] } },
                        friday: { meals: { breakfast: [], lunch: [], dinner: [] } },
                        saturday: { meals: { breakfast: [], lunch: [], dinner: [] } },
                        sunday: { meals: { breakfast: [], lunch: [], dinner: [] } }
                    }
                });
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function switchMode(mode) {
    document.getElementById('adminPanel').style.display = mode === 'admin' ? 'block' : 'none';
    document.getElementById('userPanel').style.display = mode === 'user' ? 'block' : 'none';
}

function updateDietMode(mode) {
    dietMode = mode;
    const carbMultiplier = mode === 'keto' ? 0.3 : 0.6;
    const proteinMultiplier = 0.8;
    const fatMultiplier = mode === 'keto' ? 1.2 : 1.0;
    document.getElementById('carbMultiplier').value = carbMultiplier;
    document.getElementById('proteinMultiplier').value = proteinMultiplier;
    document.getElementById('fatMultiplier').value = fatMultiplier;
    loadCategories();
    renderMeals();
    calculateMacros();
    showNotification(`Diyet modu ${mode} olarak güncellendi!`);
}

function loadCategories() {
    // 1. Kategori seçim dropdown’unu güncelle
    const categorySelect = document.getElementById('foodCategory');
    categorySelect.innerHTML = '<option value="">Kategori Seçin</option>' + 
        categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');

    // 2. Sidebar’daki akordiyon menüyü güncelle (filtresiz)
    const sidebarCategories = document.getElementById('categories');
    if (sidebarCategories) {
        sidebarCategories.innerHTML = categories.map((category, index) => `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${index}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                        ${category.name} (${category.items.length})
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}">
                    <div class="accordion-body">
                        ${category.items.map(item => `
                            <div class="category-item">
                                <span>${item.name} (${item.calories} kcal)</span>
                                <div class="food-checkboxes">
                                    <input type="checkbox" class="meal-checkbox" data-name="${item.name}" data-meal="breakfast" title="Sabah"> S
                                    <input type="checkbox" class="meal-checkbox" data-name="${item.name}" data-meal="lunch" title="Öğle"> Ö
                                    <input type="checkbox" class="meal-checkbox" data-name="${item.name}" data-meal="dinner" title="Akşam"> A
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `).join('');
        console.log("Sidebar güncellendi:", sidebarCategories.innerHTML); // Kontrol için
    } else {
        console.error("Sidebar'daki 'categories' elemanı bulunamadı!");
    }

    // 3. Sağ paneli güncelle
    searchEditFood('');
    // searchFood('') çağrısını kaldırdık, sadece kullanıcı arama yaptığında çalışsın
}

        function searchFood(query) {
            const filterType = document.getElementById('searchFilterType').value;
            const sidebarContent = document.getElementById('categories');
            const patientData = currentPatient ? JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}') : {};
            const likedFoods = patientData.likedFoods || [];
            const dislikedFoods = patientData.dislikedFoods || [];

            sidebarContent.innerHTML = categories.map((category, index) => {
                let filteredItems = category.items.filter(item => {
                    const matchesDiet = dietMode === 'keto' ? item.keto : item.lowcarb;
                    const notDisliked = !dislikedFoods.some(df => item.name.toLowerCase().includes(df.toLowerCase()) || item.tags.some(t => t.toLowerCase().includes(df.toLowerCase())));
                    if (filterType === 'name') return matchesDiet && notDisliked && item.name.toLowerCase().includes(query.toLowerCase());
                    if (filterType === 'tags') return matchesDiet && notDisliked && item.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()));
                    if (filterType === 'role') return matchesDiet && notDisliked && item.role.toLowerCase().includes(query.toLowerCase());
                    return matchesDiet && notDisliked;
                });

                filteredItems.sort((a, b) => {
                    const aLiked = likedFoods.some(lf => a.name.toLowerCase().includes(lf.toLowerCase()) || a.tags.some(t => t.toLowerCase().includes(lf.toLowerCase())));
                    const bLiked = likedFoods.some(lf => b.name.toLowerCase().includes(lf.toLowerCase()) || b.tags.some(t => t.toLowerCase().includes(lf.toLowerCase())));
                    return bLiked - aLiked;
                });

                return `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
    ${category.name} (${filteredItems.length})
</button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}">
                            <div class="accordion-body">
                                ${filteredItems.map(item => `
                                    <div class="category-item">
                                        <span>${item.name} (${item.calories} kcal)</span>
                                        <div class="food-checkboxes">
                                            <input type="checkbox" class="meal-checkbox" data-name="${item.name}" data-meal="breakfast" title="Sabah"> S
                                            <input type="checkbox" class="meal-checkbox" data-name="${item.name}" data-meal="lunch" title="Öğle"> Ö
                                            <input type="checkbox" class="meal-checkbox" data-name="${item.name}" data-meal="dinner" title="Akşam"> A
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addNewCategory() {
    const categoryName = prompt("Yeni kategori adını girin:");
    if (categoryName && !categories.some(cat => cat.name === categoryName)) {
        categories.push({ name: categoryName, items: [] });
        loadCategories();
        showNotification("Yeni kategori eklendi!");
    } else if (categories.some(cat => cat.name === categoryName)) {
        showNotification("Bu kategori zaten var!", "warning");
    }
}

function editSelectedCategory() {
    const selectedCheckbox = document.querySelector('.category-checkbox:checked');
    if (!selectedCheckbox) {
        showNotification("Lütfen bir kategori seçin!", "warning");
        return;
    }
    const index = parseInt(selectedCheckbox.getAttribute('data-category-index'));
    const oldName = categories[index].name;
    const newName = prompt("Yeni kategori adını girin:", oldName);
    if (newName && newName !== oldName && !categories.some(cat => cat.name === newName)) {
        categories[index].name = newName;
        loadCategories();
        showNotification("Kategori güncellendi!");
    } else if (categories.some(cat => cat.name === newName)) {
        showNotification("Bu kategori zaten var!", "warning");
    }
}

function deleteSelectedCategory() {
    const selectedCheckbox = document.querySelector('.category-checkbox:checked');
    if (!selectedCheckbox) {
        showNotification("Lütfen bir kategori seçin!", "warning");
        return;
    }
    const index = parseInt(selectedCheckbox.getAttribute('data-category-index'));
    if (confirm(`${categories[index].name} kategorisini silmek istediğinize emin misiniz?`)) {
        categories.splice(index, 1);
        loadCategories();
        showNotification("Kategori silindi!");
    }
}

        function addSelectedFoods() {
    const checkboxes = document.querySelectorAll('.meal-checkbox:checked');
    if (checkboxes.length === 0) {
        showNotification("Lütfen en az bir öğün seçin!", "warning");
        return;
    }
    checkboxes.forEach(checkbox => {
        const foodName = checkbox.getAttribute('data-name');
        const mealType = checkbox.getAttribute('data-meal');
        weeks[selectedWeek - 1].days[selectedDay].meals[mealType].push({ name: foodName, quantity: 1 });
        checkbox.checked = false;
    });
    renderMeals();
    calculateMacros();
    toggleSidebar();
    showNotification("Yemekler eklendi!");
}

        function toggleAddFoodForm() {
            const form = document.getElementById('addFoodForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function addNewFood(event) {
    event.preventDefault();
    const categoryName = document.getElementById('foodCategory').value;
    const name = document.getElementById('foodName').value;
    const calories = parseFloat(document.getElementById('foodCalories').value);
    const protein = parseFloat(document.getElementById('foodProtein').value);
    const carbs = parseFloat(document.getElementById('foodCarbs').value);
    const fat = parseFloat(document.getElementById('foodFat').value);
    const maxQuantity = parseFloat(document.getElementById('foodMaxQuantity').value);
    const minQuantity = parseFloat(document.getElementById('foodMinQuantity').value);
    const tags = document.getElementById('foodTags').value.split(',').map(t => t.trim()).filter(t => t);
    const keto = document.getElementById('foodKeto').checked;
    const lowcarb = document.getElementById('foodLowCarb').checked;
    const fillerLunch = document.getElementById('foodFillerLunch').checked;
    const fillerDinner = document.getElementById('foodFillerDinner').checked;
    const step = parseFloat(document.getElementById('foodStep').value) || 0.5;

    const category = categories.find(cat => cat.name === categoryName);
    if (category) {
        category.items.push({
            name,
            calories,
            protein,
            carbs,
            fat,
            maxQuantity,
            minQuantity,
            tags,
            role: "mainDish",
            mealType: "breakfast,lunch,dinner", // String olarak bırakılmış, orijinal kodunuzda böyle
            keto,
            lowcarb,
            fillerLunch,
            fillerDinner,
            step
        });
    } else {
        // Eğer kategori yoksa, yeni bir kategori oluştur
        categories.push({
            name: categoryName,
            items: [{
                name,
                calories,
                protein,
                carbs,
                fat,
                maxQuantity,
                minQuantity,
                tags,
                role: "mainDish",
                mealType: "breakfast,lunch,dinner",
                keto,
                lowcarb,
                fillerLunch,
                fillerDinner,
                step
            }]
        });
    }

    const form = document.getElementById('addFoodFormInner');
    if (form) {
        form.reset(); // Formu sıfırla
        document.getElementById('foodMaxQuantity').value = 1; // Varsayılan değeri geri yükle
    } else {
        console.error("addFoodFormInner bulunamadı!");
    }

    toggleAddFoodForm(); // Formu gizle
    loadCategories();    // Soldaki paneli güncelle
    searchEditFood('');  // Sağdaki paneli güncelle
    showNotification(`${name} yemeği eklendi!`);
}

        function renderWeekTabs() {
            const weekTabs = document.getElementById('weekTabs');
            weekTabs.innerHTML = weeks.map((_, index) => `
                <li class="nav-item">
                    <a class="nav-link ${selectedWeek === index + 1 ? 'active' : ''}" href="#" onclick="selectWeek(${index + 1})">Hafta ${index + 1}</a>
                </li>
            `).join('');
        }

        function renderDayTabs() {
            const dayTabs = document.getElementById('dayTabs');
            dayTabs.innerHTML = days.map(day => `
                <li class="nav-item">
                    <a class="nav-link ${selectedDay === day ? 'active' : ''}" href="#" onclick="selectDay('${day}')">${day.charAt(0).toUpperCase() + day.slice(1)}</a>
                </li>
            `).join('');
        }

        function selectWeek(week) {
            selectedWeek = week;
            renderWeekTabs();
            renderMeals();
            calculateMacros();
        }

        function selectDay(day) {
            selectedDay = day;
            renderDayTabs();
            renderMeals();
            calculateMacros();
        }

        function addWeek() {
    weeks.push({
        days: {
            monday: { meals: { breakfast: [], lunch: [], dinner: [] } },
            tuesday: { meals: { breakfast: [], lunch: [], dinner: [] } },
            wednesday: { meals: { breakfast: [], lunch: [], dinner: [] } },
            thursday: { meals: { breakfast: [], lunch: [], dinner: [] } }, // Düzeltildi
            friday: { meals: { breakfast: [], lunch: [], dinner: [] } },
            saturday: { meals: { breakfast: [], lunch: [], dinner: [] } },
            sunday: { meals: { breakfast: [], lunch: [], dinner: [] } }
        }
    });
    selectedWeek = weeks.length;
    renderWeekTabs();
    renderMeals();
    showNotification("Yeni hafta eklendi!");
}

        function deleteWeek() {
            if (weeks.length > 1) {
                weeks.splice(selectedWeek - 1, 1);
                selectedWeek = Math.min(selectedWeek, weeks.length);
                renderWeekTabs();
                renderMeals();
                calculateMacros();
                showNotification("Hafta silindi!");
            } else {
                showNotification("En az bir hafta kalmalı!", "warning");
            }
        }

        function copyWeek() {
            const newWeek = JSON.parse(JSON.stringify(weeks[selectedWeek - 1]));
            weeks.push(newWeek);
            selectedWeek = weeks.length;
            renderWeekTabs();
            renderMeals();
            calculateMacros();
            showNotification("Hafta kopyalandı!");
        }

        function getActiveRoles(meal) {
            const mealItems = meal.map(item => findFood(item.name)?.role);
            return roles.map(role => ({
                ...role,
                active: mealItems.includes(role.role)
            }));
        }

        function toggleRole(mealType, roleIndex) {
            const meal = weeks[selectedWeek - 1].days[selectedDay].meals[mealType];
            const role = roles[roleIndex].role;
            const activeRoles = getActiveRoles(meal);
            const isActive = activeRoles[roleIndex].active;

            if (!isActive) {
                const patientData = currentPatient ? JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}') : {};
                const likedFoods = patientData.likedFoods || [];
                const dislikedFoods = patientData.dislikedFoods || [];
                const availableFoods = categories.flatMap(cat => cat.items)
                    .filter(f => f.role === role && f.mealType.includes(mealType) && (dietMode === 'keto' ? f.keto : f.lowcarb))
                    .filter(f => !dislikedFoods.some(df => f.name.toLowerCase().includes(df.toLowerCase()) || f.tags.some(t => t.toLowerCase().includes(df.toLowerCase()))));
                if (availableFoods.length > 0) {
                    const preferredFoods = availableFoods.filter(f => likedFoods.some(lf => f.name.toLowerCase().includes(lf.toLowerCase()) || f.tags.some(t => t.toLowerCase().includes(lf.toLowerCase()))));
                    const food = preferredFoods.length > 0 ? preferredFoods[Math.floor(Math.random() * preferredFoods.length)] : availableFoods[Math.floor(Math.random() * availableFoods.length)];
                    meal.push({ name: food.name, quantity: 1 });
                }
            } else {
                const index = meal.findIndex(item => findFood(item.name)?.role === role);
                if (index !== -1) meal.splice(index, 1);
            }
            renderMeals();
            calculateMacros();
        }

        function renderMeals() {
    const mealsDiv = document.getElementById('meals');
    if (!mealsDiv) {
        console.error("meals elementi bulunamadı!");
        return;
    }

    const weekIndex = selectedWeek ? selectedWeek - 1 : 0;
    const day = selectedDay || "monday";

    if (!weeks || !Array.isArray(weeks) || !weeks[weekIndex] || !weeks[weekIndex].days || !weeks[weekIndex].days[day]) {
        console.warn(`Hafta ${weekIndex + 1} veya gün ${day} tanımsız!`, weeks);
        return;
    }

    const dayMeals = weeks[weekIndex].days[day].meals;
    if (!dayMeals || !dayMeals.breakfast || !dayMeals.lunch || !dayMeals.dinner) {
        console.warn(`Gün ${day} için meals yapısı eksik!`, dayMeals);
        return;
    }

    let breakfastCalories = 0, lunchCalories = 0, dinnerCalories = 0;
    Object.values(dayMeals.breakfast).forEach(item => {
        const food = findFood(item.name);
        if (food) breakfastCalories += food.calories * (item.quantity || 1);
    });
    Object.values(dayMeals.lunch).forEach(item => {
        const food = findFood(item.name);
        if (food) lunchCalories += food.calories * (item.quantity || 1);
    });
    Object.values(dayMeals.dinner).forEach(item => {
        const food = findFood(item.name);
        if (food) dinnerCalories += food.calories * (item.quantity || 1);
    });

    const targetCalories = parseFloat(document.getElementById('targetCalories').value) || 2000;
    const lunchRatio = parseFloat(document.getElementById('lunchCalorieRatio').value) || 40;
    const dinnerRatio = parseFloat(document.getElementById('dinnerCalorieRatio').value) || 30;

    // Yemekleri role göre sıralama fonksiyonu
    const sortMealsByRole = (meals) => {
    return meals.slice().sort((a, b) => {
        const foodA = findFood(a.name);
        const foodB = findFood(b.name);
        const roleA = (foodA.role || "bilinmiyor").toLowerCase().trim(); // Hepsini küçük harfe çevir
        const roleB = (foodB.role || "bilinmiyor").toLowerCase().trim();
        // roleOrder'ı da küçük harflerle tanımlı hale getirelim
        const roleOrderLower = {
            "soup": 1,
            "maindish": 2,
            "sidedish": 3,
            "bread": 4,
            "dessert": 5,
            "fruit": 6,
            "snack": 7,
            "drink": 8,
            "supplement": 9,
            "bilinmiyor": 10
        };
        const orderA = roleOrderLower[roleA] || 10;
        const orderB = roleOrderLower[roleB] || 10;
        console.log(`A: ${a.name} -> ${roleA} (${orderA}), B: ${b.name} -> ${roleB} (${orderB})`);
        return orderA - orderB;
    });
};

    // Her öğün türünü sırala
    const sortedBreakfast = sortMealsByRole(dayMeals.breakfast);
    const sortedLunch = sortMealsByRole(dayMeals.lunch);
    const sortedDinner = sortMealsByRole(dayMeals.dinner);

    mealsDiv.innerHTML = `
        <div class="card meal-card">
            <div class="card-header">Kahvaltı (${breakfastCalories.toFixed(0)} kcal / Hedef: ${(targetCalories * (1 - lunchRatio / 100 - dinnerRatio / 100)).toFixed(0)})
                <div class="role-checkboxes">
                    ${getActiveRoles(dayMeals.breakfast).map((r, i) => `
                        <span><input type="checkbox" ${r.active ? 'checked' : ''} onchange="toggleRole('breakfast', ${i})"> ${r.role}</span>
                    `).join('')}
                </div>
            </div>
            <div class="card-body">
                <table class="table meal-table">
                    <thead>
                        <tr>
                            <th>Yemek</th>
                            <th>Kategori/Rol</th>
                            <th>Miktar</th>
                            <th>Kalori</th>
                            <th>Protein</th>
                            <th>Karb.</th>
                            <th>Yağ</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedBreakfast.map((item, index) => renderMealItem(item, 'breakfast', index)).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card meal-card">
            <div class="card-header">Öğle (${lunchCalories.toFixed(0)} kcal / Hedef: ${(targetCalories * lunchRatio / 100).toFixed(0)})
                <button class="btn btn-sm btn-success template-add-btn mt-1" onclick="addCurrentMealToTemplates('lunch')">Öğün Kayıt</button>
                <div class="role-checkboxes">
                    ${getActiveRoles(dayMeals.lunch).map((r, i) => `
                        <span><input type="checkbox" ${r.active ? 'checked' : ''} onchange="toggleRole('lunch', ${i})"> ${r.role}</span>
                    `).join('')}
                </div>
            </div>
            <div class="card-body">
                <table class="table meal-table">
                    <thead>
                        <tr>
                            <th>Yemek</th>
                            <th>Kategori/Rol</th>
                            <th>Miktar</th>
                            <th>Kalori</th>
                            <th>Protein</th>
                            <th>Karb.</th>
                            <th>Yağ</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedLunch.map((item, index) => renderMealItem(item, 'lunch', index)).join('')}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card meal-card">
            <div class="card-header">Akşam (${dinnerCalories.toFixed(0)} kcal / Hedef: ${(targetCalories * dinnerRatio / 100).toFixed(0)})
                <button class="btn btn-sm btn-success template-add-btn mt-1" onclick="addCurrentMealToTemplates('dinner')">Öğün Kayıt</button>
                <div class="role-checkboxes">
                    ${getActiveRoles(dayMeals.dinner).map((r, i) => `
                        <span><input type="checkbox" ${r.active ? 'checked' : ''} onchange="toggleRole('dinner', ${i})"> ${r.role}</span>
                    `).join('')}
                </div>
            </div>
            <div class="card-body">
                <table class="table meal-table">
                    <thead>
                        <tr>
                            <th>Yemek</th>
                            <th>Kategori/Rol</th>
                            <th>Miktar</th>
                            <th>Kalori</th>
                            <th>Protein</th>
                            <th>Karb.</th>
                            <th>Yağ</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedDinner.map((item, index) => renderMealItem(item, 'dinner', index)).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderMealItem(item, mealType, index) {
    const food = findFood(item.name);
    if (!food) return '';

    const quantity = item.quantity || 1;

    // Sayısal miktarı kelimeye çevirme fonksiyonu
    function formatQuantity(quantity) {
        if (quantity === 0.5) return 'yarım';
        if (quantity === 0.25) return 'çeyrek';
        return quantity.toString().replace('.', ','); // Noktayı virgüle çevir
    }

    // Yemek adını güncelleyen fonksiyon
    function updateName(name, quantity) {
        if (quantity === 0.5 && name.includes("yemek kaşığı")) {
            return name.replace(/\b0\.5 yemek kaşığı\b/, "1 tatlı kaşığı");
        }
        if (name.includes("yarım yemek kaşığı")) {
            return name.replace(/\byarım yemek kaşığı\b/, "1 tatlı kaşığı");
        }
        if (name.includes("2 tatlı kaşığı")) {
            return name.replace(/\b2 tatlı kaşığı\b/, "1 yemek kaşığı");
        }
        if (name.includes("0.25 yemek kaşığı")) {
            return name.replace(/\b0\.25 yemek kaşığı\b/, "çeyrek yemek kaşığı");
        }
        return name;
    }

    // Yemek adını dönüştür
    let updatedName = updateName(food.name, quantity);

    // Ölçü birimlerine göre sayıları formatla
    const units = ["gram", "adet", "kase", "porsiyon", "dilim", "kaşık", "tatlı kaşığı", "yemek kaşığı", "kare"];
    for (let unit of units) {
        const regex = new RegExp(`(\\d+(?:\\.\\d+)?)\\s*${unit}`, "g");
        updatedName = updatedName.replace(regex, (match, number) => {
            const updatedValue = Math.round(parseFloat(number) * quantity * 10) / 10;
            const formattedValue = formatQuantity(updatedValue); // Miktarı kelime olarak göster
            return `${formattedValue} ${unit}`;
        });
    }

    // Kategori ve rol bilgisini al
    const category = categories.find(cat => cat.items.some(i => i.name === item.name))?.name || 'Bilinmiyor';
    const role = food.role || 'Bilinmiyor';

    return `
        <tr>
            <td>
                ${updatedName}
                <br><small style="color:gray;">Artış düzeyi: ${food.step || 0.5}</small>
            </td>
            <td>${category} / ${role}</td> <!-- Yeni sütun -->
            <td>
                <input type="number" 
                       value="${quantity}" 
                       min="${food.minQuantity || 0.5}" 
                       max="${food.maxQuantity || 10}" 
                       step="${food.step || 0.5}" 
                       onchange="updateMealQuantity('${mealType}', ${index}, this.value)">
            </td>
            <td>${(food.calories * quantity).toFixed(1)}</td>
            <td>${(food.protein * quantity).toFixed(1)}</td>
            <td>${(food.carbs * quantity).toFixed(1)}</td>
            <td>${(food.fat * quantity).toFixed(1)}</td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editMealItem('${mealType}', ${index})" title="Düzenle"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-danger btn-sm" onclick="deleteMealItem('${mealType}', ${index})" title="Sil"><i class="bi bi-trash"></i></button>
            </td>
        </tr>
    `;
}








function findFood(foodName) {
    for (const category of categories) {
        const food = category.items.find(item => item.name === foodName);
        if (food) {
            food.category = category.name; // Kategori bilgisini ekle
            return food;
        }
    }
    return { name: foodName, calories: 0, protein: 0, carbs: 0, fat: 0, role: 'Bilinmiyor', step: 0.5 }; // Varsayılan değerler
}

        function updateMealQuantity(mealType, index, value) {
    weeks[selectedWeek - 1].days[selectedDay].meals[mealType][index].quantity = parseFloat(value);
    renderMeals();
    calculateMacros();
}

        function deleteMealItem(mealType, index) {
            weeks[selectedWeek - 1].days[selectedDay].meals[mealType].splice(index, 1);
            renderMeals();
            calculateMacros();
            showNotification("Yemek silindi!");
        }

        function editMealItem(mealType, index) {
            const foodItem = weeks[selectedWeek - 1].days[selectedDay].meals[mealType][index];
            const food = findFood(foodItem.name);
            if (!food) return;

            const panel = document.getElementById('editFoodPanel');
            document.getElementById('editFoodIndex').value = `${mealType}_${index}`;
            document.getElementById('editFoodOriginalName').value = foodItem.name;
            document.getElementById('editFoodName').value = foodItem.name;
            document.getElementById('editFoodCalories').value = food.calories;
            document.getElementById('editFoodProtein').value = food.protein;
            document.getElementById('editFoodCarbs').value = food.carbs;
            document.getElementById('editFoodFat').value = food.fat;
            document.getElementById('editFoodMaxQuantity').value = food.maxQuantity;
document.getElementById('editFoodMinQuantity').value = food.minQuantity || 0.5;
            document.getElementById('editFoodRole').value = food.role;
            document.getElementById('editFoodTags').value = food.tags.join(', ');
            document.getElementById('editFoodMealType').value = food.mealType;
            document.getElementById('editFoodKeto').checked = food.keto;
            document.getElementById('editFoodLowCarb').checked = food.lowcarb;
            panel.style.display = 'block';
        }

        function saveEditedFood(event) {
    event.preventDefault();
    const originalName = document.getElementById('editFoodOriginalName').value;
    const name = document.getElementById('editFoodName').value;
    const calories = parseFloat(document.getElementById('editFoodCalories').value);
    const protein = parseFloat(document.getElementById('editFoodProtein').value);
    const carbs = parseFloat(document.getElementById('editFoodCarbs').value);
    const fat = parseFloat(document.getElementById('editFoodFat').value);
    const maxQuantity = parseFloat(document.getElementById('editFoodMaxQuantity').value);
    const minQuantity = parseFloat(document.getElementById('editFoodMinQuantity').value);
    const step = parseFloat(document.getElementById('editFoodStep').value);
    const role = document.getElementById('editFoodRole').value;
    const tags = document.getElementById('editFoodTags').value.split(',').map(t => t.trim());
    const mealType = document.getElementById('editFoodMealType').value.split(',');
    const keto = document.getElementById('editFoodKeto').checked;
    const lowcarb = document.getElementById('editFoodLowCarb').checked;
    const fillerLunch = document.getElementById('editFoodFillerLunch').checked;
    const fillerDinner = document.getElementById('editFoodFillerDinner').checked;

    const food = findFood(originalName);
    if (food) {
        food.name = name;
        food.calories = calories;
        food.protein = protein;
        food.carbs = carbs;
        food.fat = fat; // fatals yerine fat
        food.maxQuantity = maxQuantity;
        food.minQuantity = minQuantity;
        food.step = step;
        food.role = role;
        food.tags = tags;
        food.mealType = mealType;
        food.keto = keto;
        food.lowcarb = lowcarb;
        food.fillerLunch = fillerLunch;
        food.fillerDinner = fillerDinner;
    }

    closeEditFoodPanel();
    loadCategories();
    renderMeals(); // Tüm öğünler yeniden çizilecek, manuel güncelleme gerekmez
    calculateMacros();
    showNotification("Yemek güncellendi!");
}

        function closeEditFoodPanel() {
            document.getElementById('editFoodPanel').style.display = 'none';
        }

        function calculateWeeklyAverages() {
    const week = weeks[selectedWeek - 1];
    const weeklyTotals = {
        calories: 0,
        protein: 0,
        carbs: 0,
        fat: 0
    };
    let dayCount = 0;

    // Haftanın tüm günlerini dolaş
    Object.values(week.days).forEach(day => {
        const dayMeals = day.meals;
        Object.values(dayMeals).forEach(meal => {
            meal.forEach(item => {
                const food = findFood(item.name);
                if (food) {
                    const quantity = item.quantity || 1;
                    weeklyTotals.calories += food.calories * quantity;
                    weeklyTotals.protein += food.protein * quantity;
                    weeklyTotals.carbs += food.carbs * quantity;
                    weeklyTotals.fat += food.fat * quantity;
                }
            });
        });
        dayCount++;
    });

    // Ortalamaları hesapla (7 güne böl), string yerine sayı döndür
    return {
        calories: dayCount > 0 ? weeklyTotals.calories / 7 : 0,
        protein: dayCount > 0 ? weeklyTotals.protein / 7 : 0,
        carbs: dayCount > 0 ? weeklyTotals.carbs / 7 : 0,
        fat: dayCount > 0 ? weeklyTotals.fat / 7 : 0
    };
}
function generateAnalysisText(type, day, actualValues, targetValues, weeklyData = null) {
    const isKeto = true; // Varsayılan olarak ketojenik beslenme (kullanıcı ayarı eklenebilir)
    const dietType = isKeto ? "ketojenik" : "low-carb";
    const carbLimit = isKeto ? 30 : 70; // Ketojenik için 30g, low-carb için 70g sınır

    // Değer farklarını hesapla
    const diffs = {
        calories: actualValues.calories - targetValues.calories,
        fat: actualValues.fat - targetValues.fat,
        protein: actualValues.protein - targetValues.protein,
        carbs: actualValues.carbs - targetValues.carbs
    };

    // Günlük veya haftalık metni oluştur
    let title, status, highlights, evaluation, suggestions;

    if (type === "daily") {
        title = `<h4>Günlük Makro Analizi (${day})</h4>`;
        status = `
            <p>Kalori: ${actualValues.calories.toFixed(0)} kcal (Hedef: ${targetValues.calories.toFixed(0)} kcal, ${diffs.calories > 0 ? '+' : ''}${diffs.calories.toFixed(0)} kcal ${diffs.calories >= 0 ? 'üstünde' : 'altında'})</p>
            <p>Yağ: ${actualValues.fat.toFixed(0)} g (Hedef: ${targetValues.fat.toFixed(0)} g, ${diffs.fat > 0 ? '+' : ''}${diffs.fat.toFixed(0)} g ${diffs.fat >= 0 ? 'üstünde' : 'altında'})</p>
            <p>Protein: ${actualValues.protein.toFixed(0)} g (Hedef: ${targetValues.protein.toFixed(0)} g, ${diffs.protein > 0 ? '+' : ''}${diffs.protein.toFixed(0)} g ${diffs.protein >= 0 ? 'üstünde' : 'altında'})</p>
            <p>Karbonhidrat: ${actualValues.carbs.toFixed(0)} g (Hedef: ${targetValues.carbs.toFixed(0)} g, ${diffs.carbs > 0 ? '+' : ''}${diffs.carbs.toFixed(0)} g ${diffs.carbs >= 0 ? 'üstünde' : 'altında'})</p>
        `;

        // Değerlendirme
        evaluation = "<p><strong>Değerlendirme:</strong><br>";
        if (isKeto) {
            evaluation += `Harika bir iş çıkarıyorsun! Karbonhidrat alımını ${actualValues.carbs.toFixed(0)} g’da tutarak ketozis sürecini desteklemeye devam ediyorsun, bu ${dietType} beslenme için mükemmel bir seviye. `;
            if (diffs.protein > 0) {
                evaluation += `Protein hedefini ${diffs.protein.toFixed(0)} g aşmışsın, bu da kaslarını desteklemek için harika. `;
            } else {
                evaluation += `Protein alımın hedefin ${Math.abs(diffs.protein).toFixed(0)} g altında, kas kütleni desteklemek için biraz artırabilirsin. `;
            }
            if (diffs.calories < 0 || diffs.fat < 0) {
                evaluation += `Ancak kalori ve yağ alımın hedefin altında kalmış, bu da gün içinde enerjini düşürebilir.`;
            } else {
                evaluation += `Kalori ve yağ alımın dengeli, ketozis sürecin harika bir şekilde destekleniyor!`;
            }
        } else {
            evaluation += `Çok iyi gidiyorsun! Karbonhidrat alımını ${actualValues.carbs.toFixed(0)} g’da tutarak ${dietType} beslenmenin sınırları içinde kalmayı başarmışsın, bu koruma modun için harika bir denge. `;
            if (diffs.fat > 0 && diffs.protein > 0) {
                evaluation += `Yağ ve protein hedeflerini aşmışsın, bu da enerji seviyeni desteklemek için olumlu. `;
            }
            if (diffs.calories < 0) {
                evaluation += `Kalori hedefin ${Math.abs(diffs.calories).toFixed(0)} kcal altında, bu uzun vadede enerjini etkileyebilir.`;
            } else {
                evaluation += `Kalori alımın dengeli, harika bir denge yakalamışsın!`;
            }
        }
        evaluation += "</p>";

        // Öneriler
        suggestions = "<p><strong>Öneriler:</strong><br>";
        if (diffs.calories < 0) {
            suggestions += `- Kalori açığını kapatmak için ${isKeto ? 'sağlıklı yağ kaynaklarına yönelebilirsin. Örneğin, öğünlerine biraz daha avokado, zeytinyağı veya hindistancevizi yağı eklemek hem kalorini artırır hem de ketozis sürecini destekler.' : 'karbonhidratı artırmadan sağlıklı yağlar ve protein kaynakları ekleyebilirsin. Örneğin, bir öğüne somon veya tam yağlı yoğurt eklemek harika bir seçenek.'} `;
        }
        if (diffs.fat < 0) {
            suggestions += `- Yağ alımın ${dietType} beslenme için biraz düşük kalmış. Öğünlerine daha fazla sağlıklı yağ ekleyerek ${isKeto ? 'ketozis sürecini destekleyebilirsin' : 'enerji seviyeni destekleyebilirsin'}. Örneğin, salatalarına zeytinyağı veya yemeklerine avokado eklemeyi deneyebilirsin. `;
        }
        if (diffs.protein < 0) {
            suggestions += `- Protein alımın kas kütleni desteklemek için biraz düşük kalmış. Öğünlerine daha fazla protein eklemek için haşlanmış yumurta, ızgara tavuk veya tam yağlı yoğurt gibi seçenekler deneyebilirsin. `;
        }
        if (diffs.carbs > (isKeto ? 30 : 70)) {
            suggestions += `- Karbonhidrat alımın ${dietType} için biraz yüksek kalmış. Bir sonraki öğünde karbonhidratı daha düşük tutarak ${isKeto ? 'ketozis sürecini destekleyebilirsin' : 'dengenizi sağlayabilirsin'}. Örneğin, karbonhidrat yerine daha fazla yeşil sebze (ıspanak, brokoli) tercih edebilirsin. `;
        }
        suggestions += `Hedefine çok yakınsın, böyle devam et!</p>`;
    } else {
        // Haftalık analiz
        title = `<h4>Haftalık Makro Trend Analizi</h4>`;
        status = `
            <p>Ortalama Kalori: ${actualValues.calories.toFixed(0)} kcal (Hedef: ${targetValues.calories.toFixed(0)} kcal, ${diffs.calories > 0 ? '+' : ''}${diffs.calories.toFixed(0)} kcal ${diffs.calories >= 0 ? 'üstünde' : 'altında'})</p>
            <p>Ortalama Yağ: ${actualValues.fat.toFixed(0)} g (Hedef: ${targetValues.fat.toFixed(0)} g, ${diffs.fat > 0 ? '+' : ''}${diffs.fat.toFixed(0)} g ${diffs.fat >= 0 ? 'üstünde' : 'altında'})</p>
            <p>Ortalama Protein: ${actualValues.protein.toFixed(0)} g (Hedef: ${targetValues.protein.toFixed(0)} g, ${diffs.protein > 0 ? '+' : ''}${diffs.protein.toFixed(0)} g ${diffs.protein >= 0 ? 'üstünde' : 'altında'})</p>
            <p>Ortalama Karbonhidrat: ${actualValues.carbs.toFixed(0)} g (Hedef: ${targetValues.carbs.toFixed(0)} g, ${diffs.carbs > 0 ? '+' : ''}${diffs.carbs.toFixed(0)} g ${diffs.carbs >= 0 ? 'üstünde' : 'altında'})</p>
        `;

        // Öne çıkanlar (haftalık verilerden analiz)
        highlights = "<p><strong>Öne Çıkanlar:</strong><br>";
        let maxCarbDay = { day: '', value: 0 };
        let minCalorieDay = { day: '', value: Infinity };
        let maxProteinDay = { day: '', value: 0 };

        const days = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];
        days.forEach((day, index) => {
            const dayData = weeklyData[index];
            if (dayData) {
                if (dayData.carbs > maxCarbDay.value) maxCarbDay = { day, value: dayData.carbs };
                if (dayData.calories < minCalorieDay.value) minCalorieDay = { day, value: dayData.calories };
                if (dayData.protein > maxProteinDay.value) maxProteinDay = { day, value: dayData.protein };
            }
        });

        if (maxCarbDay.value > carbLimit) {
            highlights += `- ${maxCarbDay.day} günü karbonhidrat ${maxCarbDay.value.toFixed(0)} g’a çıkmış, bu ${dietType} sınırını biraz aşmış olabilir.<br>`;
        }
        if (minCalorieDay.value < targetValues.calories) {
            highlights += `- ${minCalorieDay.day} günü kalori hedefin oldukça altında kalmış (${minCalorieDay.value.toFixed(0)} kcal, ${(minCalorieDay.value - targetValues.calories).toFixed(0)} kcal).<br>`;
        }
        if (maxProteinDay.value > targetValues.protein) {
            highlights += `- Protein alımın haftanın her günü hedefin üstünde, özellikle ${maxProteinDay.day} günü %${((maxProteinDay.value / targetValues.protein) * 100).toFixed(0)}’ye ulaşmış (${maxProteinDay.value.toFixed(0)} g).`;
        }
        highlights += "</p>";

        // Değerlendirme
        evaluation = "<p><strong>Değerlendirme:</strong><br>";
        if (isKeto) {
            evaluation += `Ketozis sürecini desteklemek için karbonhidratı ${actualValues.carbs.toFixed(0)} g’ın altında tutmayı başarmışsın, bu harika bir başarı! `;
            if (diffs.calories < 0 || diffs.fat < 0) {
                evaluation += `Yağ ve kalori alımın ise haftalık ortalamada hedefin biraz altında kalmış, bu da bazı günlerde enerjini etkilemiş olabilir. `;
            }
            if (diffs.protein > 0) {
                evaluation += `Protein alımın kas kütleni desteklemek için mükemmel bir seviyede.`;
            }
        } else {
            evaluation += `Low-carb beslenmende harika bir denge yakalamışsın! Karbonhidratı genelde ${carbLimit} g’ın altında tutmayı başarmışsın, ancak ${maxCarbDay.day} günü hafif bir aşım olmuş, bu dikkat gerektirebilir. `;
            if (diffs.calories < 0) {
                evaluation += `Kalori alımın haftalık ortalamada hedefin ${Math.abs(diffs.calories).toFixed(0)} kcal altında, bu da bazı günlerde enerjini etkilemiş olabilir. `;
            }
            if (diffs.fat > 0 && diffs.protein > 0) {
                evaluation += `Yağ ve protein alımın ise hedefin üstünde, bu da enerji seviyeni desteklemek için olumlu.`;
            }
        }
        evaluation += "</p>";

        // Öneriler
        suggestions = "<p><strong>Öneriler:</strong><br>";
        if (maxCarbDay.value > carbLimit) {
            suggestions += `- ${maxCarbDay.day} gibi karbonhidratın yükseldiği günleri dengelemek için düşük glisemik indeksli seçeneklere odaklanabilirsin. Örneğin, karbonhidratı artırmak yerine daha fazla yeşil sebze (ıspanak, kabak) tercih edebilirsin. `;
        }
        if (diffs.calories < 0) {
            suggestions += `- Kalori açığını kapatmak için ${isKeto ? 'sağlıklı yağlar ekleyebilirsin. Örneğin, bir öğüne somon veya tam yağlı peynir eklemek hem kalorini artırır hem de ketozis sürecini destekler.' : 'karbonhidratı artırmadan sağlıklı yağlar ve protein kaynakları ekleyebilirsin. Örneğin, bir öğüne somon veya tam yağlı peynir eklemek hem kalorini artırır hem de low-carb sınırlarını korur.'} `;
        }
        suggestions += `Harika bir hafta geçirmişsin, bu dengeyi koruyarak devam et!</p>`;
    }

    // Sorumluluk reddi
    const disclaimer = `
        <p class="disclaimer"><strong>Sorumluluk Reddi:</strong><br>
        Bu analiz ve öneriler, genel bilgilendirme ve motivasyon amaçlı hazırlanmıştır. Beslenme planınızı oluştururken veya değişiklik yaparken, özellikle bir sağlık sorununuz varsa, öncelikle doktorunuza veya bir diyetisyene danışmanız önemlidir. Her bireyin sağlık durumu, metabolizması ve ihtiyaçları farklıdır; bu nedenle, önerilerimiz sizin için uygun olmayabilir. Sağlıklı bir yaşam tarzı için profesyonel bir uzmandan destek almayı unutmayın.</p>
    `;

    return `${title}${status}${type === "weekly" ? highlights : ""}${evaluation}${suggestions}${disclaimer}`;
}

function calculateMacros() {
    const patientData = currentPatient ? JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}') : {};
    const weight = patientData.weight || 70;
    const activityLevel = patientData.activity || 3;
    const bmr = 10 * weight + 6.25 * 175 - 5 * 30 + 5;
    const activityMultiplier = [0.8, 0.9, 1.0, 1.1, 1.2][activityLevel - 1];
    const tdee = bmr * activityMultiplier;

    const carbMultiplier = parseFloat(document.getElementById('carbMultiplier').value) || 0.5;
    const proteinMultiplier = parseFloat(document.getElementById('proteinMultiplier').value) || 2;
    const fatMultiplier = parseFloat(document.getElementById('fatMultiplier').value) || 0.8;

    const targetCarbs = weight * carbMultiplier * activityMultiplier;
    const targetProtein = weight * proteinMultiplier * activityMultiplier;
    const targetFat = weight * fatMultiplier * activityMultiplier;
    const targetCalories = targetCarbs * 4 + targetProtein * 4 + targetFat * 9;

    document.getElementById('bmrDisplay').value = bmr.toFixed(0);
    document.getElementById('targetCalories').value = targetCalories.toFixed(0);
    document.getElementById('targetProtein').value = targetProtein.toFixed(0);
    document.getElementById('targetCarbs').value = targetCarbs.toFixed(0);
    document.getElementById('targetFat').value = targetFat.toFixed(0);

    const weekIndex = selectedWeek ? selectedWeek - 1 : 0;
    const day = selectedDay || "monday";

    if (!weeks[weekIndex] || !weeks[weekIndex].days[day]) {
        console.warn(`calculateMacros: Hafta ${weekIndex + 1} veya gün ${day} tanımsız!`, weeks);
        return;
    }

    const dayMeals = weeks[weekIndex].days[day].meals;
    const totals = {
        calories: 0,
        protein: 0,
        carbs: 0,
        fat: 0
    };

    Object.values(dayMeals).forEach(meal => {
        meal.forEach(item => {
            const food = findFood(item.name);
            if (food) {
                const quantity = item.quantity || 1;
                totals.calories += food.calories * quantity;
                totals.protein += food.protein * quantity;
                totals.carbs += food.carbs * quantity;
                totals.fat += food.fat * quantity;
            }
        });
    });

    const flexibility = parseFloat(document.getElementById('calorieFlexibility').value) / 100 || 0.1;
    const macroTotals = document.getElementById('macroTotals');
    const weeklyAverages = calculateWeeklyAverages();

    // Tabloyu oluştur
    macroTotals.innerHTML = `
        <tr>
            <th>Makro</th>
            <th>Hedef</th>
            <th>Günlük (${day})</th>
            <th>Fark</th>
            <th>Haftalık Ortalama (Fark)</th>
        </tr>
        <tr class="${totals.calories > targetCalories * (1 + flexibility) ? 'macro-exceed' : totals.calories < targetCalories * (1 - flexibility) ? 'macro-low' : ''}">
            <td>Kalori</td>
            <td>${targetCalories.toFixed(0)}</td>
            <td>${totals.calories.toFixed(0)}</td>
            <td>${(totals.calories - targetCalories).toFixed(0)}</td>
            <td>${weeklyAverages.calories.toFixed(0)} (${(weeklyAverages.calories - targetCalories).toFixed(0)})</td>
        </tr>
        <tr class="${totals.protein > targetProtein * (1 + flexibility) ? 'macro-exceed' : totals.protein < targetProtein * (1 - flexibility) ? 'macro-low' : ''}">
            <td>Protein</td>
            <td>${targetProtein.toFixed(0)}</td>
            <td>${totals.protein.toFixed(0)}</td>
            <td>${(totals.protein - targetProtein).toFixed(0)}</td>
            <td>${weeklyAverages.protein.toFixed(0)} (${(weeklyAverages.protein - targetProtein).toFixed(0)})</td>
        </tr>
        <tr class="${totals.carbs > targetCarbs * (1 + flexibility) ? 'macro-exceed' : totals.carbs < targetCarbs * (1 - flexibility) ? 'macro-low' : ''}">
            <td>Karb.</td>
            <td>${targetCarbs.toFixed(0)}</td>
            <td>${totals.carbs.toFixed(0)}</td>
            <td>${(totals.carbs - targetCarbs).toFixed(0)}</td>
            <td>${weeklyAverages.carbs.toFixed(0)} (${(weeklyAverages.carbs - targetCarbs).toFixed(0)})</td>
        </tr>
        <tr class="${totals.fat > targetFat * (1 + flexibility) ? 'macro-exceed' : totals.fat < targetFat * (1 - flexibility) ? 'macro-low' : ''}">
            <td>Yağ</td>
            <td>${targetFat.toFixed(0)}</td>
            <td>${totals.fat.toFixed(0)}</td>
            <td>${(totals.fat - targetFat).toFixed(0)}</td>
            <td>${weeklyAverages.fat.toFixed(0)} (${(weeklyAverages.fat - targetFat).toFixed(0)})</td>
        </tr>
    `;

    // Grafikleri tablonun sağ tarafına yerleştir
    const macroDisplay = document.querySelector('.macro-display');
    if (macroDisplay) {
        // Mevcut grafikleri temizle (eğer varsa)
        const existingCharts = macroDisplay.querySelector('.macro-charts');
        if (existingCharts) {
            existingCharts.remove();
        }

        // Yeni grafikler div'i oluştur
        const chartsDiv = document.createElement('div');
        chartsDiv.className = 'macro-charts';
        chartsDiv.innerHTML = `
            <div class="chart-container">
                <h4>Günlük (${day})</h4>
                <canvas id="dailyMacroChart" width="150" height="150"></canvas>
            </div>
            <div class="chart-container">
                <h4>Haftalık Ortalama</h4>
                <canvas id="weeklyMacroChart" width="150" height="150"></canvas>
            </div>
        `;
        macroDisplay.appendChild(chartsDiv);
    }

    // Hedef ve gerçekleşen değerleri hazırla
    const targetValues = {
        calories: targetCalories,
        carbs: targetCarbs,
        protein: targetProtein,
        fat: targetFat
    };

    // Günlük grafiği çiz
    drawMacroChart('dailyMacroChart', {
        calories: totals.calories / targetCalories,
        carbs: totals.carbs / targetCarbs,
        protein: totals.protein / targetProtein,
        fat: totals.fat / targetFat
    }, totals, targetValues, `Günlük (${day})`);

    // Haftalık grafiği çiz
    drawMacroChart('weeklyMacroChart', {
        calories: weeklyAverages.calories / targetCalories,
        carbs: weeklyAverages.carbs / targetCarbs,
        protein: weeklyAverages.protein / targetProtein,
        fat: weeklyAverages.fat / targetFat
    }, weeklyAverages, targetValues, 'Haftalık Ortalama');
}


function drawMacroChart(canvasId, data, actualValues = null, targetValues = null, title = '', type = 'daily', weeklyData = null) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
        console.error(`Canvas with ID ${canvasId} not found!`);
        return;
    }
    const ctx = canvas.getContext('2d');

    console.log(`Canvas ${canvasId} dimensions: ${canvas.width}x${canvas.height}`);

    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const maxRadius = canvas.width >= 300 ? 120 : canvas.width * 0.4;
    const ringWidth = canvas.width >= 300 ? 24 : canvas.width * 0.08;
    const gap = canvas.width >= 300 ? 2 : 1;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const rings = [
        { name: 'Kalori', value: data.calories, actual: actualValues?.calories || 0, target: targetValues?.calories || 0, radius: maxRadius, color: 'rgba(40, 167, 69, 0.8)', excessColor: 'rgba(20, 120, 40, 0.8)' },
        { name: 'Yağ', value: data.fat, actual: actualValues?.fat || 0, target: targetValues?.fat || 0, radius: maxRadius - ringWidth - gap, color: 'rgba(255, 193, 7, 0.8)', excessColor: 'rgba(200, 150, 0, 0.8)' },
        { name: 'Protein', value: data.protein, actual: actualValues?.protein || 0, target: targetValues?.protein || 0, radius: maxRadius - 2 * (ringWidth + gap), color: 'rgba(0, 123, 255, 0.8)', excessColor: 'rgba(0, 80, 200, 0.8)' },
        { name: 'Karb.', value: data.carbs, actual: actualValues?.carbs || 0, target: targetValues?.carbs || 0, radius: maxRadius - 3 * (ringWidth + gap), color: 'rgba(220, 53, 69, 0.8)', excessColor: 'rgba(180, 30, 40, 0.8)' }
    ];

    function drawRing(context, value, radius, color, excessColor, centerX, centerY, ringWidth) {
        const startAngle = -Math.PI / 2;
        const maxAngle = 2 * Math.PI;
        let fillAngle = maxAngle * Math.min(value, 1);
        context.beginPath();
        context.arc(centerX, centerY, radius, startAngle, startAngle + fillAngle);
        context.lineWidth = ringWidth;
        context.strokeStyle = color;
        context.stroke();
        if (value > 1) {
            const excessAngle = maxAngle * (value - 1);
            context.beginPath();
            context.arc(centerX, centerY, radius, startAngle, startAngle + excessAngle);
            context.lineWidth = ringWidth;
            context.strokeStyle = excessColor;
            context.stroke();
        }
    }

    rings.forEach(ring => drawRing(ctx, ring.value, ring.radius, ring.color, ring.excessColor, centerX, centerY, ringWidth));

    if (!actualValues || !targetValues) {
        return;
    }

    let tooltip = document.getElementById(`${canvasId}-tooltip`);
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = `${canvasId}-tooltip`;
        tooltip.className = 'macro-tooltip';
        document.body.appendChild(tooltip);
    }

    const addTooltipListeners = (targetCanvas, targetRings, targetCenterX, targetCenterY, targetRingWidth) => {
        targetCanvas.addEventListener('mousemove', (e) => {
            const rect = targetCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const dx = x - targetCenterX;
            const dy = y - targetCenterY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            let activeRing = null;
            for (const ring of targetRings) {
                const outerRadius = ring.radius + targetRingWidth / 2;
                const innerRadius = ring.radius - targetRingWidth / 2;
                if (distance >= innerRadius && distance <= outerRadius) {
                    activeRing = ring;
                    break;
                }
            }

            if (activeRing && activeRing.actual !== undefined && activeRing.target !== undefined) {
                const difference = activeRing.actual - activeRing.target;
                tooltip.innerHTML = `${activeRing.name}: ${activeRing.actual.toFixed(0)} / ${activeRing.target.toFixed(0)} (Fark: ${difference.toFixed(0)})`;
                tooltip.style.display = 'block';
                tooltip.style.left = `${e.clientX + 10}px`;
                tooltip.style.top = `${e.clientY + 10}px`;
            } else {
                tooltip.style.display = 'none';
            }
        });

        targetCanvas.addEventListener('mouseout', () => {
            tooltip.style.display = 'none';
        });
    };

    addTooltipListeners(canvas, rings, centerX, centerY, ringWidth);

    canvas.addEventListener('click', () => {
        const modal = document.getElementById('macroModal');
        const modalTitle = document.getElementById('macroModalTitle');
        const modalChart = document.getElementById('macroModalChart');
        const modalAnalysis = document.getElementById('macroModalAnalysis');
        if (!modal || !modalTitle || !modalChart || !modalAnalysis) {
            console.error('Modal elements not found:', { modal, modalTitle, modalChart, modalAnalysis });
            return;
        }

        // Popup canvas’inin boyutlarını açıkça ayarla (kare olacak şekilde)
        modalChart.width = 300;
        modalChart.height = 300;
        const modalCtx = modalChart.getContext('2d');
        console.log(`Popup canvas dimensions: ${modalChart.width}x${modalChart.height}`);

        modalTitle.textContent = title || 'Makro Grafiği';

        modalCtx.clearRect(0, 0, modalChart.width, modalChart.height);
        const modalCenterX = modalChart.width / 2;
        const modalCenterY = modalChart.height / 2;
        const modalMaxRadius = Math.min(modalChart.width, modalChart.height) * 0.4;
        const modalRingWidth = modalMaxRadius * 0.2;
        const modalGap = 2;

        const modalRings = [
            { name: 'Kalori', value: data.calories, actual: actualValues?.calories || 0, target: targetValues?.calories || 0, radius: modalMaxRadius, color: 'rgba(40, 167, 69, 0.8)', excessColor: 'rgba(20, 120, 40, 0.8)' },
            { name: 'Yağ', value: data.fat, actual: actualValues?.fat || 0, target: targetValues?.fat || 0, radius: modalMaxRadius - modalRingWidth - modalGap, color: 'rgba(255, 193, 7, 0.8)', excessColor: 'rgba(200, 150, 0, 0.8)' },
            { name: 'Protein', value: data.protein, actual: actualValues?.protein || 0, target: targetValues?.protein || 0, radius: modalMaxRadius - 2 * (modalRingWidth + modalGap), color: 'rgba(0, 123, 255, 0.8)', excessColor: 'rgba(0, 80, 200, 0.8)' },
            { name: 'Karb.', value: data.carbs, actual: actualValues?.carbs || 0, target: targetValues?.carbs || 0, radius: modalMaxRadius - 3 * (modalRingWidth + modalGap), color: 'rgba(220, 53, 69, 0.8)', excessColor: 'rgba(180, 30, 40, 0.8)' }
        ];

        modalRings.forEach(ring => {
            console.log('Drawing popup ring:', ring);
            drawRing(modalCtx, ring.value, ring.radius, ring.color, ring.excessColor, modalCenterX, modalCenterY, modalRingWidth);
        });

        addTooltipListeners(modalChart, modalRings, modalCenterX, modalCenterY, modalRingWidth);

        let day = null;
        try {
            day = title.includes('Günlük') && title.match(/\(([^)]+)\)/) ? title.match(/\(([^)]+)\)/)[1] : null;
        } catch (error) {
            console.error('Error extracting day from title:', title, error);
            day = 'Bilinmeyen Gün';
        }

        const analysisText = generateAnalysisText(type, day, actualValues, targetValues, weeklyData);
        console.log('Generated Analysis Text:', analysisText);
        modalAnalysis.innerHTML = analysisText || '<p>Analiz metni oluşturulamadı.</p>';

        modal.style.display = 'flex';

        const closeBtn = document.querySelector('.macro-modal-close');
        if (closeBtn) {
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
        }

        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    });
}
function showNotification(message, type = 'success', duration = 5000) {
    const notification = document.getElementById('notification');
    notification.className = `alert alert-${type}`;
    notification.innerHTML = message.replace(/\n/g, '<br>');
    notification.style.display = 'block';
    setTimeout(() => { notification.style.display = 'none'; }, duration);
}

        function handlePatientChange() {
            currentPatient = document.getElementById('patientSelect').value;
            loadPatientData();
            loadCategories();
            calculateMacros();
            renderMeals();
        }

        function loadPatientData() {
            if (!currentPatient) return;
            const patientData = JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}');
            document.getElementById('likedFoodsDisplay').value = patientData.likedFoods ? patientData.likedFoods.join(', ') : '';
            document.getElementById('dislikedFoodsDisplay').value = patientData.dislikedFoods ? patientData.dislikedFoods.join(', ') : '';
            document.getElementById('likedFoods').innerHTML = patientData.likedFoods ? `Sevdiği: ${patientData.likedFoods.join(', ')}` : '';
            document.getElementById('dislikedFoods').innerHTML = patientData.dislikedFoods ? `Sevmediği: ${patientData.dislikedFoods.join(', ')}` : '';
        }

        function updatePatientPreferences() {
            if (!currentPatient) return;
            const likedFoods = document.getElementById('likedFoodsDisplay').value.split(',').map(f => f.trim()).filter(f => f);
            const dislikedFoods = document.getElementById('dislikedFoodsDisplay').value.split(',').map(f => f.trim()).filter(f => f);
            const patientData = JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}');
            patientData.likedFoods = likedFoods;
            patientData.dislikedFoods = dislikedFoods;
            localStorage.setItem(`patient_${currentPatient}`, JSON.stringify(patientData));
            loadPatientData();
            loadCategories();
            showNotification("Hasta tercihleri güncellendi!");
        }

        function addPatient() {
            const name = prompt("Hasta adı girin:");
            if (!name) return;
            currentPatient = name;
            localStorage.setItem(`patient_${name}`, JSON.stringify({ name, likedFoods: [], dislikedFoods: [], weight: 70, activity: 3 }));
            loadPatientSelect();
            document.getElementById('patientSelect').value = name;
            handlePatientChange();
            showNotification("Yeni hasta eklendi!");
        }

        function editPatient() {
            if (!currentPatient) {
                showNotification("Önce bir hasta seçin!", 'warning');
                return;
            }
            const patientData = JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}');
            const name = prompt("Yeni hasta adı:", currentPatient);
            if (!name) return;
            const weight = prompt("Kilo (kg):", patientData.weight || 70);
            const activity = prompt("Aktivite Seviyesi (1-5):", patientData.activity || 3);
            if (name !== currentPatient) {
                localStorage.removeItem(`patient_${currentPatient}`);
            }
            localStorage.setItem(`patient_${name}`, JSON.stringify({
                name,
                likedFoods: patientData.likedFoods || [],
                dislikedFoods: patientData.dislikedFoods || [],
                weight: parseFloat(weight) || 70,
                activity: parseInt(activity) || 3
            }));
            currentPatient = name;
            loadPatientSelect();
            document.getElementById('patientSelect').value = name;
            handlePatientChange();
            showNotification("Hasta bilgileri güncellendi!");
        }

        function deletePatient() {
            if (!currentPatient) {
                showNotification("Önce bir hasta seçin!", 'warning');
                return;
            }
            if (confirm(`${currentPatient} adlı hastayı silmek istiyor musunuz?`)) {
                localStorage.removeItem(`patient_${currentPatient}`);
                currentPatient = null;
                loadPatientSelect();
                document.getElementById('patientSelect').value = '';
                handlePatientChange();
                showNotification("Hasta silindi!");
            }
        }

        function loadPatientSelect() {
            const patientSelect = document.getElementById('patientSelect');
            const patients = Object.keys(localStorage).filter(key => key.startsWith('patient_')).map(key => key.replace('patient_', ''));
            patientSelect.innerHTML = '<option value="">Hasta Seç</option>' + patients.map(p => `<option value="${p}">${p}</option>`).join('');
        }

        function handleUserFormSubmit(event) {
            event.preventDefault();
            const name = document.getElementById('userName').value;
            const weight = parseFloat(document.getElementById('userWeight').value);
            const activity = parseInt(document.getElementById('userActivity').value);
            const likedFoods = document.getElementById('likedFoodsInput').value.split(',').map(f => f.trim()).filter(f => f);
            const dislikedFoods = document.getElementById('dislikedFoodsInput').value.split(',').map(f => f.trim()).filter(f => f);

            localStorage.setItem(`patient_${name}`, JSON.stringify({ name, weight, activity, likedFoods, dislikedFoods }));
            currentPatient = name;
            loadPatientSelect();
            document.getElementById('patientSelect').value = name;
            switchMode('admin');
            handlePatientChange();
            showNotification("Kullanıcı profili kaydedildi!");
        }

        function exportAllData() {
            const data = {
                categories,
                weeks,
                rules,
                mealTemplates,
                compatibilityTable,
                patients: Object.keys(localStorage).filter(key => key.startsWith('patient_'))
                    .reduce((obj, key) => {
                        obj[key] = JSON.parse(localStorage.getItem(key));
                        return obj;
                    }, {})
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nutrition_plan.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification("Veriler dışa aktarıldı!");
        }

        function importAllData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);

            // Kategorileri yükle
            categories.length = 0;
            categories.push(...data.categories);

            // Haftaları yükle
            weeks.length = 0;
            weeks.push(...data.weeks);

            // Kuralları yükle ve eksik alanları tamamla
            rules.length = 0;
            rules.push(...data.rules.map(rule => {
                if (rule.type === 'frequency') {
                    rule.criteria = rule.criteria || {}; // criteria yoksa boş nesne
                } else if (rule.type === 'pairWith' || rule.type === 'avoidPair') {
                    rule.criteria1 = rule.criteria1 || {}; // criteria1 yoksa boş nesne
                    rule.criteria2 = rule.criteria2 || {}; // criteria2 yoksa boş nesne
                }
                return rule;
            }));
            console.log('Yüklenen kurallar:', rules);
            // Diğer verileri yükle
            mealTemplates.length = 0;
            mealTemplates.push(...data.mealTemplates);
            compatibilityTable.length = 0;
            compatibilityTable.push(...data.compatibilityTable);
            Object.entries(data.patients).forEach(([key, value]) => localStorage.setItem(key, JSON.stringify(value)));

            // Arayüzü güncelle
            loadCategories();
            renderWeekTabs();
            renderDayTabs();
            renderMeals();
            loadPatientSelect();
            loadRules();
            loadMealTemplates();
            loadCompatibilityRules();
            calculateMacros();
            showNotification("Veriler içe aktarıldı!");
        } catch (error) {
            console.error('Dosya yüklenirken hata:', error);
            showNotification('Geçersiz dosya formatı!', 'danger');
        }
    };
    reader.readAsText(file);
}

        function exportToTXT() {
            let txtContent = "";
            weeks.forEach((week, wIndex) => {
                txtContent += `Hafta ${wIndex + 1}\n`;
                Object.entries(week.days).forEach(([day, dayData]) => {
                    txtContent += `  ${day.charAt(0).toUpperCase() + day.slice(1)}:\n`;
                    Object.entries(dayData.meals).forEach(([mealType, items]) => {
                        txtContent += `    ${mealType.charAt(0).toUpperCase() + mealType.slice(1)}:\n`;
                        items.forEach(item => {
                            const food = findFood(item.name);
                            txtContent += `      - ${item.name} (${item.quantity || 1}x): ${food.calories * (item.quantity || 1)} kcal, ${food.protein * (item.quantity || 1)}g protein, ${food.carbs * (item.quantity || 1)}g karb, ${food.fat * (item.quantity || 1)}g yağ\n`;
                        });
                    });
                });
                txtContent += "\n";
            });
            const blob = new Blob([txtContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nutrition_plan.txt';
            a.click();
            URL.revokeObjectURL(url);
            showNotification("TXT olarak dışa aktarıldı!");
        }
function exportTemplatesToTXT() {
    let txtContent = "Öğün Şablonları\n\n";
    mealTemplates.forEach((template, index) => {
        txtContent += `Şablon ${index + 1}: ${template.mealType} (Haftada ${template.frequency} Gün)\n`;
        template.items.forEach(item => {
            txtContent += `  - ${item.keyword} (${item.role}, ${item.quantity}x)\n`;
        });
        txtContent += "\n";
    });
    const blob = new Blob([txtContent], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'meal_templates.txt';
    a.click();
    URL.revokeObjectURL(url);
    showNotification("Şablonlar TXT olarak dışa aktarıldı!");
}
function importTemplatesFromTXT(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const lines = e.target.result.split('\n');
        let newTemplates = [];
        let currentTemplate = null;

        lines.forEach(line => {
            line = line.trim();
            if (!line) return;

            // Şablon başlığını algıla
            if (line.startsWith('Şablon')) {
                if (currentTemplate) newTemplates.push(currentTemplate);
                const match = line.match(/Şablon \d+: (\w+) \(Haftada (\d+) Gün\)/);
                if (match) {
                    currentTemplate = {
                        mealType: match[1],
                        frequency: parseInt(match[2]),
                        items: []
                    };
                }
            }
            // Öğeleri algıla
            else if (line.startsWith('-') && currentTemplate) {
                const itemMatch = line.match(/- (.+) \((\w+), (\d+)x\)/);
                if (itemMatch) {
                    currentTemplate.items.push({
                        keyword: itemMatch[1],
                        role: itemMatch[2],
                        quantity: parseInt(itemMatch[3])
                    });
                }
            }
        });
        if (currentTemplate) newTemplates.push(currentTemplate);

        // Mevcut şablonlarla çakışmaları kontrol et
        let addedCount = 0;
        newTemplates.forEach(newTemplate => {
            const isDuplicate = mealTemplates.some(existing => 
                existing.mealType === newTemplate.mealType &&
                existing.frequency === newTemplate.frequency &&
                existing.items.length === newTemplate.items.length &&
                existing.items.every((item, i) => 
                    item.keyword === newTemplate.items[i].keyword &&
                    item.role === newTemplate.items[i].role &&
                    item.quantity === newTemplate.items[i].quantity
                )
            );
            if (!isDuplicate) {
                mealTemplates.push(newTemplate);
                addedCount++;
            }
        });

        loadMealTemplates();
        showNotification(`${addedCount} yeni şablon eklendi! (Tekrarlananlar eklenmedi)`);
    };
    reader.readAsText(file);
}
        function importFromTXT(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                let currentCategory = null;
                lines.forEach(line => {
                    line = line.trim();
                    if (!line || line.startsWith('-')) return;
                    if (line.match(/^[A-ZÇĞİÖŞÜ]+$/)) {
                        currentCategory = line;
                        if (!categories.some(cat => cat.name === currentCategory)) {
                            categories.push({ name: currentCategory, items: [] });
                        }
                    } else if (line.includes(':')) {
                        const [name, details] = line.split(':');
                        const [calories, protein, carbs, fat] = details.match(/[\d.]+/g).map(Number);
                        const category = categories.find(cat => cat.name === currentCategory);
                        if (category) {
                            category.items.push({
                                name: name.trim(),
                                calories,
                                protein,
                                carbs,
                                fat,
                                maxQuantity: 1,
                                tags: [],
                                role: "mainDish",
                                mealType: "breakfast,lunch,dinner",
                                keto: dietMode === 'keto',
                                lowcarb: true
                            });
                        }
                    }
                });
                loadCategories();
                showNotification("TXT'dan yemekler eklendi!");
            };
            reader.readAsText(file);
        }

        function clearCache() {
            localStorage.clear();
            currentPatient = null;
            weeks.length = 0;
            initializeWeeks();
            loadPatientSelect();
            loadCategories();
            renderWeekTabs();
            renderDayTabs();
            renderMeals();
            calculateMacros();
            showNotification("Cache temizlendi!");
        }

        // addRule fonksiyonu
// addRule fonksiyonu
function addRule() {
    console.log("addRule fonksiyonu çağrıldı!");

    const frequencyForm = document.getElementById('frequencyRuleForm');
    const dependOnForm = document.getElementById('dependOnRuleForm');
    let activeForm = null;
    let ruleType = null;

    if (frequencyForm && frequencyForm.style.display !== 'none') {
        activeForm = frequencyForm;
        ruleType = 'frequency';
    } else if (dependOnForm && dependOnForm.style.display !== 'none') {
        activeForm = dependOnForm;
        ruleType = 'dependOn';
    } else {
        console.warn("Hiçbir kural formu aktif değil!");
        return;
    }

    const editIndex = activeForm.dataset.editIndex;
    const isEditing = editIndex !== undefined && editIndex !== '' && rules[editIndex];

    let rule = { type: ruleType };

    if (isEditing) {
        rule.id = rules[editIndex].id;
        if (!rule.id) {
            console.warn(`Düzenlenen kuralda ID eksik, index: ${editIndex}`, rules[editIndex]);
            rule.id = Math.max(...rules.map(r => r.id || 0)) + 1;
        }
    } else {
        const maxId = rules.length > 0 ? Math.max(...rules.map(r => r.id || 0)) : 0;
        rule.id = maxId + 1;
    }

    if (ruleType === 'frequency' && activeForm === frequencyForm) {
        rule.frequency = parseInt(document.getElementById('freqCount')?.value) || 1;
        rule.scope = document.getElementById('freqScope')?.value || 'meal';
        rule.frequencyType = document.getElementById('freqType')?.value || 'exact';
        rule.weekRange = document.getElementById('freqWeekRange')?.value.trim() || 'all';

        if (!['meal', 'day', 'week'].includes(rule.scope)) {
            console.warn(`Geçersiz scope değeri: ${rule.scope}. Varsayılan olarak 'meal' kullanılıyor.`);
            rule.scope = 'meal';
        }

        if (!['exact', 'min', 'max'].includes(rule.frequencyType)) {
            console.warn(`Geçersiz frequencyType değeri: ${rule.frequencyType}. Varsayılan olarak 'exact' kullanılıyor.`);
            rule.frequencyType = 'exact';
        }

        rule.nameCheck = document.getElementById('freqNameCheck')?.checked || false;
        const nameInput = document.getElementById('freqName')?.value.trim();
        if (rule.nameCheck && nameInput) {
            if (nameInput.includes(',,')) {
                rule.nameOperator = 'AND';
                rule.names = nameInput.split(',,').map(n => n.trim()).filter(n => n);
            } else if (nameInput.includes(';;')) {
                rule.nameOperator = 'OR';
                rule.names = nameInput.split(';;').map(n => n.trim()).filter(n => n);
            } else {
                rule.nameOperator = 'OR';
                rule.names = [nameInput];
            }
            delete rule.name;
        } else {
            rule.names = [];
        }

        rule.tagsCheck = document.getElementById('freqTagCheck')?.checked || false;
        const tagInput = document.getElementById('freqTag')?.value.trim();
        if (rule.tagsCheck && tagInput) {
            if (tagInput.includes(',,')) {
                rule.tagOperator = 'AND';
                rule.tags = tagInput.split(',,').map(t => t.trim()).filter(t => t);
            } else if (tagInput.includes(';;')) {
                rule.tagOperator = 'OR';
                rule.tags = tagInput.split(';;').map(t => t.trim()).filter(t => t);
            } else {
                rule.tagOperator = 'AND';
                rule.tags = tagInput.split(',').map(t => t.trim()).filter(t => t);
            }
        } else {
            rule.tags = [];
        }

        rule.roleCheck = document.getElementById('freqRoleCheck')?.checked || false;
        rule.role = rule.roleCheck ? document.getElementById('freqRole')?.value : '';

        rule.catCheck = document.getElementById('freqCatCheck')?.checked || false;
        rule.category = rule.catCheck ? document.getElementById('freqCat')?.value : '';

        rule.mealTypeCheck = rule.scope === 'meal';
        rule.mealType = rule.mealTypeCheck ? document.getElementById('freqMeal')?.value : '';

        console.log("Oluşturulan/Güncellenen kural (frequency):", JSON.stringify(rule, null, 2));
        if (!rule.nameCheck && !rule.tagsCheck && !rule.roleCheck && !rule.catCheck) {
            showNotification("Hata: Frequency kuralı için isim, etiket, rol veya kategoriden en az biri belirtilmeli!", "error");
            console.log("Hata: Hiçbir kriter seçilmedi.");
            return;
        }
    } else if (ruleType === 'dependOn' && activeForm === dependOnForm) {
        rule.food = document.getElementById('dependOnFood')?.value.trim();
        rule.requiredFood = document.getElementById('dependOnRequiredFood')?.value.trim();
        rule.scope = document.getElementById('dependOnScope')?.value || 'meal';

        if (!['meal', 'day'].includes(rule.scope)) {
            console.warn(`Geçersiz scope değeri: ${rule.scope}. Varsayılan olarak 'meal' kullanılıyor.`);
            rule.scope = 'meal';
        }

        if (!rule.food || !rule.requiredFood) {
            showNotification("Hata: DependOn kuralı için hem yemek hem de gerekli yemek belirtilmeli!", "error");
            console.log("Hata: Eksik yemek bilgisi.");
            return;
        }

        console.log("Oluşturulan/Güncellenen kural (dependOn):", JSON.stringify(rule, null, 2));
    } else {
        console.warn(`Desteklenmeyen kural tipi: ${ruleType}`);
        return;
    }

    if (isEditing) {
        rules[editIndex] = rule;
        showNotification(`Kural (${rule.id}) güncellendi!`, "success");
    } else {
        rules.push(rule);
        showNotification(`Kural (${rule.id}) eklendi!`, "success");
    }

    loadRules();
    activeForm.style.display = 'none';
    delete activeForm.dataset.editIndex;
}

// handleRuleSave fonksiyonu
function handleRuleSave() {
    addRule();
}


// loadRules fonksiyonu
function loadRules() {
    const rulesList = document.getElementById('rulesList');
    if (!rulesList) {
        console.warn("rulesList elementi bulunamadı.");
        return;
    }

    rulesList.innerHTML = rules.map((rule, index) => {
        let description = '';
        switch (rule.type) {
            case 'frequency':
                const criteriaText = [];
                if (rule.nameCheck && rule.names?.length) {
                    const connector = rule.nameOperator === 'OR' ? 'veya' : 've';
                    criteriaText.push(`İsim: ${rule.names.join(` ${connector} `)}`);
                } else if (rule.nameCheck && rule.name) { // Eski format için geri uyumluluk
                    criteriaText.push(`İsim: ${rule.name}`);
                }
                if (rule.tagsCheck && rule.tags?.length) {
                    const connector = rule.tagOperator === 'OR' ? 'veya' : 've';
                    criteriaText.push(`Etiket: ${rule.tags.join(` ${connector} `)}`);
                }
                if (rule.roleCheck && rule.role) criteriaText.push(`Rol: ${rule.role}`);
                if (rule.catCheck && rule.category) criteriaText.push(`Kategori: ${rule.category}`);
                const criteriaDisplay = criteriaText.length ? criteriaText.join(', ') : 'Herhangi bir yemek';
                const scopeText = rule.scope === 'meal' ? `her ${rule.mealType}` :
                                 rule.scope === 'day' ? 'günde' :
                                 'haftada';
                const frequencyText = rule.frequencyType === 'min' ? 'en az' :
                                     rule.frequencyType === 'max' ? 'en fazla' :
                                     ''; // 'exact' için ek metin yok
                description = `(${rule.id}) ${criteriaDisplay} ${scopeText} ${frequencyText} ${rule.frequency} kez`.trim();
                break;
            case 'pairWith':
            case 'avoidPair':
                const pairText = rule.type === 'pairWith' ? 'birlikte olsun' : 'birlikte olmasın';
                const scopePairText = rule.scope === 'meal' ? `her ${rule.meal}` :
                                     rule.scope === 'day' ? 'günde' :
                                     'haftada';
                description = `(${rule.id}) ${rule.pair1Name} ile ${rule.pair2Name} ${scopePairText} ${pairText}`;
                break;
            case 'dependOn':
                const dependScopeText = rule.scope === 'meal' ? 'her öğünde' : 'her gün';
                description = `(${rule.id}) ${rule.food} yalnızca ${rule.requiredFood} ile ${dependScopeText} eklensin`;
                break;
            case 'categoryLock':
                const lockScopeText = rule.scope === 'week' ? 'hafta boyunca' : 'her zaman';
                description = `(${rule.id}) ${rule.category} kategorisinde ${lockScopeText} sadece ${rule.item} kullanılsın`;
                break;
            default:
                description = `(${rule.id}) Bilinmeyen kural tipi: ${rule.type}`;
                console.warn(`Bilinmeyen kural tipi: ${JSON.stringify(rule)}`);
        }
        if (rule.weekRange && rule.weekRange !== 'all') {
            description += ` [Hafta ${rule.weekRange}]`;
        }
        return `
            <div class="mb-1 d-flex justify-content-between align-items-center">
                <span>${description}</span>
                <div>
                    <button class="btn btn-warning btn-sm me-1" onclick="editRule(${index})" title="Düzenle"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRule(${index})" title="Sil"><i class="bi bi-trash"></i></button>
                </div>
            </div>
        `;
    }).join('');
}

// editRule fonksiyonu
function editRule(index) {
    const rule = rules[index];
    if (!rule) {
        console.warn(`Düzenlenecek kural bulunamadı, index: ${index}`);
        return;
    }

    if (rule.type === 'frequency') {
        const form = document.getElementById('frequencyRuleForm');
        form.style.display = 'block';
        document.getElementById('freqCount').value = rule.frequency || 1;
        document.getElementById('freqScope').value = rule.scope || 'meal';
        document.getElementById('freqType').value = rule.frequencyType || 'exact';
        document.getElementById('freqWeekRange').value = rule.weekRange === 'all' ? '' : rule.weekRange;
        document.getElementById('freqNameCheck').checked = rule.nameCheck || false;
        document.getElementById('freqName').value = rule.name || '';
        document.getElementById('freqName').disabled = !rule.nameCheck;
        document.getElementById('freqTagCheck').checked = rule.tagsCheck || false;
        document.getElementById('freqTag').value = rule.tags?.join(', ') || '';
        document.getElementById('freqTag').disabled = !rule.tagsCheck;
        document.getElementById('freqRoleCheck').checked = rule.roleCheck || false;
        document.getElementById('freqRole').value = rule.role || '';
        document.getElementById('freqRole').disabled = !rule.roleCheck;
        document.getElementById('freqCatCheck').checked = rule.catCheck || false;
        document.getElementById('freqCat').value = rule.category || '';
        document.getElementById('freqCat').disabled = !rule.catCheck;
        document.getElementById('freqMeal').style.display = rule.scope === 'meal' ? 'inline-block' : 'none';
        document.getElementById('freqMeal').value = rule.mealType || 'breakfast';
        form.dataset.editIndex = index;
    } else if (rule.type === 'dependOn') {
        const form = document.getElementById('dependOnRuleForm');
        form.style.display = 'block';
        document.getElementById('dependOnFood').value = rule.food || '';
        document.getElementById('dependOnRequiredFood').value = rule.requiredFood || '';
        document.getElementById('dependOnScope').value = rule.scope || 'meal';
        form.dataset.editIndex = index;
    }

    // Checkbox olay dinleyicileri (frequency için)
    toggleInput('freqNameCheck', 'freqName');
    toggleInput('freqTagCheck', 'freqTag');
    toggleInput('freqRoleCheck', 'freqRole');
    toggleInput('freqCatCheck', 'freqCat');
}

function toggleInput(checkboxId, inputId) {
    const checkbox = document.getElementById(checkboxId);
    const input = document.getElementById(inputId);
    if (checkbox && input) {
        input.disabled = !checkbox.checked;
        checkbox.addEventListener('change', () => {
            input.disabled = !checkbox.checked;
        });
    }
}

// saveEditedRule fonksiyonu
function saveEditedRule(event) {
    event.preventDefault();

    const indexField = document.getElementById('editRuleIndex');
    const isEditMode = indexField.value !== '';
    const index = parseInt(indexField.value);

    const rule = {
        type: 'frequency',
        frequency: parseInt(document.getElementById('freqCount').value) || 1,
        scope: document.getElementById('freqScope').value,
        weekRange: document.getElementById('freqWeekRange').value
    };

    rule.nameCheck = document.getElementById('freqNameCheck').checked;
    rule.name = rule.nameCheck ? document.getElementById('freqName').value.trim() : '';
    rule.tagsCheck = document.getElementById('freqTagCheck').checked;
    rule.tags = rule.tagsCheck ? document.getElementById('freqTag').value.split(',').map(t => t.trim()).filter(t => t) : [];
    rule.roleCheck = document.getElementById('freqRoleCheck').checked;
    rule.role = rule.roleCheck ? document.getElementById('freqRole').value : '';
    rule.catCheck = document.getElementById('freqCatCheck').checked;
    rule.category = rule.catCheck ? document.getElementById('freqCat').value : '';
    rule.mealTypeCheck = rule.scope === 'meal';
    rule.mealType = rule.mealTypeCheck ? document.getElementById('freqMeal').value : '';

    if (isEditMode) {
        rules[index] = rule;
        showNotification("Kural güncellendi!", "success");
        console.log("Güncellenen kural:", JSON.stringify(rule, null, 2));
    } else {
        rules.push(rule);
        showNotification("Yeni kural eklendi!", "success");
        console.log("Eklenen kural:", JSON.stringify(rule, null, 2));
    }

    loadRules();
    cancelEditRule();
}

// handleRuleSave fonksiyonu
function handleRuleSave() {
    const indexValue = document.getElementById('editRuleIndex').value;
    if (indexValue !== '') {
        saveEditedRule(new Event('submit'));
    } else {
        addRule();
    }
}

// Diğer yardımcı fonksiyonlar
function cancelEditRule() {
    document.getElementById('editRuleForm').style.display = 'none';
    document.getElementById('frequencyRuleForm').style.display = 'none';

    const addRuleButton = document.getElementById('addRuleButton');
    if (addRuleButton) addRuleButton.textContent = "Kural Ekle";
    else console.warn("addRuleButton bulunamadı.");
}

function deleteRule(index) {
    rules.splice(index, 1);
    loadRules();
    showNotification("Kural silindi!", "success");
}

function populateCategoryDropdown() {
    const catSelect = document.getElementById('freqCat');
    if (!catSelect) return console.error("freqCat bulunamadı!");
    catSelect.innerHTML = '<option value="">Seç</option>';
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.name;
        option.textContent = category.name;
        catSelect.appendChild(option);
    });
}

function openFrequencyRuleForm() {
    const form = document.getElementById('frequencyRuleForm');
    form.style.display = 'block';

    document.getElementById('freqName').value = '';
    document.getElementById('freqTag').value = '';
    document.getElementById('freqCount').value = 1;
    document.getElementById('freqWeekRange').value = '';
    document.getElementById('freqScope').value = 'week';
    document.getElementById('freqMeal').value = 'lunch';
    document.getElementById('freqNameCheck').checked = false;
    document.getElementById('freqTagCheck').checked = false;
    document.getElementById('freqRoleCheck').checked = false;
    document.getElementById('freqCatCheck').checked = false;
    document.getElementById('freqName').disabled = true;
    document.getElementById('freqTag').disabled = true;
    document.getElementById('freqRole').disabled = true;
    document.getElementById('freqCat').disabled = true;

    populateCategoryDropdown();
    
    const addRuleButton = document.getElementById('addRuleButton');
    if (addRuleButton) addRuleButton.textContent = "Kural Ekle";
}

function toggleInput(checkboxId, inputId) {
    const checkbox = document.getElementById(checkboxId);
    const input = document.getElementById(inputId);
    if (checkbox && input) {
        checkbox.addEventListener('change', function() {
            input.disabled = !this.checked;
        });
    }
}

function toggleMealSelect(scopeId, mealId) {
    const scopeSelect = document.getElementById(scopeId);
    const mealSelect = document.getElementById(mealId);
    if (scopeSelect && mealSelect) {
        mealSelect.style.display = scopeSelect.value === 'meal' ? 'inline' : 'none';
        scopeSelect.addEventListener('change', function() {
            mealSelect.style.display = this.value === 'meal' ? 'inline' : 'none';
        });
    }
}

// Event Listener'lar ve Başlatma
document.getElementById('freqNameCheck').addEventListener('change', function() {
    document.getElementById('freqName').disabled = !this.checked;
});
document.getElementById('freqScope').addEventListener('change', function() {
    document.getElementById('freqMeal').style.display = this.value === 'meal' ? 'block' : 'none';
});

toggleInput('freqNameCheck', 'freqName');
toggleInput('freqTagCheck', 'freqTag');
toggleInput('freqRoleCheck', 'freqRole');
toggleInput('freqCatCheck', 'freqCat');
toggleInput('pair1NameCheck', 'pair1Name');
toggleInput('pair2NameCheck', 'pair2Name');

toggleMealSelect('freqScope', 'freqMeal');
toggleMealSelect('pairScope', 'pairMeal');

initializeWeeks();
loadCategories();
renderWeekTabs();
renderDayTabs();
renderMeals();
loadPatientSelect();
loadRules();
loadMealTemplates();
loadCompatibilityRules();
loadSettingsTemplates();
loadRuleTemplates();
calculateMacros();
searchEditFood('');
updateRuleForm();

// Eklenmesi gereken satırlar
toggleMealSelect('freqScope', 'freqMeal'); // Sıklık Kuralı için ilk durumu ayarla
toggleMealSelect('pairScope', 'pairMeal'); // Birliktelik Kuralı için ilk durumu ayarla
function updateRuleForm(isEdit = false) {
    const type = isEdit ? document.getElementById('editRuleType').value : document.getElementById('ruleType').value;

    // Tüm formları önce gizle
    document.getElementById('frequencyRuleForm').style.display = 'none';
    document.getElementById('defaultRuleForm').style.display = 'none';
    document.getElementById('pairRuleForm').style.display = 'none';
    document.getElementById('dependOnRuleForm').style.display = 'none';
    document.getElementById('categoryLockRuleForm').style.display = 'none';

    // Seçilen kural türüne göre ilgili formu göster
    if (type === 'frequency') {
        document.getElementById('frequencyRuleForm').style.display = 'block';
    } else if (type === 'pairWith' || type === 'avoidPair') {
        document.getElementById('pairRuleForm').style.display = 'block';
    } else if (type === 'dependOn') {
        document.getElementById('dependOnRuleForm').style.display = 'block';
    } else if (type === 'categoryLock') {
        document.getElementById('categoryLockRuleForm').style.display = 'block';
    }
}

    // Tüm formları varsayılan olarak gizle
    defaultForm.style.display = 'none';
    frequencyForm.style.display = 'none';
    pairForm.style.display = 'none';
    dependOnForm.style.display = 'none'; // Yeni eklenen
    categoryLockForm.style.display = 'none'; // Yeni eklenen

    // Seçilen türe göre doğru formu göster
    if (type === 'frequency') {
        frequencyForm.style.display = 'block';
    } else if (type === 'pairWith' || type === 'avoidPair') {
        pairForm.style.display = 'block';
    } else if (type === 'dependOn') { // Yeni eklenen: Bağımlı Olsun kuralı
        dependOnForm.style.display = 'block';
    } else if (type === 'categoryLock') { // Yeni eklenen: Kategori Kilidi kuralı
        categoryLockForm.style.display = 'block';
    } else {
        defaultForm.style.display = 'block';
        frequencyInput.style.display = type === 'frequency' ? 'block' : 'none';
        countInput.style.display = 'none'; // Min ve Max kalktığı için hep gizli
        pairInput.style.display = ['pairWith', 'avoidPair'].includes(type) ? 'block' : 'none';
    }



function saveRuleTemplate() {
    const templateName = document.getElementById('templateName').value;
    if (!templateName) {
        showNotification("Şablon adı girin!", 'warning');
        return;
    }
    localStorage.setItem(`ruleTemplate_${templateName}`, JSON.stringify(rules));
    loadRuleTemplates();
    showNotification("Şablon kaydedildi!");
}























function loadRuleTemplates() {
    const templateSelect = document.getElementById('templateSelect');
    const templates = Object.keys(localStorage).filter(key => key.startsWith('ruleTemplate_')).map(key => key.replace('ruleTemplate_', ''));
    templateSelect.innerHTML = '<option value="">Şablon Yükle</option>' + templates.map(t => `<option value="${t}">${t}</option>`).join('');
}

function loadRuleTemplate() {
    const templateName = document.getElementById('templateSelect').value;
    if (!templateName) return;
    rules.length = 0;
    rules.push(...JSON.parse(localStorage.getItem(`ruleTemplate_${templateName}`) || '[]'));
    loadRules();
    showNotification("Şablon yüklendi!");
}

function deleteRuleTemplate() {
    const templateName = document.getElementById('templateSelect').value;
    if (!templateName) return;
    localStorage.removeItem(`ruleTemplate_${templateName}`);
    loadRuleTemplates();
    showNotification("Şablon silindi!");
}

function addCompatibilityRule() {
    const keyword1 = document.getElementById('compatKeyword1').value.trim();
    const keyword2Input = document.getElementById('compatKeyword2').value.trim();
    const degree = parseInt(document.getElementById('compatDegree').value);
    const conjunction = document.getElementById('compatConjunction').value;
    if (!keyword1) {
        showNotification("Lütfen birinci kelimeyi girin!", 'warning');
        return;
    }
    const keyword2 = keyword2Input ? keyword2Input.split(',').map(k => k.trim()).filter(k => k) : [];
    compatibilityTable.push({ keyword1, keyword2, degree, conjunction });
    loadCompatibilityRules();
    showNotification("Uyumluluk kuralı eklendi!");
}

function importFoodList() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const jsonData = JSON.parse(e.target.result);
            jsonData.categories.forEach(newCat => {
                let existingCat = categories.find(cat => cat.name === newCat.name);
                if (!existingCat) {
                    existingCat = { name: newCat.name, items: [] };
                    categories.push(existingCat);
                }
                newCat.items.forEach(newItem => {
                    const existingItem = existingCat.items.find(item => item.name === newItem.name);
                    if (!existingItem) {
                        existingCat.items.push(newItem);
                    }
                });
            });
            loadCategories();
            showNotification("Yemek listesi eklendi! Çakışanlar korunarak farklı olanlar eklendi.");
        };
        reader.readAsText(file);
    };
    input.click();
}

function exportFoodList() {
    const jsonContent = JSON.stringify({ categories: categories }, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'food_list.json';
    a.click();
    URL.revokeObjectURL(url);
    showNotification("Son yemek listesi JSON olarak dışa aktarıldı!");
}



        function loadCompatibilityRules() {
            const compatList = document.getElementById('compatibilityList');
            compatList.innerHTML = compatibilityTable.map((rule, index) => `
                <div class="mb-1 d-flex justify-content-between">
                    <span>${rule.keyword1} ↔ ${rule.keyword2.join(', ')} (${rule.degree})</span>
                    <button class="btn btn-danger btn-sm" onclick="deleteCompatibilityRule(${index})" title="Sil"><i class="bi bi-trash"></i></button>
                </div>
            `).join('');
        }

        function deleteCompatibilityRule(index) {
            compatibilityTable.splice(index, 1);
            loadCompatibilityRules();
            showNotification("Uyumluluk kuralı silindi!");
        }
        
        function addMealTemplate() {
            const mealType = document.getElementById('templateMealType').value;
            const frequency = parseInt(document.getElementById('templateFrequency').value);
            const items = [];
            const templateItems = document.getElementById('templateItems');
            const rows = templateItems.getElementsByClassName('row');
            for (let i = 0; i < rows.length; i++) {
                const keyword = document.getElementById(`templateItem${i + 1}Keyword`).value;
                const role = document.getElementById(`templateItem${i + 1}Role`).value;
                const quantity = parseInt(document.getElementById(`templateItem${i + 1}Quantity`).value);
                if (keyword) items.push({ keyword, role, quantity });
            }
            mealTemplates.push({ mealType, frequency, items });
            loadMealTemplates();
            templateItems.innerHTML = `
                <div class="row mb-1">
                    <div class="col-4">
                        <label for="templateItem1Keyword" class="form-label">Etiket</label>
                        <input type="text" id="templateItem1Keyword" class="form-control" placeholder="örn: yumurta, omlet">
                    </div>
                    <div class="col-4">
                        <label for="templateItem1Role" class="form-label">Rol</label>
                        <select id="templateItem1Role" class="form-select">
                            <option value="mainDish">Ana Yemek</option>
                            <option value="sideDish">Yan Yemek</option>
                            <option value="drink">İçecek</option>
                            <option value="soup">Çorba</option>
                            <option value="dessert">Tatlı</option>
                            <option value="fruit">Meyve</option>
                            <option value="bread">Ekmek</option>
                            <option value="snack">Atıştırmalık</option>
                            <option value="supplement">Ek</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <label for="templateItem1Quantity" class="form-label">Sayı</label>
                        <input type="number" id="templateItem1Quantity" class="form-control" value="1" min="1">
                    </div>
                </div>
            `;
            showNotification("Öğün şablonu eklendi!");
        }

        function addTemplateItem() {
            const templateItems = document.getElementById('templateItems');
            const itemCount = templateItems.getElementsByClassName('row').length + 1;
            templateItems.innerHTML += `
                <div class="row mb-1">
                    <div class="col-4">
                        <label for="templateItem${itemCount}Keyword" class="form-label">Etiket</label>
                        <input type="text" id="templateItem${itemCount}Keyword" class="form-control" placeholder="örn: yumurta, omlet">
                    </div>
                    <div class="col-4">
                        <label for="templateItem${itemCount}Role" class="form-label">Rol</label>
                        <select id="templateItem${itemCount}Role" class="form-select">
                            <option value="mainDish">Ana Yemek</option>
                            <option value="sideDish">Yan Yemek</option>
                            <option value="drink">İçecek</option>
                            <option value="soup">Çorba</option>
                            <option value="dessert">Tatlı</option>
                            <option value="fruit">Meyve</option>
                            <option value="bread">Ekmek</option>
                            <option value="snack">Atıştırmalık</option>
                            <option value="supplement">Ek</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <label for="templateItem${itemCount}Quantity" class="form-label">Sayı</label>
                        <input type="number" id="templateItem${itemCount}Quantity" class="form-control" value="1" min="1">
                    </div>
                </div>
            `;
        }

        function loadMealTemplates() {
    const templatesList = document.getElementById('mealTemplatesList');
    templatesList.innerHTML = mealTemplates.map((template, index) => `
        <div class="mb-1 d-flex justify-content-between">
            <span>${template.mealType} (${template.frequency}x): ${template.items.map(i => `${i.keyword} (${i.role})`).join(', ')}</span>
            <div>
                <button class="btn btn-success btn-sm" onclick="addTemplateToMeal(${index})" title="Öğüne Ekle">
    <i class="bi bi-plus-circle"></i>
</button>
                <button class="btn btn-warning btn-sm" onclick="editMealTemplate(${index})" title="Düzenle"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-danger btn-sm" onclick="deleteMealTemplate(${index})" title="Sil"><i class="bi bi-trash"></i></button>
            </div>
        </div>
    `).join('');
}

function addTemplateToMeal(index) {
    const template = mealTemplates[index];
    if (!template) {
        alert("Şablon bulunamadı!");
        return;
    }

    // Şablondaki öğeleri uygun öğüne ekleme işlemi
    template.items.forEach(item => {
        const food = findFood(item.keyword); // Yemeği bul
        if (food) {
            // Yemeği öğüne ekle
            weeks[selectedWeek - 1].days[selectedDay].meals[template.mealType].push({
                name: food.name,
                quantity: item.quantity
            });
        } else {
            console.error(`Yemek bulunamadı: ${item.keyword}`);
        }
    });

    // Öğünleri yeniden çiz ve makroları hesapla
    renderMeals();
    calculateMacros();
    showNotification("Şablon öğüne eklendi!");
}
function addTemplateToMeal(index) {
    const template = mealTemplates[index];
    if (!template) {
        alert("Şablon bulunamadı!");
        return;
    }

    // Şablondaki öğeleri uygun öğüne ekleme işlemi
    template.items.forEach(item => {
        const food = findFood(item.keyword); // Yemeği bul
        if (food) {
            // Yemeği öğüne ekle
            weeks[selectedWeek - 1].days[selectedDay].meals[template.mealType].push({
                name: food.name,
                quantity: item.quantity
            });
        } else {
            console.error(`Yemek bulunamadı: ${item.keyword}`);
        }
    });

    // Veri modelini kontrol etmek için konsola yazdır
    console.log("Güncellenmiş weeks dizisi:", weeks);

    // Öğünleri yeniden çiz ve makroları hesapla
    renderMeals();
    calculateMacros();
    showNotification("Şablon öğüne eklendi!");
}

// Şablondaki bir öğeyi ilgili öğüne ekleyen fonksiyon
function addMealItem(mealType, keyword, role, quantity) {
    const mealSection = document.getElementById(`${mealType}Meal`);
    if (!mealSection) {
        alert(`Öğün bölümü bulunamadı: ${mealType}`);
        return;
    }

    // Yeni yemek öğesi oluştur
    const mealItem = document.createElement("div");
    mealItem.classList.add("meal-item");
    mealItem.innerHTML = `${keyword} (${role}) - Miktar: ${quantity}`;

    // Öğüne DOM'a ekle
    mealSection.appendChild(mealItem);

    // Veri modeline de ekle
    weeks[selectedWeek - 1].days[selectedDay].meals[mealType].push({
        name: keyword,
        quantity: quantity
    });
}



        function editMealTemplate(index) {
            const template = mealTemplates[index];
            document.getElementById('editTemplateIndex').value = index;
            document.getElementById('editTemplateName').value = `${template.mealType}_${index}`;
            document.getElementById('editTemplateMealType').value = template.mealType;
            document.getElementById('editTemplateFrequency').value = template.frequency;
            const itemsDiv = document.getElementById('editTemplateItems');
            itemsDiv.innerHTML = template.items.map((item, i) => `
                <div class="row mb-1">
                    <div class="col-4">
                        <label for="editTemplateItem${i + 1}Keyword" class="form-label">Etiket</label>
                        <input type="text" id="editTemplateItem${i + 1}Keyword" class="form-control" value="${item.keyword}">
                    </div>
                    <div class="col-4">
                        <label for="editTemplateItem${i + 1}Role" class="form-label">Rol</label>
                        <select id="editTemplateItem${i + 1}Role" class="form-select">
                            <option value="mainDish" ${item.role === 'mainDish' ? 'selected' : ''}>Ana Yemek</option>
                            <option value="sideDish" ${item.role === 'sideDish' ? 'selected' : ''}>Yan Yemek</option>
                            <option value="drink" ${item.role === 'drink' ? 'selected' : ''}>İçecek</option>
                            <option value="soup" ${item.role === 'soup' ? 'selected' : ''}>Çorba</option>
                            <option value="dessert" ${item.role === 'dessert' ? 'selected' : ''}>Tatlı</option>
                            <option value="fruit" ${item.role === 'fruit' ? 'selected' : ''}>Meyve</option>
                            <option value="bread" ${item.role === 'bread' ? 'selected' : ''}>Ekmek</option>
                            <option value="snack" ${item.role === 'snack' ? 'selected' : ''}>Atıştırmalık</option>
                            <option value="supplement" ${item.role === 'supplement' ? 'selected' : ''}>Ek</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <label for="editTemplateItem${i + 1}Quantity" class="form-label">Sayı</label>
                        <input type="number" id="editTemplateItem${i + 1}Quantity" class="form-control" value="${item.quantity}" min="1">
                    </div>
                </div>
            `).join('');
            document.getElementById('editTemplateForm').style.display = 'block';
        }

        function saveEditedTemplate(event) {
            event.preventDefault();
            const index = parseInt(document.getElementById('editTemplateIndex').value);
            const mealType = document.getElementById('editTemplateMealType').value;
            const frequency = parseInt(document.getElementById('editTemplateFrequency').value);
            const items = [];
            const itemsDiv = document.getElementById('editTemplateItems');
            const rows = itemsDiv.getElementsByClassName('row');
            for (let i = 0; i < rows.length; i++) {
                const keyword = document.getElementById(`editTemplateItem${i + 1}Keyword`).value;
                const role = document.getElementById(`editTemplateItem${i + 1}Role`).value;
                const quantity = parseInt(document.getElementById(`editTemplateItem${i + 1}Quantity`).value);
                if (keyword) items.push({ keyword, role, quantity });
            }
            mealTemplates[index] = { mealType, frequency, items };
            loadMealTemplates();
            cancelEditTemplate();
            showNotification("Şablon güncellendi!");
        }

        function cancelEditTemplate() {
            document.getElementById('editTemplateForm').style.display = 'none';
        }
        function deleteMealTemplate(index) {
            mealTemplates.splice(index, 1);
            loadMealTemplates();
            showNotification("Şablon silindi!");
        }
        function generateRandomTemplate() {
            rules.forEach(rule => {
        if (rule.type === 'frequency' && rule.scope === 'weekly' && rule.name) {
            let weeklyCount = 0;
            weeks.forEach(week => {
                Object.values(week.days).forEach(day => {
                    ['breakfast', 'lunch', 'dinner'].forEach(mt => {
                        weeklyCount += (day.meals[mt] || []).filter(item => 
                            item.name.toLowerCase().includes(rule.name.toLowerCase())
                        ).length;
                    });
                });
            });
            if (weeklyCount > rule.frequency) {
                weeks.forEach(week => {
                    Object.values(week.days).forEach(day => {
                        ['breakfast', 'lunch', 'dinner'].forEach(mt => {
                            day.meals[mt] = day.meals[mt].filter(item => {
                                if (item.name.toLowerCase().includes(rule.name.toLowerCase())) {
                                    if (weeklyCount <= rule.frequency) return true;
                                    weeklyCount--;
                                    return false;
                                }
                                return true;
                            });
                        });
                    });
                });
            }
        }
    });
            const mealType = document.getElementById('templateMealType').value;
            const frequency = parseInt(document.getElementById('templateFrequency').value);
            const patientData = currentPatient ? JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}') : {};
            const likedFoods = patientData.likedFoods || [];
            const dislikedFoods = patientData.dislikedFoods || [];
            const items = [];
            const availableFoods = categories.flatMap(cat => cat.items)
                .filter(f => f.mealType.includes(mealType) && (dietMode === 'keto' ? f.keto : f.lowcarb))
                .filter(f => !dislikedFoods.some(df => f.name.toLowerCase().includes(df.toLowerCase()) || f.tags.some(t => t.toLowerCase().includes(df.toLowerCase()))));
            const rolesToInclude = ['mainDish', 'sideDish', 'drink', 'soup', 'dessert'];
            rolesToInclude.forEach(role => {
                const filtered = availableFoods.filter(f => f.role === role);
                if (filtered.length > 0) {
                    const preferred = filtered.filter(f => likedFoods.some(lf => f.name.toLowerCase().includes(lf.toLowerCase()) || f.tags.some(t => t.toLowerCase().includes(lf.toLowerCase()))));
                    const food = preferred.length > 0 ? preferred[Math.floor(Math.random() * preferred.length)] : filtered[Math.floor(Math.random() * filtered.length)];
                    items.push({ keyword: food.name, role, quantity: 1 });
                }
            });
            mealTemplates.push({ mealType, frequency, items });
            loadMealTemplates();
            showNotification("Rastgele şablon oluşturuldu!");
        }
        // Mevcut generateAutoPlan fonksiyonunu bulun (yaklaşık 2200. satır) ve komple şu kodla değiştirin:
        function generateAutoPlan() {
    const settings = getPlanningSettings();
    generatePlan(settings); // Parametre kaldırıldı
}
function generateFastPlan() {
    weeks = [{
        days: {
            "monday": { meals: { breakfast: [], lunch: [], dinner: [] } },
            "tuesday": { meals: { breakfast: [], lunch: [], dinner: [] } },
            "wednesday": { meals: { breakfast: [], lunch: [], dinner: [] } },
            "thursday": { meals: { breakfast: [], lunch: [], dinner: [] } },
            "friday": { meals: { breakfast: [], lunch: [], dinner: [] } },
            "saturday": { meals: { breakfast: [], lunch: [], dinner: [] } },
            "sunday": { meals: { breakfast: [], lunch: [], dinner: [] } }
        }
    }];
    const settings = getPlanningSettings();
    generatePlan(settings);
    console.log("generateFastPlan çalıştı, weeks:", JSON.stringify(weeks, null, 2));
}

function getPlanningSettings() {
    const patientData = currentPatient ? JSON.parse(localStorage.getItem(`patient_${currentPatient}`) || '{}') : {};
    return {
        likedFoods: patientData.likedFoods || [],
        dislikedFoods: patientData.dislikedFoods || [],
        minItems: parseInt(document.getElementById('minItemsPerMeal').value),
        maxItems: parseInt(document.getElementById('maxItemsPerMeal').value),
        flexibility: parseFloat(document.getElementById('calorieFlexibility').value) / 100,
        targetCalories: parseFloat(document.getElementById('targetCalories').value),
        breakfastMin: parseInt(document.getElementById('breakfastMin').value),
        breakfastMax: parseInt(document.getElementById('breakfastMax').value),
        lunchMin: parseInt(document.getElementById('lunchMin').value),
        lunchMax: parseInt(document.getElementById('lunchMax').value),
        dinnerMin: parseInt(document.getElementById('dinnerMin').value),
        dinnerMax: parseInt(document.getElementById('dinnerMax').value),
        macroPriority: parseInt(document.getElementById('macroPriority').value),
        templatePriority: parseInt(document.getElementById('templatePriority').value),
        rulePriority: parseInt(document.getElementById('rulePriority').value),
        compatibilityPriority: parseInt(document.getElementById('compatibilityPriority').value),
        managementPriority: parseInt(document.getElementById('managementPriority').value),
        macroTolerance: parseInt(document.getElementById('macroTolerance').value) / 100,
        optimizeCoefficients: document.getElementById('optimizeCoefficients').checked,
        breakfastPriority: document.getElementById('breakfastPriority').value,
        lunchPriority: document.getElementById('lunchPriority').value,
        dinnerPriority: document.getElementById('dinnerPriority').value,
        fixedBreakfastMeal: document.getElementById('fixedBreakfastMeal').value,
        fixedLunchMeal: document.getElementById('fixedLunchMeal').value,
        fixedDinnerMeal: document.getElementById('fixedDinnerMeal').value
    };
}

// applyAllRules fonksiyonu
function applyAllRules() {
    const settings = getPlanningSettings();
    settings.rulePriority = 100; // Kurallara maksimum öncelik ver
    generatePlan(settings); // Gereksiz ikinci parametre kaldırıldı
    showNotification("Tüm kurallar uygulandı!");
}


// Formları tanımla
const frequencyForm = document.getElementById('frequencyRuleForm');
const pairForm = document.getElementById('pairRuleForm');
const dependOnForm = document.getElementById('dependOnRuleForm');
const categoryLockForm = document.getElementById('categoryLockRuleForm');
const defaultForm = document.getElementById('defaultForm');

// Tüm formları gizle (null kontrolü ile)
[frequencyForm, pairForm, dependOnForm, categoryLockForm, defaultForm].forEach(form => {
    if (form) form.style.display = 'none';
});

// Seçilen türe göre doğru formu göster
if (type === 'frequency' && frequencyForm) {
    frequencyForm.style.display = 'block';
} else if ((type === 'pairWith' || type === 'avoidPair') && pairForm) {
    pairForm.style.display = 'block';
} else if (type === 'dependOn' && dependOnForm) {
    dependOnForm.style.display = 'block';
} else if (type === 'categoryLock' && categoryLockForm) {
    categoryLockForm.style.display = 'block';
} else if (defaultForm) {
    defaultForm.style.display = 'block';
    // Aşağıdaki değişkenlerin de tanımlı olduğundan emin olun
    if (typeof frequencyInput !== 'undefined') frequencyInput.style.display = type === 'frequency' ? 'block' : 'none';
    if (typeof countInput !== 'undefined') countInput.style.display = 'none';
    if (typeof pairInput !== 'undefined') pairInput.style.display = ['pairWith', 'avoidPair'].includes(type) ? 'block' : 'none';
} else {
    console.warn(`Desteklenmeyen kural tipi veya form bulunamadı: ${type}`);
}

// Global form değişkenleri (gerekirse tanımlanır, şimdilik kaldırıldı)
// Not: Eğer bu değişkenler başka yerlerde kullanılıyorsa, uygun scope'ta tanımlanmalı
// let defaultForm = document.getElementById('defaultRuleForm');
// let frequencyForm = document.getElementById('frequencyRuleForm');
// let pairForm = document.getElementById('pairRuleForm');
// let dependOnForm = document.getElementById('dependOnRuleForm');
// let categoryLockForm = document.getElementById('categoryLockRuleForm');

// generatePlan fonksiyonu (tekrarlanan kısım kaldırıldı)
function generatePlan(settings) {
    const availableFoods = categories.flatMap(cat => cat.items)
        .filter(f => (dietMode === 'keto' ? f.keto : f.lowcarb))
        .sort((a, b) => {
            const aLiked = settings.likedFoods.some(lf => a.name.toLowerCase().includes(lf.toLowerCase()) || a.tags.some(t => t.toLowerCase().includes(lf.toLowerCase())));
            const bLiked = settings.likedFoods.some(lf => b.name.toLowerCase().includes(lf.toLowerCase()) || b.tags.some(t => t.toLowerCase().includes(lf.toLowerCase())));
            return bLiked - aLiked;
        });

    const validRules = rules.filter(rule => rule && typeof rule === 'object' && rule.type);

    // Bağımlılık kontrol fonksiyonu
    function checkDependOn(foodName, mealItems) {
        const dependentRule = validRules.find(r => r.type === 'dependOn' && r.food?.toLowerCase().includes(foodName.toLowerCase()));
        if (!dependentRule) return true; // Bağımlı değilse her zaman eklenebilir
        const requiredFood = dependentRule.requiredFood?.toLowerCase();
        return mealItems.some(item => item.name.toLowerCase().includes(requiredFood));
    }

    validRules.forEach(rule => {
        if (rule.type === 'frequency') {
            // Mevcut frequency kodu değişmedi, olduğu gibi kalabilir
            let matchingFoods = [];
            if (rule.nameCheck && rule.names?.length) {
                if (rule.nameOperator === 'AND') {
                    matchingFoods = rule.names.map(name =>
                        availableFoods.filter(food => food.name.toLowerCase().includes(name.toLowerCase()))
                    ).filter(arr => arr.length > 0);
                    if (matchingFoods.length !== rule.names.length) {
                        console.warn(`Kural (${rule.id}) için tüm isimler bulunamadı: ${JSON.stringify(rule)}`);
                        return;
                    }
                    matchingFoods = matchingFoods.flat();
                } else { // OR
                    matchingFoods = availableFoods.filter(food =>
                        rule.names.some(name => food.name.toLowerCase().includes(name.toLowerCase()))
                    );
                }
            } else if (rule.nameCheck && rule.name) { // Eski format
                matchingFoods = availableFoods.filter(food => food.name.toLowerCase().includes(rule.name.toLowerCase()));
            } else {
                matchingFoods = availableFoods;
            }

            if (rule.tagsCheck && rule.tags?.length) {
                matchingFoods = matchingFoods.filter(food => {
                    if (rule.tagOperator === 'AND') {
                        return rule.tags.every(tag => food.tags?.some(t => t.toLowerCase().includes(tag.toLowerCase())));
                    } else { // OR
                        return rule.tags.some(tag => food.tags?.some(t => t.toLowerCase().includes(tag.toLowerCase())));
                    }
                });
            }

            if (rule.roleCheck && rule.role) matchingFoods = matchingFoods.filter(food => food.role === rule.role);
            if (rule.catCheck && rule.category) matchingFoods = matchingFoods.filter(food => categories.find(cat => cat.name === rule.category)?.items.some(item => item.name === food.name));

            if (matchingFoods.length === 0) {
                console.warn(`Kural (${rule.id}) için uygun yemek bulunamadı: ${JSON.stringify(rule)}`);
                return;
            }

            weeks.forEach(week => {
                Object.values(week.days).forEach(day => {
                    if (rule.scope === 'meal' && rule.mealType) {
                        const mealItems = day.meals[rule.mealType] = day.meals[rule.mealType] || [];
                        const count = rule.nameOperator === 'AND' ?
                            rule.names.reduce((min, name) => {
                                const nameCount = mealItems.filter(item => item.name.toLowerCase().includes(name.toLowerCase())).length;
                                return Math.min(min, nameCount);
                            }, Infinity) :
                            mealItems.filter(item => matchingFoods.some(f => f.name === item.name)).length;

                        console.log(`Meal kontrol - (${rule.id}) ${rule.names?.join(', ') || rule.name || 'yemek'}, Gerekli: ${rule.frequency}, Şu an: ${count}, Öğün: ${rule.mealType}, Tür: ${rule.frequencyType}`);

                        if (rule.frequencyType === 'min' && count < rule.frequency) {
                            let remaining = rule.frequency - count;
                            while (remaining > 0 && matchingFoods.length > 0) {
                                if (rule.nameOperator === 'AND') {
                                    rule.names.forEach(name => {
                                        const food = matchingFoods.find(f => f.name.toLowerCase().includes(name.toLowerCase()));
                                        if (food && mealItems.filter(item => item.name === food.name).length < rule.frequency) {
                                            const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                            mealItems.push({ name: food.name, quantity });
                                            console.log(`Eklendi (Öğün, min, AND): ${food.name}, ${rule.mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                        }
                                    });
                                    remaining--;
                                } else { // OR
                                    const food = matchingFoods[Math.floor(Math.random() * matchingFoods.length)];
                                    const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                    mealItems.push({ name: food.name, quantity });
                                    remaining -= quantity;
                                    console.log(`Eklendi (Öğün, min): ${food.name}, ${rule.mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                }
                            }
                        } else if (rule.frequencyType === 'max' && count > rule.frequency) {
                            let excess = count - rule.frequency;
                            while (excess > 0) {
                                const index = mealItems.findIndex(item => matchingFoods.some(f => f.name === item.name));
                                if (index !== -1) {
                                    mealItems.splice(index, 1);
                                    excess--;
                                    console.log(`Kaldırıldı (Öğün, max): ${rule.names?.join(', ') || rule.name}, ${rule.mealType}`);
                                } else break;
                            }
                        } else if (rule.frequencyType === 'exact' && count !== rule.frequency) {
                            if (count < rule.frequency) {
                                let remaining = rule.frequency - count;
                                while (remaining > 0 && matchingFoods.length > 0) {
                                    if (rule.nameOperator === 'AND') {
                                        rule.names.forEach(name => {
                                            const food = matchingFoods.find(f => f.name.toLowerCase().includes(name.toLowerCase()));
                                            if (food && mealItems.filter(item => item.name === food.name).length < rule.frequency) {
                                                const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                                mealItems.push({ name: food.name, quantity });
                                                console.log(`Eklendi (Öğün, exact, AND): ${food.name}, ${rule.mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                            }
                                        });
                                        remaining--;
                                    } else { // OR
                                        const food = matchingFoods[Math.floor(Math.random() * matchingFoods.length)];
                                        const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                        mealItems.push({ name: food.name, quantity });
                                        remaining -= quantity;
                                        console.log(`Eklendi (Öğün, exact): ${food.name}, ${rule.mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                    }
                                }
                            } else if (count > rule.frequency) {
                                let excess = count - rule.frequency;
                                while (excess > 0) {
                                    const index = mealItems.findIndex(item => matchingFoods.some(f => f.name === item.name));
                                    if (index !== -1) {
                                        mealItems.splice(index, 1);
                                        excess--;
                                        console.log(`Kaldırıldı (Öğün, exact): ${rule.names?.join(', ') || rule.name}, ${rule.mealType}`);
                                    } else break;
                                }
                            }
                        }
                    } else if (rule.scope === 'day') {
                        let dailyCount = 0;
                        ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                            const mealItems = day.meals[mealType] || [];
                            dailyCount += mealItems.filter(item => matchingFoods.some(f => f.name === item.name)).length;
                        });
                        console.log(`Day kontrol - (${rule.id}) ${rule.names?.join(', ') || rule.name || 'yemek'}, Gerekli: ${rule.frequency}, Şu an: ${dailyCount}, Tür: ${rule.frequencyType}`);
                        if (rule.frequencyType === 'min' && dailyCount < rule.frequency) {
                            let remaining = rule.frequency - dailyCount;
                            const mealTypes = ['breakfast', 'lunch', 'dinner'];
                            for (let i = 0; i < mealTypes.length && remaining > 0; i++) {
                                const mealType = mealTypes[i];
                                const mealItems = day.meals[mealType] = day.meals[mealType] || [];
                                if (rule.nameOperator === 'AND') {
                                    rule.names.forEach(name => {
                                        const food = matchingFoods.find(f => f.name.toLowerCase().includes(name.toLowerCase()));
                                        if (food && mealItems.filter(item => item.name === food.name).length < rule.frequency) {
                                            const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                            mealItems.push({ name: food.name, quantity });
                                            console.log(`Eklendi (Günlük, min, AND): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                        }
                                    });
                                    remaining--;
                                } else { // OR
                                    const food = matchingFoods[Math.floor(Math.random() * matchingFoods.length)];
                                    const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                    mealItems.push({ name: food.name, quantity });
                                    remaining -= quantity;
                                    console.log(`Eklendi (Günlük, min): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                }
                            }
                        } else if (rule.frequencyType === 'max' && dailyCount > rule.frequency) {
                            let excess = dailyCount - rule.frequency;
                            const mealTypes = ['breakfast', 'lunch', 'dinner'];
                            for (let i = 0; i < mealTypes.length && excess > 0; i++) {
                                const mealType = mealTypes[i];
                                const mealItems = day.meals[mealType] || [];
                                const index = mealItems.findIndex(item => matchingFoods.some(f => f.name === item.name));
                                if (index !== -1) {
                                    mealItems.splice(index, 1);
                                    excess--;
                                    console.log(`Kaldırıldı (Günlük, max): ${rule.names?.join(', ') || rule.name}, ${mealType}`);
                                }
                            }
                        } else if (rule.frequencyType === 'exact' && dailyCount !== rule.frequency) {
                            if (dailyCount < rule.frequency) {
                                let remaining = rule.frequency - dailyCount;
                                const mealTypes = ['breakfast', 'lunch', 'dinner'];
                                for (let i = 0; i < mealTypes.length && remaining > 0; i++) {
                                    const mealType = mealTypes[i];
                                    const mealItems = day.meals[mealType] = day.meals[mealType] || [];
                                    if (rule.nameOperator === 'AND') {
                                        rule.names.forEach(name => {
                                            const food = matchingFoods.find(f => f.name.toLowerCase().includes(name.toLowerCase()));
                                            if (food && mealItems.filter(item => item.name === food.name).length < rule.frequency) {
                                                const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                                mealItems.push({ name: food.name, quantity });
                                                console.log(`Eklendi (Günlük, exact, AND): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                            }
                                        });
                                        remaining--;
                                    } else { // OR
                                        const food = matchingFoods[Math.floor(Math.random() * matchingFoods.length)];
                                        const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                        mealItems.push({ name: food.name, quantity });
                                        remaining -= quantity;
                                        console.log(`Eklendi (Günlük, exact): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                    }
                                }
                            } else if (dailyCount > rule.frequency) {
                                let excess = dailyCount - rule.frequency;
                                const mealTypes = ['breakfast', 'lunch', 'dinner'];
                                for (let i = 0; i < mealTypes.length && excess > 0; i++) {
                                    const mealType = mealTypes[i];
                                    const mealItems = day.meals[mealType] || [];
                                    const index = mealItems.findIndex(item => matchingFoods.some(f => f.name === item.name));
                                    if (index !== -1) {
                                        mealItems.splice(index, 1);
                                        excess--;
                                        console.log(`Kaldırıldı (Günlük, exact): ${rule.names?.join(', ') || rule.name}, ${mealType}`);
                                    }
                                }
                            }
                        }
                    } else if (rule.scope === 'week') {
                        let weeklyCount = 0;
                        Object.values(week.days).forEach(day => {
                            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                                const mealItems = day.meals[mealType] || [];
                                weeklyCount += mealItems.filter(item => matchingFoods.some(f => f.name === item.name)).length;
                            });
                        });
                        console.log(`Week kontrol - (${rule.id}) ${rule.names?.join(', ') || rule.name || 'yemek'}, Gerekli: ${rule.frequency}, Şu an: ${weeklyCount}, Tür: ${rule.frequencyType}`);
                        if (rule.frequencyType === 'min' && weeklyCount < rule.frequency) {
                            let remaining = rule.frequency - weeklyCount;
                            const days = Object.values(week.days);
                            for (let i = 0; i < days.length && remaining > 0; i++) {
                                const day = days[i];
                                const mealType = rule.mealType || ['breakfast', 'lunch', 'dinner'][Math.floor(Math.random() * 3)];
                                const mealItems = day.meals[mealType] = day.meals[mealType] || [];
                                if (rule.nameOperator === 'AND') {
                                    rule.names.forEach(name => {
                                        const food = matchingFoods.find(f => f.name.toLowerCase().includes(name.toLowerCase()));
                                        if (food && mealItems.filter(item => item.name === food.name).length < rule.frequency) {
                                            const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                            mealItems.push({ name: food.name, quantity });
                                            console.log(`Eklendi (Haftalık, min, AND): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                        }
                                    });
                                    remaining--;
                                } else { // OR
                                    const food = matchingFoods[Math.floor(Math.random() * matchingFoods.length)];
                                    const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                    mealItems.push({ name: food.name, quantity });
                                    remaining -= quantity;
                                    console.log(`Eklendi (Haftalık, min): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                }
                            }
                        } else if (rule.frequencyType === 'max' && weeklyCount > rule.frequency) {
                            let excess = weeklyCount - rule.frequency;
                            const days = Object.values(week.days);
                            for (let i = 0; i < days.length && excess > 0; i++) {
                                const day = days[i];
                                const mealTypes = ['breakfast', 'lunch', 'dinner'];
                                for (let j = 0; j < mealTypes.length && excess > 0; j++) {
                                    const mealType = mealTypes[j];
                                    const mealItems = day.meals[mealType] || [];
                                    const index = mealItems.findIndex(item => matchingFoods.some(f => f.name === item.name));
                                    if (index !== -1) {
                                        mealItems.splice(index, 1);
                                        excess--;
                                        console.log(`Kaldırıldı (Haftalık, max): ${rule.names?.join(', ') || rule.name}, ${mealType}`);
                                    }
                                }
                            }
                        } else if (rule.frequencyType === 'exact' && weeklyCount !== rule.frequency) {
                            if (weeklyCount < rule.frequency) {
                                let remaining = rule.frequency - weeklyCount;
                                const days = Object.values(week.days);
                                for (let i = 0; i < days.length && remaining > 0; i++) {
                                    const day = days[i];
                                    const mealType = rule.mealType || ['breakfast', 'lunch', 'dinner'][Math.floor(Math.random() * 3)];
                                    const mealItems = day.meals[mealType] = day.meals[mealType] || [];
                                    if (rule.nameOperator === 'AND') {
                                        rule.names.forEach(name => {
                                            const food = matchingFoods.find(f => f.name.toLowerCase().includes(name.toLowerCase()));
                                            if (food && mealItems.filter(item => item.name === food.name).length < rule.frequency) {
                                                const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                                mealItems.push({ name: food.name, quantity });
                                                console.log(`Eklendi (Haftalık, exact, AND): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                            }
                                        });
                                        remaining--;
                                    } else { // OR
                                        const food = matchingFoods[Math.floor(Math.random() * matchingFoods.length)];
                                        const quantity = Math.min(Math.max(food.minQuantity || 1, 1), remaining);
                                        mealItems.push({ name: food.name, quantity });
                                        remaining -= quantity;
                                        console.log(`Eklendi (Haftalık, exact): ${food.name}, ${mealType}, Miktar: ${quantity}, Kalan: ${remaining}`);
                                    }
                                }
                            } else if (weeklyCount > rule.frequency) {
                                let excess = weeklyCount - rule.frequency;
                                const days = Object.values(week.days);
                                for (let i = 0; i < days.length && excess > 0; i++) {
                                    const day = days[i];
                                    const mealTypes = ['breakfast', 'lunch', 'dinner'];
                                    for (let j = 0; j < mealTypes.length && excess > 0; j++) {
                                        const mealType = mealTypes[j];
                                        const mealItems = day.meals[mealType] || [];
                                        const index = mealItems.findIndex(item => matchingFoods.some(f => f.name === item.name));
                                        if (index !== -1) {
                                            mealItems.splice(index, 1);
                                            excess--;
                                            console.log(`Kaldırıldı (Haftalık, exact): ${rule.names?.join(', ') || rule.name}, ${mealType}`);
                                        }
                                    }
                                }
                            }
                        }
                    }
                });
            });
        } else if (rule.type === 'dependOn' && rule.food && rule.requiredFood) {
            weeks.forEach(week => {
                Object.values(week.days).forEach(day => {
                    ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                        let mealItems = day.meals[mealType] || [];
                        const hasRequired = mealItems.some(item => item.name.toLowerCase().includes(rule.requiredFood.toLowerCase()));
                        const hasFood = mealItems.some(item => item.name.toLowerCase().includes(rule.food.toLowerCase()));
                        const dependentFood = availableFoods.find(f => f.name.toLowerCase().includes(rule.food.toLowerCase()));
                        
                        if (hasFood && !hasRequired) {
                            day.meals[mealType] = mealItems.filter(item => !item.name.toLowerCase().includes(rule.food.toLowerCase()));
                            console.log(`(${rule.id}) ${rule.food} kaldırıldı çünkü ${rule.requiredFood} yok, öğün: ${mealType}`);
                        } else if (!hasFood && hasRequired && dependentFood && Math.random() < 0.5) {
                            day.meals[mealType].push({ name: dependentFood.name, quantity: Math.max(dependentFood.minQuantity || 0.5, 1) });
                            console.log(`(${rule.id}) ${rule.food} eklendi çünkü ${rule.requiredFood} var, öğün: ${mealType}`);
                        }
                    });
                });
            });
        } else if (rule.type === 'pairWith' && rule.pair1Name && rule.pair2Name) {
            weeks.forEach(week => {
                Object.values(week.days).forEach(day => {
                    const mealTypes = rule.scope === 'meal' ? [rule.meal] : ['breakfast', 'lunch', 'dinner'];
                    mealTypes.forEach(mealType => {
                        let mealItems = day.meals[mealType] || [];
                        const hasPair1 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair1Name.toLowerCase()));
                        const hasPair2 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair2Name.toLowerCase()));
                        if (hasPair1 && !hasPair2) {
                            const pair2Food = availableFoods.find(f => f.name.toLowerCase().includes(rule.pair2Name.toLowerCase()));
                            if (pair2Food) {
                                mealItems.push({ name: pair2Food.name, quantity: Math.max(pair2Food.minQuantity || 1, 1) });
                                console.log(`(${rule.id}) ${pair2Food.name} eklendi çünkü ${rule.pair1Name} var, öğün: ${mealType}`);
                            }
                        } else if (hasPair2 && !hasPair1) {
                            const pair1Food = availableFoods.find(f => f.name.toLowerCase().includes(rule.pair1Name.toLowerCase()));
                            if (pair1Food) {
                                mealItems.push({ name: pair1Food.name, quantity: Math.max(pair1Food.minQuantity || 1, 1) });
                                console.log(`(${rule.id}) ${pair1Food.name} eklendi çünkü ${rule.pair2Name} var, öğün: ${mealType}`);
                            }
                        }
                        day.meals[mealType] = mealItems;
                    });
                });
            });
        } else if (rule.type === 'avoidPair' && rule.pair1Name && rule.pair2Name) {
            weeks.forEach(week => {
                Object.values(week.days).forEach(day => {
                    const mealTypes = rule.scope === 'meal' ? [rule.meal] : ['breakfast', 'lunch', 'dinner'];
                    mealTypes.forEach(mealType => {
                        let mealItems = day.meals[mealType] || [];
                        const hasPair1 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair1Name.toLowerCase()));
                        const hasPair2 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair2Name.toLowerCase()));
                        if (hasPair1 && hasPair2) {
                            const index = mealItems.findIndex(item => item.name.toLowerCase().includes(rule.pair2Name.toLowerCase()));
                            if (index !== -1) {
                                mealItems.splice(index, 1);
                                console.log(`(${rule.id}) ${rule.pair2Name} kaldırıldı çünkü ${rule.pair1Name} var, öğün: ${mealType}`);
                            }
                        }
                        day.meals[mealType] = mealItems;
                    });
                });
            });
        } else if (rule.type === 'categoryLock' && rule.category && rule.item) {
            weeks.forEach(week => {
                Object.values(week.days).forEach(day => {
                    ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                        let mealItems = day.meals[mealType] || [];
                        const categoryItems = categories.find(cat => cat.name === rule.category)?.items || [];
                        const lockedItem = categoryItems.find(item => item.name === rule.item);
                        const otherItems = mealItems.filter(item => categoryItems.some(ci => ci.name === item.name && ci.name !== rule.item));
                        if (otherItems.length > 0 && lockedItem) {
                            otherItems.forEach(unwanted => {
                                const index = mealItems.findIndex(item => item.name === unwanted.name);
                                if (index !== -1) {
                                    mealItems.splice(index, 1);
                                    console.log(`(${rule.id}) ${unwanted.name} kaldırıldı çünkü ${rule.category} için sadece ${rule.item} kullanılmalı`);
                                }
                            });
                            if (!mealItems.some(item => item.name === lockedItem.name)) {
                                mealItems.push({ name: lockedItem.name, quantity: Math.max(lockedItem.minQuantity || 1, 1) });
                                console.log(`(${rule.id}) ${lockedItem.name} eklendi çünkü ${rule.category} için zorunlu`);
                            }
                        }
                        day.meals[mealType] = mealItems;
                    });
                });
            });
        } else if (rule.type === 'maxRoleCount' && rule.role && rule.count !== undefined && rule.mealType) {
            weeks.forEach(week => {
                Object.values(week.days).forEach(day => {
                    const mealItems = day.meals[rule.mealType] = day.meals[rule.mealType] || [];
                    const roleCount = mealItems.filter(item => {
                        const food = availableFoods.find(f => f.name === item.name);
                        return food && food.role === rule.role;
                    }).length;

                    console.log(`MaxRoleCount kontrol - (${rule.id}) Rol: ${rule.role}, Gerekli max: ${rule.count}, Şu an: ${roleCount}, Öğün: ${rule.mealType}`);

                    if (roleCount > rule.count) {
                        let excess = roleCount - rule.count;
                        while (excess > 0) {
                            const index = mealItems.findIndex(item => {
                                const food = availableFoods.find(f => f.name === item.name);
                                return food && food.role === rule.role;
                            });
                            if (index !== -1) {
                                mealItems.splice(index, 1);
                                excess--;
                                console.log(`Kaldırıldı (MaxRoleCount): ${mealItems[index]?.name || 'yemek'}, ${rule.mealType}`);
                            } else break;
                        }
                    }
                });
            });
        }
    });

    weeks.forEach(week => {
        Object.entries(week.days).forEach(([day, dayData]) => {
            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                const existingItems = dayData.meals[mealType] || [];
                dayData.meals[mealType] = existingItems;

                const targetMealCalories = settings.targetCalories * (mealType === 'breakfast' ?
                    (1 - parseFloat(document.getElementById('lunchCalorieRatio').value) / 100 - parseFloat(document.getElementById('dinnerCalorieRatio').value) / 100) :
                    mealType === 'lunch' ? parseFloat(document.getElementById('lunchCalorieRatio').value) / 100 :
                    parseFloat(document.getElementById('dinnerCalorieRatio').value) / 100);
                const min = mealType === 'breakfast' ? settings.breakfastMin : mealType === 'lunch' ? settings.lunchMin : settings.dinnerMin;
                const max = mealType === 'breakfast' ? settings.breakfastMax : mealType === 'lunch' ? settings.lunchMax : settings.dinnerMax;
                let itemCount = Math.floor(Math.random() * (max - min + 1)) + min;
                itemCount = Math.max(settings.minItems, Math.min(settings.maxItems, itemCount));
                const mealFoods = availableFoods.filter(f => f.mealType.includes(mealType) &&
                    !settings.dislikedFoods.some(df => f.name.toLowerCase().includes(df.toLowerCase()) || f.tags.some(t => t.toLowerCase().includes(df.toLowerCase()))));

                let currentCalories = existingItems.reduce((sum, item) => {
                    const food = availableFoods.find(f => f.name === item.name);
                    return sum + (food ? food.calories * item.quantity : 0);
                }, 0);

                if (mealType === 'breakfast' && !existingItems.some(item => item.name === "Kurşun Geçirmez Kahve")) {
                    dayData.meals[mealType].push({ name: "Kurşun Geçirmez Kahve", quantity: 1 });
                    currentCalories += 200;
                }

                if (mealType === 'lunch' || mealType === 'dinner') {
                    const noDuplicateRule = validRules.find(r => r.type === 'noDuplicates' && (!r.mealType || r.mealType === mealType));
                    const maxRoleRules = validRules.filter(r => r.type === 'maxRoleCount' && (!r.mealType || r.mealType === mealType));

                    function checkCompatibility(foodName, currentMeal) {
                        const compatRules = compatibilityTable.filter(rule => rule.keyword1.toLowerCase() === foodName.toLowerCase());
                        if (!compatRules.length) return true;
                        let canAddAlone = true;
                        compatRules.forEach(rule => {
                            if (rule.degree === -5 && !rule.keyword2.length) {
                                canAddAlone = false;
                            } else if (rule.keyword2.length) {
                                const pairedFoods = rule.keyword2;
                                const isPaired = currentMeal.some(item =>
                                    pairedFoods.some(kw => item.name.toLowerCase().includes(kw.toLowerCase())));
                                if (rule.conjunction === 'and') {
                                    if (rule.degree > 0 && !isPaired) canAddAlone = false;
                                    if (rule.degree < 0 && isPaired) canAddAlone = false;
                                } else {
                                    const shouldPair = rule.degree > 0;
                                    const mustAvoid = rule.degree < 0;
                                    if (shouldPair && !isPaired) canAddAlone = false;
                                    if (mustAvoid && isPaired) canAddAlone = false;
                                }
                            }
                        });
                        return canAddAlone;
                    }

                    for (let i = dayData.meals[mealType].length; i < itemCount && mealFoods.length > 0; i++) {
                        const filteredFoods = mealFoods.filter(f =>
                            !dayData.meals[mealType].some(item => item.name === f.name) &&
                            checkCompatibility(f.name, dayData.meals[mealType]) &&
                            checkDependOn(f.name, dayData.meals[mealType]));
                        if (filteredFoods.length === 0) break;
                        const food = filteredFoods[Math.floor(Math.random() * filteredFoods.length)];
                        const quantity = Math.max(food.minQuantity || 0.5, 1);
                        if (currentCalories + food.calories * quantity <= targetMealCalories * (1 + settings.macroTolerance)) {
                            dayData.meals[mealType].push({ name: food.name, quantity });
                            currentCalories += food.calories * quantity;
                        }
                    }

                    if (mealType === 'lunch') {
                        const preferredRoles = ['mainDish', 'sideDish', 'snack', 'dessert'];
                        preferredRoles.forEach(role => {
                            const roleFoods = mealFoods.filter(f => f.role === role &&
                                (!noDuplicateRule || !dayData.meals[mealType].some(item => item.name === f.name)) &&
                                checkDependOn(f.name, dayData.meals[mealType]));
                            if (roleFoods.length > 0 && dayData.meals[mealType].length < max) {
                                const food = roleFoods[Math.floor(Math.random() * roleFoods.length)];
                                const quantity = Math.max(food.minQuantity || 0.5, Math.min(food.maxQuantity || 1, 1));
                                if (currentCalories + food.calories * quantity <= targetMealCalories * (1 + settings.macroTolerance)) {
                                    dayData.meals[mealType].push({ name: food.name, quantity });
                                    currentCalories += food.calories * quantity;
                                }
                            }
                        });

                        const fillers = availableFoods.filter(f => f.fillerLunch &&
                            !dayData.meals[mealType].some(item => item.name === f.name) &&
                            checkDependOn(f.name, dayData.meals[mealType]));
                        while (currentCalories < targetMealCalories * (1 - settings.macroTolerance) && fillers.length > 0) {
                            const filler = fillers[Math.floor(Math.random() * fillers.length)];
                            const quantity = Math.max(filler.minQuantity || 0.5, Math.min(filler.maxQuantity || 1, 1));
                            if (currentCalories + filler.calories * quantity <= targetMealCalories * (1 + settings.macroTolerance)) {
                                dayData.meals[mealType].push({ name: filler.name, quantity });
                                currentCalories += filler.calories * quantity;
                            }
                            fillers.splice(fillers.indexOf(filler), 1);
                        }
                    }

                    if (mealType === 'dinner') {
                        const preferredRoles = ['mainDish', 'soup', 'sideDish', 'dessert', 'snack'];
                        preferredRoles.forEach(role => {
                            const roleFoods = mealFoods.filter(f => f.role === role &&
                                (!noDuplicateRule || !dayData.meals[mealType].some(item => item.name === f.name)) &&
                                checkDependOn(f.name, dayData.meals[mealType]));
                            if (roleFoods.length > 0 && dayData.meals[mealType].length < max) {
                                const food = roleFoods[Math.floor(Math.random() * roleFoods.length)];
                                const quantity = Math.max(food.minQuantity || 0.5, Math.min(food.maxQuantity || 1, 1));
                                if (currentCalories + food.calories * quantity <= targetMealCalories * (1 + settings.macroTolerance)) {
                                    dayData.meals[mealType].push({ name: food.name, quantity });
                                    currentCalories += food.calories * quantity;
                                }
                            }
                        });

                        const targetProtein = settings.targetCalories * settings.proteinMultiplier / 4;
                        const targetFat = settings.targetCalories * settings.fatMultiplier / 9;
                        let currentProtein = dayData.meals[mealType].reduce((sum, item) => {
                            const food = availableFoods.find(f => f.name === item.name);
                            return sum + (food ? food.protein * item.quantity : 0);
                        }, 0);
                        let currentFat = dayData.meals[mealType].reduce((sum, item) => {
                            const food = availableFoods.find(f => f.name === item.name);
                            return sum + (food ? food.fat * item.quantity : 0);
                        }, 0);

                        const proteinMin = targetProtein * 0.95;
                        const proteinMax = targetProtein * 1.05;
                        const fatMin = targetFat * 0.95;
                        const fatMax = targetFat * 1.05;

                        const fillers = availableFoods.filter(f => f.fillerDinner &&
                            !dayData.meals[mealType].some(item => item.name === f.name) &&
                            checkDependOn(f.name, dayData.meals[mealType]));
                        while ((currentProtein < proteinMin || currentFat < fatMin) && fillers.length > 0) {
                            const filler = fillers[Math.floor(Math.random() * fillers.length)];
                            const quantity = Math.max(filler.minQuantity || 0.5, Math.min(filler.maxQuantity || 1, 1));
                            const newProtein = currentProtein + filler.protein * quantity;
                            const newFat = currentFat + filler.fat * quantity;
                            const newCalories = currentCalories + filler.calories * quantity;
                            if (newProtein <= proteinMax && newFat <= fatMax &&
                                newCalories <= targetMealCalories * (1 + settings.macroTolerance)) {
                                dayData.meals[mealType].push({ name: filler.name, quantity });
                                currentProtein = newProtein;
                                currentFat = newFat;
                                currentCalories = newCalories;
                            }
                            fillers.splice(fillers.indexOf(filler), 1);
                        }

                        while (currentCalories < targetMealCalories * (1 - settings.macroTolerance) && fillers.length > 0) {
                            const filler = fillers[Math.floor(Math.random() * fillers.length)];
                            const quantity = Math.max(filler.minQuantity || 0.5, Math.min(filler.maxQuantity || 1, 1));
                            if (currentCalories + filler.calories * quantity <= targetMealCalories * (1 + settings.macroTolerance)) {
                                dayData.meals[mealType].push({ name: filler.name, quantity });
                                currentCalories += filler.calories * quantity;
                            }
                            fillers.splice(fillers.indexOf(filler), 1);
                        }
                    }
                }
            });
        });
    });

    // Son kontrol: Bağımlı yemeklerin gereksinimlerini kontrol et ve temizle
    weeks.forEach(week => {
        Object.values(week.days).forEach(day => {
            ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                let mealItems = day.meals[mealType] || [];
                validRules.filter(rule => rule.type === 'dependOn').forEach(rule => {
                    const hasRequired = mealItems.some(item => item.name.toLowerCase().includes(rule.requiredFood.toLowerCase()));
                    const hasFood = mealItems.some(item => item.name.toLowerCase().includes(rule.food.toLowerCase()));
                    if (hasFood && !hasRequired) {
                        day.meals[mealType] = mealItems.filter(item => !item.name.toLowerCase().includes(rule.food.toLowerCase()));
                        console.log(`Son kontrol: (${rule.id}) ${rule.food} kaldırıldı çünkü ${rule.requiredFood} yok, öğün: ${mealType}`);
                    }
                });
            });
        });
    });

    renderMeals();
    calculateMacros();

    const appliedRules = [];
    const unappliedRules = [];
    validRules.forEach(rule => {
        let applied = false;
        weeks.forEach(week => {
            if (!week.days || typeof week.days !== 'object') return console.warn(`Haftanın günleri tanımlı değil:`, week);
            Object.values(week.days).forEach(day => {
                ['breakfast', 'lunch', 'dinner'].forEach(mealType => {
                    const mealItems = day.meals[mealType] || [];
                    if (rule.type === 'frequency') {
                        const countMatches = () => {
                            if (rule.nameOperator === 'AND') {
                                return rule.names.reduce((min, name) => {
                                    const nameCount = mealItems.filter(item => item.name.toLowerCase().includes(name.toLowerCase())).length;
                                    return Math.min(min, nameCount);
                                }, Infinity);
                            } else { // OR
                                return mealItems.filter(item =>
                                    rule.names.some(name => item.name.toLowerCase().includes(name.toLowerCase()))
                                ).length;
                            }
                        };

                        if (rule.scope === 'meal' && rule.mealType === mealType) {
                            const count = countMatches();
                            console.log(`Meal - (${rule.id}) ${rule.names?.join(', ') || rule.name || 'herhangi bir yemek'}, Gerekli: ${rule.frequency}, Bulunan: ${count}, Öğün: ${mealType}, Tür: ${rule.frequencyType}`);
                            if (rule.frequencyType === 'min' && count >= rule.frequency) applied = true;
                            else if (rule.frequencyType === 'max' && count <= rule.frequency) applied = true;
                            else if (rule.frequencyType === 'exact' && count === rule.frequency) applied = true;
                        } else if (rule.scope === 'day') {
                            let dailyCount = 0;
                            ['breakfast', 'lunch', 'dinner'].forEach(mt => {
                                const mealItems = day.meals[mt] || [];
                                dailyCount += countMatches();
                            });
                            console.log(`Day - (${rule.id}) ${rule.names?.join(', ') || rule.name || 'herhangi bir yemek'}, Gerekli: ${rule.frequency}, Bulunan: ${dailyCount}, Tür: ${rule.frequencyType}`);
                            if (rule.frequencyType === 'min' && dailyCount >= rule.frequency) applied = true;
                            else if (rule.frequencyType === 'max' && dailyCount <= rule.frequency) applied = true;
                            else if (rule.frequencyType === 'exact' && dailyCount === rule.frequency) applied = true;
                        } else if (rule.scope === 'week') {
                            let weeklyCount = 0;
                            Object.values(week.days).forEach(day => {
                                ['breakfast', 'lunch', 'dinner'].forEach(mt => {
                                    const mealItems = day.meals[mt] || [];
                                    weeklyCount += countMatches();
                                });
                            });
                            console.log(`Week - (${rule.id}) ${rule.names?.join(', ') || rule.name || 'herhangi bir yemek'}, Gerekli: ${rule.frequency}, Bulunan: ${weeklyCount}, Tür: ${rule.frequencyType}`);
                            if (rule.frequencyType === 'min' && weeklyCount >= rule.frequency) applied = true;
                            else if (rule.frequencyType === 'max' && weeklyCount <= rule.frequency) applied = true;
                            else if (rule.frequencyType === 'exact' && weeklyCount === rule.frequency) applied = true;
                        }
                    } else if (rule.type === 'pairWith' && rule.pair1Name && rule.pair2Name) {
                        const hasPair1 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair1Name.toLowerCase()));
                        const hasPair2 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair2Name.toLowerCase()));
                        if (hasPair1 && hasPair2) applied = true;
                    } else if (rule.type === 'avoidPair' && rule.pair1Name && rule.pair2Name) {
                        const hasPair1 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair1Name.toLowerCase()));
                        const hasPair2 = mealItems.some(item => item.name.toLowerCase().includes(rule.pair2Name.toLowerCase()));
                        if (!(hasPair1 && hasPair2)) applied = true;
                    } else if (rule.type === 'dependOn' && rule.food && rule.requiredFood) {
                        const hasFood = mealItems.some(item => item.name.toLowerCase().includes(rule.food.toLowerCase()));
                        const hasRequired = mealItems.some(item => item.name.toLowerCase().includes(rule.requiredFood.toLowerCase()));
                        if (hasFood && hasRequired) applied = true;
                        if (!hasFood) applied = true;
                    } else if (rule.type === 'categoryLock' && rule.category === 'EKMEKLER') {
                        const breads = mealItems.filter(item =>
                            categories.find(cat => cat.name === 'EKMEKLER')?.items.some(f => f.name === item.name));
                        if (breads.length > 0) {
                            const uniqueBreads = new Set(breads.map(b => b.name));
                            if (uniqueBreads.size === 1) applied = true;
                        }
                    } else if (rule.type === 'maxRoleCount' && rule.role && rule.count !== undefined && rule.mealType === mealType) {
                        const roleCount = mealItems.filter(item => {
                            const food = availableFoods.find(f => f.name === item.name);
                            return food && food.role === rule.role;
                        }).length;
                        if (roleCount <= rule.count) applied = true;
                    }
                });
            });
        });
        if (applied) appliedRules.push(`(${rule.id}) ${rule.type}`);
        else unappliedRules.push(`(${rule.id}) ${rule.type}`);
    });

    const ruleTextElement = document.getElementById("ruleTextElement");
    if (ruleTextElement) {
        ruleTextElement.textContent = `Uygulanan kurallar: ${appliedRules.join(', ') || 'Yok'} - Uygulanmayan kurallar: ${unappliedRules.join(', ') || 'Yok'}`;
    } else {
        console.warn("ruleTextElement bulunamadı.");
    }

    showNotification(
        `Planlama tamamlandı!\nUygulanan kurallar: ${appliedRules.join(', ') || 'Yok'}\nUygulanmayan kurallar: ${unappliedRules.join(', ') || 'Yok'}`,
        'success',
        5000
    );
}
        function saveSettingsTemplate(isDefault = false) {
            const templateName = isDefault ? 'default' : (document.getElementById('settingsTemplate').value || currentPatient);
            if (!templateName) {
                showNotification("Şablon adı girin!", 'warning');
                return;
            }
            const settings = {
                minItemsPerMeal: document.getElementById('minItemsPerMeal').value,
                maxItemsPerMeal: document.getElementById('maxItemsPerMeal').value,
                lunchCalorieRatio: document.getElementById('lunchCalorieRatio').value,
                dinnerCalorieRatio: document.getElementById('dinnerCalorieRatio').value,
                calorieFlexibility: document.getElementById('calorieFlexibility').value,
                varietyScore: document.getElementById('varietyScore').value,
                carbMultiplier: document.getElementById('carbMultiplier').value,
                proteinMultiplier: document.getElementById('proteinMultiplier').value,
                fatMultiplier: document.getElementById('fatMultiplier').value,
                useName: document.getElementById('useName').checked,
                useTags: document.getElementById('useTags').checked,
                prefBreakfastDrink: document.getElementById('prefBreakfastDrink').checked,
                prefLunchEgg: document.getElementById('prefLunchEgg').checked,
                prefLunchSoup: document.getElementById('prefLunchSoup').checked,
                prefDinnerNuts: document.getElementById('prefDinnerNuts').value,
                prefDinnerSoup: document.getElementById('prefDinnerSoup').value,
                prefDinnerDessert: document.getElementById('prefDinnerDessert').value,
                prefDinnerFruit: document.getElementById('prefDinnerFruit').value,
                breakfastMin: document.getElementById('breakfastMin').value,
                breakfastMax: document.getElementById('breakfastMax').value,
                lunchMin: document.getElementById('lunchMin').value,
                lunchMax: document.getElementById('lunchMax').value,
                dinnerMin: document.getElementById('dinnerMin').value,
                dinnerMax: document.getElementById('dinnerMax').value
            };
            localStorage.setItem(`settingsTemplate_${templateName}`, JSON.stringify(settings));
            loadSettingsTemplates();
            showNotification(`Ayarlar ${isDefault ? 'varsayılan olarak' : 'hasta için'} kaydedildi!`);
        }

        function loadSettingsTemplates() {
            const templateSelect = document.getElementById('settingsTemplateSelect');
            const templates = Object.keys(localStorage).filter(key => key.startsWith('settingsTemplate_')).map(key => key.replace('settingsTemplate_', ''));
            templateSelect.innerHTML = '<option value="">Ayar Yükle</option>' + templates.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function loadSettingsTemplate() {
            const templateName = document.getElementById('settingsTemplateSelect').value;
            if (!templateName) return;
            const settings = JSON.parse(localStorage.getItem(`settingsTemplate_${templateName}`) || '{}');
            document.getElementById('minItemsPerMeal').value = settings.minItemsPerMeal || 2;
            document.getElementById('maxItemsPerMeal').value = settings.maxItemsPerMeal || 4;
            document.getElementById('lunchCalorieRatio').value = settings.lunchCalorieRatio || 40;
            document.getElementById('dinnerCalorieRatio').value = settings.dinnerCalorieRatio || 50;
            document.getElementById('calorieFlexibility').value = settings.calorieFlexibility || 10;
            document.getElementById('varietyScore').value = settings.varietyScore || 0.7;
            document.getElementById('carbMultiplier').value = settings.carbMultiplier || (dietMode === 'keto' ? 0.3 : 0.6);
            document.getElementById('proteinMultiplier').value = settings.proteinMultiplier || 0.8;
            document.getElementById('fatMultiplier').value = settings.fatMultiplier || (dietMode === 'keto' ? 1.2 : 1.0);
            document.getElementById('useName').checked = settings.useName !== false;
            document.getElementById('useTags').checked = settings.useTags !== false;
            document.getElementById('prefBreakfastDrink').checked = settings.prefBreakfastDrink !== false;
            document.getElementById('prefLunchEgg').checked = settings.prefLunchEgg !== false;
            document.getElementById('prefLunchSoup').checked = settings.prefLunchSoup !== false;
            document.getElementById('prefDinnerNuts').value = settings.prefDinnerNuts || 50;
            document.getElementById('prefDinnerSoup').value = settings.prefDinnerSoup || 50;
            document.getElementById('prefDinnerDessert').value = settings.prefDinnerDessert || 50;
            document.getElementById('prefDinnerFruit').value = settings.prefDinnerFruit || 50;
            document.getElementById('breakfastMin').value = settings.breakfastMin || 1;
            document.getElementById('breakfastMax').value = settings.breakfastMax || 1;
            document.getElementById('lunchMin').value = settings.lunchMin || 2;
            document.getElementById('lunchMax').value = settings.lunchMax || 4;
            document.getElementById('dinnerMin').value = settings.dinnerMin || 2;
            document.getElementById('dinnerMax').value = settings.dinnerMax || 4;
            calculateMacros();
            showNotification("Ayarlar yüklendi!");
        }

        function applySettings() {
            calculateMacros();
            generateAutoPlan();
            showNotification("Ayarlar uygulandı ve plan güncellendi!");
        }

        function searchEditFood(query) {
    console.log("searchEditFood çalışıyor, query:", query);
    const filterType = document.getElementById('editSearchFilterType').value;
    const editCategoriesDiv = document.getElementById('editCategories');
    editCategoriesDiv.innerHTML = `
    <div class="accordion" id="mainCategoriesAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="mainCategoriesHeading" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem;">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#mainCategoriesCollapse" aria-expanded="false" aria-controls="mainCategoriesCollapse" style="margin: 0; padding: 0.25rem 0.5rem;">
                    Kategoriler
                </button>
                <div class="d-flex align-items-center">
                    <select id="editMoveToCategory" class="form-select d-inline w-auto" style="font-size: 0.85rem; margin-right: 0.5rem;">
                        <option value="">Kategori Seç</option>
                        ${categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('')}
                    </select>
                    <button class="btn btn-primary d-inline" onclick="moveSelectedFoods()" style="font-size: 0.85rem; padding: 0.3rem 0.6rem;">Taşı</button>
                </div>
            </h2>
            <div id="mainCategoriesCollapse" class="accordion-collapse collapse" aria-labelledby="mainCategoriesHeading" data-bs-parent="#mainCategoriesAccordion">
                <div class="accordion-body" style="max-height: 400px; overflow-y: auto;">
                    ${categories.map((category, catIndex) => {
                        const filteredItems = category.items.filter(item => {
                            if (filterType === 'name') return item.name.toLowerCase().includes(query.toLowerCase());
                            if (filterType === 'tags') return item.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase()));
                            if (filterType === 'role') return item.role.toLowerCase().includes(query.toLowerCase());
                            return true;
                        });
                        return `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="editHeading${catIndex}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#editCollapse${catIndex}" aria-expanded="false" aria-controls="editCollapse${catIndex}">
                                        <input type="checkbox" class="category-checkbox" data-category-index="${catIndex}"> ${category.name} (${filteredItems.length})
                                    </button>
                                </h2>
                                <div id="editCollapse${catIndex}" class="accordion-collapse collapse" aria-labelledby="editHeading${catIndex}">
                                    <div class="accordion-body">
                                        ${filteredItems.map((item, itemIndex) => `
                                            <div class="category-item d-flex justify-content-between">
                                                <div>
                                                    <input type="checkbox" class="food-checkbox" data-category="${category.name}" data-food="${item.name}">
                                                    <span>${item.name} (${item.calories} kcal)</span>
                                                </div>
                                                <div>
                                                    <button class="btn btn-danger btn-sm me-1" onclick="deleteFood('${item.name}', '${category.name}')" title="Sil"><i class="bi bi-trash"></i></button>
                                                    <button class="btn btn-warning btn-sm" onclick="editFood('${item.name}')" title="Düzenle"><i class="bi bi-pencil"></i></button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    </div>
`;
    console.log("editCategories güncellendi, editMoveToCategory mevcut mu?:", document.getElementById('editMoveToCategory'));
}
function deleteFood(foodName, categoryName) {
    if (confirm(`${foodName} yemeğini silmek istediğinize emin misiniz?`)) {
        const category = categories.find(cat => cat.name === categoryName);
        if (category) {
            const foodIndex = category.items.findIndex(item => item.name === foodName);
            if (foodIndex !== -1) {
                category.items.splice(foodIndex, 1);
                showNotification(`${foodName} yemeği silindi!`);
                loadCategories();
                searchEditFood('');
            }
        }
    }
}
function moveSelectedFoods(attempts = 5) {
    let categoryElement = document.getElementById("editMoveToCategory");
    if (!categoryElement) {
        if (attempts > 0) {
            console.log("editMoveToCategory elementi henüz yüklenmedi! 1 saniye bekleniyor... Kalan deneme: " + attempts);
            setTimeout(() => moveSelectedFoods(attempts - 1), 1000); // 1 saniye sonra tekrar dene
        } else {
            console.error("editMoveToCategory bulunamadı, işlem iptal edildi!");
            showNotification("Kategori seçme öğesi yüklenemedi!", "danger");
        }
        return;
    }
    let targetCategory = categoryElement.value;
    if (!targetCategory) {
        showNotification("Lütfen bir kategori seçin!", "warning");
        return;
    }

    const selectedFoods = document.querySelectorAll(".food-checkbox:checked");
    if (selectedFoods.length === 0) {
        showNotification("Taşınacak yemek seçilmedi!", "warning");
        return;
    }

    selectedFoods.forEach(checkbox => {
        const foodName = checkbox.dataset.food;
        const oldCategoryName = checkbox.dataset.category;
        const oldCategory = categories.find(cat => cat.name === oldCategoryName);
        const foodIndex = oldCategory.items.findIndex(item => item.name === foodName);
        const food = oldCategory.items.splice(foodIndex, 1)[0];
        const newCategory = categories.find(cat => cat.name === targetCategory);
        newCategory.items.push(food);
    });

    showNotification(`${selectedFoods.length} yemek "${targetCategory}" kategorisine taşındı!`);
    loadCategories();
    searchEditFood('');
}

function deleteSelectedCategory() {
    const selectedCheckbox = document.querySelector('#editCategories .category-checkbox:checked');
    if (!selectedCheckbox) {
        showNotification("Lütfen bir kategori seçin!", "warning");
        return;
    }
    const index = parseInt(selectedCheckbox.getAttribute('data-category-index'));
    if (confirm(`${categories[index].name} kategorisini silmek istediğinize emin misiniz?`)) {
        categories.splice(index, 1);
        searchEditFood(''); // Sağ paneli yenile
        loadCategories(); // Sol paneli de yenile
        showNotification("Kategori silindi!");
    }
}
function editFood(foodName) {
    const food = findFood(foodName);
    if (!food) return;

    const panel = document.getElementById('editFoodPanel');
    document.getElementById('editFoodIndex').value = '';
    document.getElementById('editFoodOriginalName').value = foodName;
    document.getElementById('editFoodName').value = food.name;
    document.getElementById('editFoodCalories').value = food.calories;
    document.getElementById('editFoodProtein').value = food.protein;
    document.getElementById('editFoodCarbs').value = food.carbs;
    document.getElementById('editFoodFat').value = food.fat;
    document.getElementById('editFoodMaxQuantity').value = food.maxQuantity || 1;
    document.getElementById('editFoodMinQuantity').value = food.minQuantity || 0.5;
    document.getElementById('editFoodStep').value = food.step || 0.5;
    document.getElementById('editFoodRole').value = food.role;
    document.getElementById('editFoodTags').value = food.tags.join(', ');
    document.getElementById('editFoodMealType').value = food.mealType;
    document.getElementById('editFoodKeto').checked = food.keto;
    document.getElementById('editFoodLowCarb').checked = food.lowcarb;
    document.getElementById('editFoodFillerLunch').checked = food.fillerLunch || false;
    document.getElementById('editFoodFillerDinner').checked = food.fillerDinner || false;

    const categorySelect = document.getElementById('editFoodMoveToCategory');
    if (!categorySelect) {
        console.error("editFoodMoveToCategory elemanı bulunamadı!");
        return;
    }
    categorySelect.innerHTML = '<option value="">Kategori Seç</option>' + 
        categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
    console.log("Kategori seçenekleri yüklendi:", categorySelect.innerHTML);

    panel.style.display = 'block';
}

        const resizer = document.getElementById('resizer');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        });

        function resize(e) {
            if (!isResizing) return;
            const sidebar = document.getElementById('sidebar');
            const newWidth = e.clientX;
            if (newWidth > 150 && newWidth < 400) {
                sidebar.style.width = `${newWidth}px`;
            }
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', resize);
            document.removeEventListener('mouseup', stopResize);
        }
        function loadCategoryOptions() {
    let categorySelect = document.getElementById("editMoveToCategory");
    if (!categorySelect) {
        console.log("editMoveToCategory bulunamadı!");
        return;
    }
    console.log("Kategoriler:", categories); // categories dizisini kontrol et
    categorySelect.innerHTML = '<option value="">Kategori Seç</option>';
    categories.forEach(category => {
        let option = document.createElement("option");
        option.value = category.name;
        option.textContent = category.name;
        categorySelect.appendChild(option);
    });
    categorySelect.onchange = function() {
        console.log("Seçilen kategori: " + categorySelect.value);
    };
}

// Yemek düzenleme paneli açıldığında kategori listesini güncelle
document.getElementById("editFoodPanel").addEventListener("click", loadCategoryOptions);

function moveFoodCategory() {
    const categoryElement = document.getElementById("editFoodMoveToCategory");
    console.log("Kategori elemanı (tam obje):", categoryElement);
    if (!categoryElement) {
        console.error("Kategori seçme öğesi bulunamadı! DOM'da 'editFoodMoveToCategory' yok.");
        showNotification("Kategori seçme öğesi bulunamadı!", "warning");
        return;
    }
    const selectedValue = categoryElement.value.trim();
    console.log("Seçilen değer (ham):", categoryElement.value);
    console.log("Hedef kategori (işlenmiş):", selectedValue);
    if (!selectedValue) {
        console.log("Seçilen kategori yok, dropdown durumu:", categoryElement.innerHTML);
        showNotification("Lütfen bir kategori seçin!", "warning");
        return;
    }
    const foodName = document.getElementById("editFoodOriginalName").value;
    console.log("Taşınacak yemek:", foodName);
    const oldCategory = categories.find(cat => cat.items.some(item => item.name === foodName));
    if (!oldCategory) {
        console.error("Eski kategori bulunamadı:", foodName);
        showNotification("Eski kategori bulunamadı!", "warning");
        return;
    }
    const foodIndex = oldCategory.items.findIndex(item => item.name === foodName);
    if (foodIndex === -1) {
        console.error("Yemek bulunamadı:", foodName);
        showNotification("Yemek bulunamadı!", "warning");
        return;
    }
    const food = oldCategory.items.splice(foodIndex, 1)[0];
    const newCategory = categories.find(cat => cat.name === selectedValue);
    if (!newCategory) {
        console.error("Yeni kategori bulunamadı:", selectedValue);
        showNotification("Yeni kategori bulunamadı!", "warning");
        return;
    }
    newCategory.items.push(food);
    showNotification(`"${foodName}" yemeği "${selectedValue}" kategorisine taşındı!`);
    loadCategories();
    searchEditFood('');
    document.getElementById("editFoodPanel").style.display = "none";
}





        initializeWeeks();
        loadCategories();
        renderWeekTabs();
        renderDayTabs();
        renderMeals();
        loadPatientSelect();
        loadRules();
        loadMealTemplates();
        loadCompatibilityRules();
        loadSettingsTemplates();
        loadRuleTemplates();
        calculateMacros();
        searchEditFood('');
        document.getElementById("editFoodPanel").addEventListener("click", function(event) {
    if (event.target.tagName !== "SELECT") {
        loadCategoryOptions();
    }
});
    </script>
    <script>
        function addCurrentMealToTemplates(mealType) {
            const selectedMeals = weeks[selectedWeek - 1].days[selectedDay].meals[mealType];
            if (!selectedMeals || selectedMeals.length === 0) {
                showNotification("Bu öğünde yemek bulunmuyor!", "warning");
                return;
            }
        
            const templateName = prompt("Şablon için bir ad girin:", mealType + " şablonu");
            if (!templateName) return;
        
            const items = selectedMeals.map(meal => ({
                keyword: meal.name,
                role: meal.role || "mainDish",
                quantity: meal.quantity || 1
            }));
        
            mealTemplates.push({
                mealType,
                frequency: 1, 
                items,
                name: templateName
            });
        
            loadMealTemplates();
            showNotification("Öğün şablonlara eklendi!");
        }
        
        document.addEventListener("DOMContentLoaded", function() {
    setTimeout(() => {
        document.querySelectorAll(".meal-card .card-header").forEach(header => {
            const title = header.childNodes[0].textContent.trim().toLowerCase(); // İlk metin düğümünü al
            
            if (title.includes("öğle") || title.includes("akşam")) {
                const mealType = title.includes("öğle") ? "lunch" : "dinner";

                // Eğer buton zaten eklenmişse tekrar ekleme
                if (header.querySelector(".template-add-btn")) return;
                
                const addButton = document.createElement("button");
                addButton.className = "btn btn-primary template-add-btn";
                addButton.innerHTML = "Şablona Ekle";
                addButton.onclick = () => addCurrentMealToTemplates(mealType);
                
                header.appendChild(addButton);
            }
        });
    }, 1000); // Sayfa yüklendikten sonra butonları ekler
});

function addCurrentMealToTemplates(mealType) {
    const selectedMeals = weeks[selectedWeek - 1].days[selectedDay].meals[mealType];
    if (!selectedMeals || selectedMeals.length === 0) {
        showNotification("Bu öğünde yemek bulunmuyor!", "warning");
        return;
    }

    const templateName = prompt("Şablon için bir ad girin:", mealType + " şablonu");
    if (!templateName) return;

    const items = selectedMeals.map(meal => ({
        keyword: meal.name,
        role: meal.role || "mainDish",
        quantity: meal.quantity || 1
    }));

    mealTemplates.push({
        mealType,
        frequency: 1, 
        items,
        name: templateName
    });

    loadMealTemplates();
    showNotification("Öğün şablonlara eklendi!");
}
        </script>

<script>
    function formatQuantityWithText(text) {
        // "0.5" veya "0.25" miktarlarını doğru şekilde değiştirme
        return text.replace(/\b(0.5|0.25)\b\s*(dilim|kase|bardak|yemek|porsiyon|adet|tatlı kaşığı|çorba kaşığı|tabak|fincan|yemek kaşığı)/gi, function(match, quantity, unit) {
            if (quantity === '0.5') return `yarım ${unit}`;
            if (quantity === '0.25') return `çeyrek ${unit}`;
            return match;
        });
    }

    function updateQuantities() {
        const quantityCells = document.querySelectorAll('.quantity-cell'); // Miktar hücrelerinin sınıfı
        quantityCells.forEach(cell => {
            const text = cell.innerText.trim();
            const formattedText = formatQuantityWithText(text);
            if (formattedText !== text) {
                cell.innerText = formattedText;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', updateQuantities);

    document.getElementById('freqCatCheck').addEventListener('change', function() {
    const freqCat = document.getElementById('freqCat');
    freqCat.disabled = !this.checked;
    if (this.checked && freqCat.options.length <= 1) { // Eğer boşsa
        populateCategoryDropdown(); // Tekrar doldur
    }
    console.log("freqCatCheck değişti, freqCat içeriği:", freqCat.innerHTML);
});
</script>


<script>
    function convertMeasurements(text) {
        // "0.5 yemek kaşığı" veya "yarım yemek kaşığı" -> "1 tatlı kaşığı"
        text = text.replace(/\b0\.5\s*yemek kaşığı\b/gi, "1 tatlı kaşığı");
        text = text.replace(/\byarım yemek kaşığı\b/gi, "1 tatlı kaşığı");
        
        // "2 tatlı kaşığı" -> "1 yemek kaşığı"
        text = text.replace(/\b2\s*tatlı kaşığı\b/gi, "1 yemek kaşığı");
        
        // "0.25 yemek kaşığı" -> "çeyrek yemek kaşığı"
        text = text.replace(/\b0\.25\s*yemek kaşığı\b/gi, "çeyrek yemek kaşığı");
        
        return text;
    }

    function applyConversions() {
        const rows = document.querySelectorAll('#mealTable td');
        rows.forEach(cell => {
            const originalText = cell.innerText.trim();
            const convertedText = convertMeasurements(originalText);

            if (originalText !== convertedText) {
                cell.innerText = convertedText;
            }
        });
    }
    function updateSidebar() {
    const sidebarContent = document.getElementById('categories'); // 'categories' ID’sini kullanıyoruz
    if (!sidebarContent) {
        console.error("categories elementi bulunamadı!");
        return;
    }
    sidebarContent.innerHTML = '';
    categories.forEach((category, index) => {
        const itemCount = category.items.length;
        const accordionItem = `
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading${index}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}" aria-expanded="false" aria-controls="collapse${index}">
                        ${category.name} (${itemCount})
                    </button>
                </h2>
                <div id="collapse${index}" class="accordion-collapse collapse" aria-labelledby="heading${index}">
                    <div class="accordion-body">
                        ${category.items.map(food => `
                            <div class="category-item">
                                <span>${food.name} (${food.calories} kcal)</span>
                                <div class="food-checkboxes">
                                    <input type="checkbox" class="meal-checkbox" data-name="${food.name}" data-meal="breakfast" title="Sabah"> S
                                    <input type="checkbox" class="meal-checkbox" data-name="${food.name}" data-meal="lunch" title="Öğle"> Ö
                                    <input type="checkbox" class="meal-checkbox" data-name="${food.name}" data-meal="dinner" title="Akşam"> A
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        sidebarContent.innerHTML += accordionItem;
    });
    console.log("Sidebar güncellendi!");
}

    document.addEventListener('DOMContentLoaded', applyConversions);



        // GitHub'dan JSON dosyasını otomatik yükleme fonksiyonu
        function loadJSONFromGitHub() {
            const githubURL = "https://raw.githubusercontent.com/mustafasacar35/beslenme/main/sistem_JSON.json"; // Token'sız raw link
            fetch(githubURL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("JSON dosyası yüklenemedi! Hata kodu: " + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // JSON verisini mevcut sisteme entegre et
                    localStorage.setItem("foodList", JSON.stringify(data)); // Veriyi localStorage'a kaydet
                    loadCategories(); // Kategorileri güncelle
                    showNotification("GitHub'dan sistem_JSON.json başarıyla yüklendi!", "success");
                })
                .catch(error => {
                    console.error("Hata:", error);
                    showNotification("JSON dosyası yüklenirken bir hata oluştu!", "warning");
                });
        }

        // Sayfa yüklendiğinde otomatik çalıştır
        document.addEventListener("DOMContentLoaded", function() {
            loadJSONFromGitHub(); // JSON'ı otomatik yükle
            // Mevcut diğer başlangıç fonksiyonlarınızı burada tutabilirsiniz
            initializeWeeks();
            loadCategories();
            renderWeekTabs();
            renderDayTabs();
            renderMeals();
            loadPatientSelect();
            loadRules();
            loadMealTemplates();
            loadCompatibilityRules();
            loadSettingsTemplates();
            loadRuleTemplates();
            calculateMacros();
            searchEditFood('');
        });


</script>
<!-- Günlük ve Haftalık için Popup -->
<div id="macroModal" class="macro-modal">
    <div class="macro-modal-content">
        <span class="macro-modal-close">×</span>
        <div class="macro-modal-body">
            <div class="macro-modal-chart">
                <h3 id="macroModalTitle"></h3>
                <canvas id="macroModalChart" width="300" height="300"></canvas>
            </div>
            <div class="macro-modal-analysis" id="macroModalAnalysis"></div>
        </div>
    </div>
</div>
</body>
</html>